<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>رفيق رمضان | رحلة روحانية</title>

    <!-- Preload critical fonts to avoid FOUT -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&family=Reem+Kufi:wght@500;700&family=Alexandria:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['IBM Plex Sans Arabic','sans-serif'],
                        alexandria: ['Alexandria','sans-serif'],
                        kufi: ['Reem Kufi','sans-serif'],
                        amiri: ['Amiri','serif'],
                    },
                    animation: {
                        'swing-1': 'swing 4s ease-in-out infinite alternate',
                        'swing-2': 'swing 5s ease-in-out infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slow-glow': 'slowGlow 5s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards',
                    },
                    keyframes: {
                        swing: { '0%':{ transform:'rotate(-4deg)' }, '100%':{ transform:'rotate(4deg)' } },
                        float: { '0%,100%':{ transform:'translateY(0)' }, '50%':{ transform:'translateY(-10px)' } },
                        fadeIn: { '0%':{ opacity:'0', transform:'translateY(6px)' }, '100%':{ opacity:'1', transform:'translateY(0)' } },
                        slowGlow: { '0%,100%':{ opacity:'0.4' }, '50%':{ opacity:'0.75' } },
                        pop: { '0%':{ transform:'scale(0.88)' }, '60%':{ transform:'scale(1.07)' }, '100%':{ transform:'scale(1)' } },
                    }
                }
            }
        }
    </script>

    <style>
        /* ── Base reset ── */
        *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Reserve space to prevent CLS */
            min-height: 100dvh;
        }

        /* ── Themes ── */
        .theme-male {
            background-color: #0c0804;
            background-image: radial-gradient(ellipse 80% 40% at 50% 0%, rgba(251,191,36,0.08) 0%, transparent 65%);
            font-family: 'IBM Plex Sans Arabic', sans-serif;
        }
        .theme-female {
            background-color: #100620;
            background-image: radial-gradient(ellipse 80% 40% at 50% 0%, rgba(240,171,252,0.08) 0%, transparent 65%);
            font-family: 'Alexandria', sans-serif;
        }

        /* ── Glass panels — GPU composited (no layout) ── */
        .glass-panel {
            background: rgba(18,12,6,0.78);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(251,191,36,0.13);
            box-shadow: 0 6px 28px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.04);
            will-change: auto; /* don't promote unless animating */
        }
        .glass-card {
            background: rgba(25,8,45,0.72);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(240,171,252,0.13);
            box-shadow: 0 6px 28px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.04);
        }

        /* ── Prayer button done states (no !important wars — use specificity) ── */
        .prayer-btn {
            padding: 11px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            min-width: 64px;
            min-height: 44px; /* touch target */
            text-align: center;
            transition: transform .15s ease, box-shadow .15s ease;
            cursor: pointer;
            user-select: none;
            border: 1.5px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.32);
            background: rgba(0,0,0,0.28);
            /* GPU layer only on active */
        }
        .prayer-btn:active { transform: scale(0.88) !important; }

        .btn-fard-done {
            background: linear-gradient(135deg,#f59e0b,#d97706);
            color: #000;
            font-weight: 800;
            border: none;
            box-shadow: 0 3px 14px rgba(245,158,11,0.5);
        }
        .btn-sunnah-done {
            background: linear-gradient(135deg,#16a34a,#15803d);
            color: #fff;
            font-weight: 700;
            border: none;
            box-shadow: 0 3px 12px rgba(22,163,74,0.45);
        }
        .btn-fard-done-f {
            background: linear-gradient(135deg,#d946ef,#a21caf);
            color: #fff;
            font-weight: 800;
            border: none;
            box-shadow: 0 3px 14px rgba(217,70,239,0.45);
        }
        .btn-sunnah-done-f {
            background: linear-gradient(135deg,#16a34a,#15803d);
            color: #fff;
            font-weight: 700;
            border: none;
            box-shadow: 0 3px 12px rgba(22,163,74,0.45);
        }

        /* ── Habit states ── */
        .habit-active-m {
            background: linear-gradient(135deg,rgba(251,191,36,0.11),rgba(251,191,36,0.02));
            border-color: rgba(251,191,36,0.5);
        }
        .habit-active-f {
            background: linear-gradient(135deg,rgba(240,171,252,0.11),rgba(240,171,252,0.02));
            border-color: rgba(240,171,252,0.5);
        }

        /* ── Prayer row ── */
        .prayer-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 13px 14px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.22);
            transition: background .25s ease, border-color .25s ease;
        }
        .prayer-row.row-done-m { background: rgba(251,191,36,0.05); border-color: rgba(251,191,36,0.18); }
        .prayer-row.row-done-f { background: rgba(240,171,252,0.05); border-color: rgba(240,171,252,0.18); }

        /* ── Night prayer cards ── */
        .taraweeh-qiyam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .night-prayer-card {
            padding: 14px 10px;
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 7px;
            cursor: pointer;
            transition: background .2s ease, border-color .2s ease;
            user-select: none;
            text-align: center;
        }
        .night-prayer-card:active { transform: scale(0.95); }

        /* ── Performance cards ── */
        .perf-stat-card {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 13px 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .perf-stat-val {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Amiri', serif;
            line-height: 1.1;
        }
        .perf-bar-wrap {
            height: 5px;
            background: rgba(255,255,255,0.07);
            border-radius: 99px;
            overflow: hidden;
            margin-top: 7px;
        }
        .perf-bar-fill {
            height: 100%;
            border-radius: 99px;
            /* Use transform instead of width for GPU perf — but we need width for initial paint; this is acceptable */
            transition: width 1s cubic-bezier(0.4,0,0.2,1);
        }

        /* ── Progress ring ── */
        .progress-ring circle { transition: stroke-dashoffset 2s cubic-bezier(0.4,0,0.2,1); }

        /* ── Azkar ── */
        .azkar-tab-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 12px;
            font-family: 'Reem Kufi', sans-serif;
            font-size: 13px;
            font-weight: 700;
            transition: background .25s ease, color .25s ease, box-shadow .25s ease;
            cursor: pointer;
            color: rgba(255,255,255,0.38);
            background: transparent;
            border: none;
            min-height: 44px;
        }
        .azkar-tab-btn.active-m { background: linear-gradient(135deg,#f59e0b,#d97706); color: #000; box-shadow: 0 3px 14px rgba(245,158,11,0.3); }
        .azkar-tab-btn.active-f { background: linear-gradient(135deg,#d946ef,#7c3aed); color: #fff; box-shadow: 0 3px 14px rgba(217,70,239,0.3); }

        .azkar-item {
            background: rgba(0,0,0,0.26);
            border: 1px solid rgba(255,255,255,0.055);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 10px;
            transition: background .2s ease, border-color .2s ease;
        }

        /* ── Quran page input ── */
        .quran-page-input-wrap {
            background: rgba(0,0,0,0.36);
            border-radius: 18px;
            padding: 14px;
            border: 1px solid rgba(255,255,255,0.07);
        }
        .juz-grid {
            display: grid;
            grid-template-columns: repeat(6,1fr);
            gap: 6px;
        }
        @media (max-width: 360px) { .juz-grid { grid-template-columns: repeat(5,1fr); } }
        .juz-btn {
            aspect-ratio: 1;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            background: rgba(255,255,255,0.07);
            color: rgba(255,255,255,0.5);
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: background .15s, color .15s;
            min-height: 40px;
        }
        .juz-btn.done-m { background: rgba(251,191,36,0.2); color: #fbbf24; border-color: rgba(251,191,36,0.4); }
        .juz-btn.done-f { background: rgba(217,70,239,0.18); color: #f0abfc; border-color: rgba(217,70,239,0.4); }

        /* ── Spinners removed ── */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        /* ── Toast ── */
        #toast {
            position: fixed; bottom: 108px; left: 50%;
            transform: translateX(-50%) translateY(16px);
            z-index: 10000; opacity: 0;
            transition: opacity .35s ease, transform .35s cubic-bezier(0.34,1.56,0.64,1);
            pointer-events: none;
            white-space: nowrap;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ── Dhikr bar ── */
        .dhikr-float {
            background: rgba(10,6,2,0.9);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(251,191,36,0.22);
            box-shadow: 0 6px 20px rgba(0,0,0,0.55);
        }
        .theme-female .dhikr-float {
            background: rgba(14,5,24,0.9);
            border-color: rgba(240,171,252,0.22);
        }
        /* Dhikr slide transition — GPU composited (opacity + transform only) */
        #dhikrText {
            display: block;
            will-change: opacity, transform;
        }

        /* ── Sticky save ── */
        .sticky-save {
            position: fixed;
            bottom: 88px;
            left: 50%;
            transform: translateX(-50%) translateY(14px);
            z-index: 45;
            transition: opacity .35s ease, transform .35s cubic-bezier(0.34,1.56,0.64,1);
            opacity: 0;
            pointer-events: none;
            will-change: opacity, transform;
        }
        .sticky-save.visible { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }

        /* ── Unsaved dot ── */
        .unsaved-dot {
            width: 7px; height: 7px;
            background: #f87171;
            border-radius: 50%;
            display: inline-block;
            margin-inline-end: 5px;
            box-shadow: 0 0 7px rgba(248,113,113,0.8);
            animation: blink 1.4s ease-in-out infinite;
        }
        @keyframes blink { 0%,100%{ opacity:1 } 50%{ opacity:0.25 } }

        /* ── Lanterns ── */
        .lantern-svg {
            position: absolute; top: -4px;
            width: 42px; height: 96px; z-index: 40;
            filter: drop-shadow(0 0 10px rgba(251,191,36,0.45));
            opacity: 0.8;
        }

        /* ── Canvas stars ── */
        #starCanvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; }

        /* ── Crescent ── */
        .crescent-moon {
            position: fixed; top: 66px; left: 16px; z-index: 2; pointer-events: none;
            animation: moonFloat 8s ease-in-out infinite;
            filter: drop-shadow(0 0 16px rgba(251,191,36,0.55)) drop-shadow(0 0 44px rgba(251,191,36,0.18));
            will-change: transform;
        }
        .theme-female .crescent-moon {
            filter: drop-shadow(0 0 16px rgba(240,171,252,0.45)) drop-shadow(0 0 36px rgba(240,171,252,0.13));
        }
        @keyframes moonFloat { 0%,100%{ transform:translateY(0) rotate(-5deg) } 50%{ transform:translateY(-9px) rotate(0deg) } }

        /* ── Kaaba ── */
        .kaaba-scene {
            position: fixed; bottom: 72px; left: 0; right: 0;
            z-index: 1; pointer-events: none; opacity: 0.07;
        }
        .theme-female .kaaba-scene { opacity: 0.048; }

        /* ── Sparkles — use will-change only on animated elements ── */
        .sparkle-star {
            position: fixed; pointer-events: none; z-index: 2;
            color: #fbbf24; font-size: 10px;
            animation: twinkle ease-in-out infinite;
            will-change: opacity, transform;
        }
        .theme-female .sparkle-star { color: #f0abfc; }
        @keyframes twinkle { 0%,100%{ opacity:0.07; transform:scale(0.7) } 50%{ opacity:1; transform:scale(1.3) } }

        /* ── Shooting star ── */
        .shooting-star {
            position: fixed; pointer-events: none; z-index: 3;
            width: 1px; height: 1px; background: #fff; border-radius: 50%;
            opacity: 0; animation: shoot linear forwards;
            will-change: opacity, transform;
        }
        @keyframes shoot {
            0%{ opacity:0 } 2%{ opacity:1 }
            100%{ opacity:0; transform:translate(-280px,160px) scaleX(80) }
        }

        /* ── Orb ── */
        .bg-orb {
            position: fixed; border-radius: 50%;
            filter: blur(90px); pointer-events: none; z-index: 0;
            animation: orbPulse 12s ease-in-out infinite;
            will-change: opacity, transform;
        }
        @keyframes orbPulse { 0%,100%{ opacity:0.08; transform:scale(1) } 50%{ opacity:0.18; transform:scale(1.1) } }

        /* ── App container ── */
        #app-container { position: relative; z-index: 10; }

        /* ── Loading screen ── */
        #loadingScreen { background: #0a0604; }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width: 2px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(251,191,36,0.18); border-radius: 99px; }

        /* ── Welcome card ── */
        .selected-male  { border-color: rgba(251,191,36,0.8) !important; box-shadow: 0 0 18px rgba(251,191,36,0.18); }
        .selected-female{ border-color: rgba(217,70,239,0.8)  !important; box-shadow: 0 0 18px rgba(217,70,239,0.18); }

        /* ── Touch targets — minimum 44×44 ── */
        .nav-item { min-width: 52px; min-height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; }
        button { min-height: 36px; }

        /* ── Responsive text clamp ── */
        .text-fluid-xl { font-size: clamp(1.1rem, 4vw, 1.25rem); }
        .text-fluid-2xl { font-size: clamp(1.3rem, 5vw, 1.5rem); }

        /* ── Sunnah check ── */
        .sunnah-check { display: inline-flex; align-items: center; gap: 3px; }

        /* Ensure no horizontal overflow */
        .max-w-lg { max-width: min(32rem, 100vw); }
    </style>
</head>
<body>

<!-- CANVAS STARS -->
<canvas id="starCanvas"></canvas>

<!-- BG ORBS — minimal, GPU composited -->
<div class="bg-orb" style="width:300px;height:300px;top:-80px;right:-60px;background:rgba(251,191,36,0.06);"></div>
<div class="bg-orb" style="width:250px;height:250px;bottom:20%;left:-80px;background:rgba(251,191,36,0.04);animation-delay:5s;"></div>

<!-- SPARKLE STARS -->
<div class="sparkle-star" style="top:11%;left:14%;animation-duration:3.1s;font-size:8px;">✦</div>
<div class="sparkle-star" style="top:17%;right:19%;animation-duration:2.4s;font-size:6px;animation-delay:1s;">✦</div>
<div class="sparkle-star" style="top:7%;left:39%;animation-duration:4s;font-size:5px;animation-delay:.5s;">★</div>
<div class="sparkle-star" style="top:21%;left:59%;animation-duration:2.8s;font-size:7px;animation-delay:1.8s;">✦</div>
<div class="sparkle-star" style="top:5%;right:34%;animation-duration:3.5s;font-size:9px;animation-delay:.3s;">✧</div>
<div class="sparkle-star" style="top:14%;right:7%;animation-duration:2s;font-size:5px;animation-delay:2.2s;">✦</div>

<!-- CRESCENT MOON -->
<div class="crescent-moon">
    <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
        <path d="M32 19C32 26.18 26.18 32 19 32C14.2 32 10.08 29.3 7.8 25.3C9.3 25.76 10.9 26 12.5 26C20.5 26 27 19.5 27 11.5C27 9.9 26.76 8.3 26.3 6.8C29.86 9.08 32 13.8 32 19Z" fill="#fbbf24" opacity="0.9"/>
        <circle cx="27" cy="11" r="1.2" fill="#fde68a" opacity="0.6"/>
    </svg>
</div>

<!-- KAABA SILHOUETTE -->
<div class="kaaba-scene" aria-hidden="true">
    <svg width="100%" viewBox="0 0 800 220" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMax meet">
        <path d="M0 180 Q100 120 200 150 Q300 100 400 130 Q500 90 600 140 Q700 110 800 150 L800 220 L0 220 Z" fill="white" opacity="0.3"/>
        <rect x="0" y="200" width="800" height="20" fill="white" opacity="0.4"/>
        <rect x="100" y="60" width="14" height="140" fill="white"/><polygon points="107,40 100,65 114,65" fill="white"/><rect x="104" y="38" width="6" height="8" fill="white"/>
        <rect x="240" y="80" width="12" height="120" fill="white"/><polygon points="246,62 240,82 252,82" fill="white"/><rect x="243" y="60" width="6" height="8" fill="white"/>
        <rect x="548" y="80" width="12" height="120" fill="white"/><polygon points="554,62 548,82 560,82" fill="white"/><rect x="551" y="60" width="6" height="8" fill="white"/>
        <rect x="686" y="60" width="14" height="140" fill="white"/><polygon points="693,40 686,65 700,65" fill="white"/><rect x="690" y="38" width="6" height="8" fill="white"/>
        <rect x="330" y="100" width="140" height="110" fill="white"/>
        <rect x="330" y="100" width="140" height="18" fill="white" opacity="0.6"/>
        <rect x="385" y="148" width="30" height="62" fill="white" opacity="0.4"/>
        <ellipse cx="400" cy="98" rx="30" ry="12" fill="white" opacity="0.5"/>
        <rect x="170" y="155" width="460" height="55" fill="white" opacity="0.5"/>
    </svg>
</div>

<!-- GROUND MIST -->
<div class="fixed bottom-0 left-0 right-0 h-20 pointer-events-none z-[1]" style="background:linear-gradient(to top,rgba(0,0,0,0.45) 0%,transparent 100%);"></div>

<!-- LANTERNS -->
<div class="fixed top-0 left-0 w-full h-28 pointer-events-none z-[65]" aria-hidden="true">
    <div class="lantern-svg animate-swing-1" style="left:7%"><svg viewBox="0 0 50 100"><path d="M25 0 L25 25 M15 25 L35 25 L40 55 L25 75 L10 55 Z" fill="rgba(251,191,36,0.1)" stroke="#fbbf24" stroke-width="1.5"/><circle cx="25" cy="50" r="4" fill="#fbbf24" class="animate-pulse"/></svg></div>
    <div class="lantern-svg animate-swing-2 hidden md:block" style="left:34%"><svg viewBox="0 0 50 100"><path d="M25 0 L25 40 M10 40 L40 40 L45 70 L25 90 L5 70 Z" fill="rgba(251,191,36,0.1)" stroke="#fbbf24" stroke-width="2"/><circle cx="25" cy="65" r="3" fill="#fbbf24" class="animate-pulse"/></svg></div>
    <div class="lantern-svg animate-swing-1 hidden md:block" style="right:34%"><svg viewBox="0 0 50 100"><path d="M25 0 L25 40 M10 40 L40 40 L45 70 L25 90 L5 70 Z" fill="rgba(251,191,36,0.1)" stroke="#fbbf24" stroke-width="2"/><circle cx="25" cy="65" r="3" fill="#fbbf24" class="animate-pulse"/></svg></div>
    <div class="lantern-svg animate-swing-2" style="right:7%"><svg viewBox="0 0 50 100"><path d="M25 0 L25 25 M15 25 L35 25 L40 55 L25 75 L10 55 Z" fill="rgba(251,191,36,0.1)" stroke="#fbbf24" stroke-width="2"/><circle cx="25" cy="50" r="4" fill="#fbbf24" class="animate-pulse"/></svg></div>
</div>

<!-- LOADING SCREEN -->
<div id="loadingScreen" class="fixed inset-0 z-[200] flex flex-col items-center justify-center transition-opacity duration-600">
    <div class="w-14 h-14 border-4 border-zinc-900 border-t-amber-500 rounded-full animate-spin mb-5 shadow-[0_0_18px_rgba(251,191,36,0.28)]"></div>
    <p class="text-amber-500/75 text-base font-amiri tracking-widest">سكونُ الطاعة..</p>
</div>

<!-- WELCOME SCREEN -->
<div id="welcomeScreen" class="fixed inset-0 z-[100] flex-col items-center justify-center p-4 hidden overflow-y-auto"
     style="display:none;background:radial-gradient(ellipse at 50% 15%,rgba(251,191,36,0.1) 0%,#0a0604 60%);">
    <div class="relative z-10 w-full max-w-sm mx-auto text-center py-6">
        <div class="relative inline-flex items-center justify-center mb-5">
            <div class="absolute w-32 h-32 bg-amber-400/12 blur-2xl rounded-full"></div>
            <div class="w-24 h-24 rounded-full bg-gradient-to-b from-[#2a1d08] to-[#0f0a04] border-2 border-amber-500/45 flex items-center justify-center shadow-[0_0_44px_rgba(251,191,36,0.28)] relative z-10 animate-float">
                <svg width="54" height="50" viewBox="0 0 60 56" fill="none">
                    <rect x="8" y="18" width="44" height="34" rx="1" fill="#fbbf24" opacity="0.9"/>
                    <rect x="8" y="18" width="44" height="8" fill="#f59e0b" opacity="0.7"/>
                    <rect x="8" y="22" width="44" height="2" fill="#fde68a" opacity="0.5"/>
                    <rect x="23" y="36" width="14" height="16" rx="1" fill="#92400e" opacity="0.8"/>
                    <polygon points="8,18 30,4 52,18" fill="#d97706" opacity="0.95"/>
                    <rect x="27" y="0" width="6" height="6" rx="1" fill="#fbbf24"/>
                </svg>
            </div>
        </div>
        <h1 class="text-5xl font-amiri font-bold text-white mb-1.5 leading-tight">رفيقُ رمضان</h1>
        <p class="text-amber-400/65 text-sm font-kufi mb-7 tracking-wide">أهلاً بك في رحلتك الروحانية · ١٤٤٦هـ</p>
        <div class="bg-[#110d06]/92 backdrop-blur-xl border border-amber-500/18 rounded-[1.75rem] p-5 space-y-5 shadow-[0_18px_54px_rgba(0,0,0,0.65)]">
            <div class="space-y-1.5 text-right">
                <label class="text-xs text-amber-500/75 font-bold font-kufi tracking-wider">اسمُك الكريم</label>
                <div class="relative">
                    <input type="text" id="setupName" placeholder="كيف نُناديك؟"
                        class="w-full bg-[#0a0604] border border-amber-500/22 rounded-2xl px-4 py-3.5 text-white text-center focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-400/18 transition-all font-bold text-lg font-amiri placeholder-zinc-700"
                        onkeydown="if(event.key==='Enter') window.finishSetup()">
                    <div class="absolute left-3.5 top-1/2 -translate-y-1/2 w-1.5 h-1.5 bg-amber-500 rounded-full opacity-50 animate-pulse"></div>
                </div>
            </div>
            <div class="space-y-2.5 text-right">
                <label class="text-xs text-amber-500/75 font-bold font-kufi tracking-wider">اختَر واجهتك</label>
                <div class="grid grid-cols-2 gap-3">
                    <div onclick="window.selectSetupTheme('male')" id="themeMale" class="setup-theme-card cursor-pointer rounded-2xl p-4 flex flex-col items-center gap-2.5 border-2 border-amber-500/35 bg-gradient-to-b from-[#1a120b] to-[#0a0604] transition-all active:scale-95 selected-male">
                        <div class="w-12 h-12 rounded-2xl bg-amber-500/12 flex items-center justify-center border border-amber-500/28">
                            <svg width="28" height="28" viewBox="0 0 30 30" fill="none"><circle cx="15" cy="8" r="5" fill="#fbbf24" opacity="0.9"/><path d="M6 26c0-5 4-9 9-9s9 4 9 9" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" fill="none" opacity="0.9"/><rect x="11" y="16" width="8" height="6" rx="2" fill="#fbbf24" opacity="0.7"/></svg>
                        </div>
                        <div><span class="text-sm font-bold font-kufi text-white block">رجالي</span><span class="text-xs text-amber-400/50 font-amiri">ذهبي</span></div>
                    </div>
                    <div onclick="window.selectSetupTheme('female')" id="themeFemale" class="setup-theme-card cursor-pointer rounded-2xl p-4 flex flex-col items-center gap-2.5 border-2 border-fuchsia-500/22 bg-gradient-to-b from-[#150824] to-[#0a0604] transition-all active:scale-95">
                        <div class="w-12 h-12 rounded-2xl bg-fuchsia-500/12 flex items-center justify-center border border-fuchsia-500/28">
                            <svg width="28" height="28" viewBox="0 0 30 30" fill="none"><circle cx="15" cy="8" r="4.5" fill="#f0abfc" opacity="0.9"/><path d="M8 14 Q8 8 15 7 Q22 8 22 14 Q22 18 15 19 Q8 18 8 14Z" fill="#d946ef" opacity="0.7"/><path d="M7 26c0-5 4-8 8-8s8 3 8 8" stroke="#f0abfc" stroke-width="2.5" stroke-linecap="round" fill="none" opacity="0.9"/></svg>
                        </div>
                        <div><span class="text-sm font-bold font-kufi text-white block">بناتي</span><span class="text-xs text-fuchsia-400/50 font-amiri">وردي</span></div>
                    </div>
                </div>
            </div>
            <button onclick="window.finishSetup()" class="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-black font-extrabold font-kufi py-3.5 rounded-2xl shadow-[0_0_22px_rgba(251,191,36,0.4)] transition-all active:scale-95 text-lg border-b-4 border-amber-700 mt-1">
                ابدأ الرحلةَ المباركة ✨
            </button>
        </div>
        <p class="text-white/18 text-xs font-amiri mt-5">رَمَضَانُ شَهْرُ الْقُرْآن</p>
    </div>
</div>

<!-- DHIKR BAR -->
<div class="fixed z-[70] pointer-events-none" style="top:10px;left:58px;right:58px;">
    <div id="dhikrOverlay" class="dhikr-float mx-auto max-w-md rounded-2xl px-4 py-3 flex items-center gap-3 relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/3 to-transparent animate-slow-glow pointer-events-none"></div>
        <i class="fas fa-star-and-crescent text-amber-400/65 text-base animate-pulse relative z-10 flex-shrink-0"></i>
        <span id="dhikrText" class="text-lg font-bold font-amiri text-white leading-snug flex-1 text-center relative z-10">لَا إِلَهَ إِلَّا اللَّه</span>
        <i class="fas fa-star text-amber-400/65 text-sm animate-pulse relative z-10 flex-shrink-0"></i>
    </div>
</div>

<!-- TOAST -->
<div id="toast" class="bg-[#1a120b]/96 backdrop-blur-xl text-amber-300 px-6 py-3.5 rounded-2xl shadow-[0_8px_28px_rgba(0,0,0,0.75)] border border-amber-500/28 font-bold text-base font-kufi text-center"></div>

<!-- STICKY SAVE -->
<div id="stickySave" class="sticky-save">
    <button onclick="window.saveData()" class="flex items-center gap-2 px-7 py-3 rounded-2xl font-bold font-kufi text-base shadow-2xl backdrop-blur-xl transition-all active:scale-95" id="stickySaveBtn">
        <span class="unsaved-dot"></span>
        <span>حفظ التغييرات</span>
    </button>
</div>

<!-- APP CONTAINER -->
<div id="app-container" class="hidden opacity-0 transition-opacity duration-500 min-h-dvh" style="padding-top:76px;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBtHvklnxlP7ZgTvwJrpgMz4cbWiuhq9TM",
        authDomain: "create-project-36d4c.firebaseapp.com",
        projectId: "create-project-36d4c",
        storageBucket: "create-project-36d4c.firebasestorage.app",
        messagingSenderId: "384696044918",
        appId: "1:384696044918:web:f78daf55009be623b1fe57"
    };
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);

    const PRAYERS_CONFIG = {
        fajr:    { label:'الفجر',   fard:true,  sunnah:true  },
        duha:    { label:'الضحى',   fard:false, sunnah:true  },
        dhuhr:   { label:'الظهر',   fard:true,  sunnah:true  },
        asr:     { label:'العصر',   fard:true,  sunnah:false },
        maghrib: { label:'المغرب',  fard:true,  sunnah:true  },
        isha:    { label:'العشاء',  fard:true,  sunnah:true  },
    };
    const PRAYER_ICONS = {
        fajr:'fa-moon', duha:'fa-sun', dhuhr:'fa-circle-dot',
        asr:'fa-sun', maghrib:'fa-cloud', isha:'fa-star-and-crescent',
    };

    const DHIKR_LIST = [
        "صَلِّ عَلَى مُحَمَّدٍ ﷺ",
        "لَا إِلَهَ إِلَّا اللَّه",
        "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ",
        "أَسْتَغْفِرُ اللَّهَ الْعَظِيم",
        "لَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللَّه",
        "اللَّهُمَّ إِنَّكَ عَفُوٌّ تُحِبُّ الْعَفْوَ فَاعْفُ عَنَّا",
        "اللَّهُمَّ بَلِّغْنَا لَيْلَةَ الْقَدْر",
    ];

    /* ══ AZKAR DATA ══ */
    const AZKAR_SABAH = [
        { text:"أَعُوذُ بِاللَّهِ السَّمِيعِ الْعَلِيمِ مِنَ الشَّيْطَانِ الرَّجِيمِ", count:3, label:"3 مرات", src:"افتتاح" },
        { text:"اللَّهُمَّ بِكَ أَصْبَحْنَا وَبِكَ أَمْسَيْنَا وَبِكَ نَحْيَا وَبِكَ نَمُوتُ وَإِلَيْكَ النُّشُورُ", count:1, label:"مرة واحدة", src:"أبو داود" },
        { text:"اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ", count:1, label:"سيد الاستغفار", src:"البخاري" },
        { text:"اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لَا إِلَهَ إِلَّا أَنْتَ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، وَأَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلَهَ إِلَّا أَنْتَ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"رَضِيتُ بِاللَّهِ رَبًّا وَبِالْإِسْلَامِ دِينًا وَبِمُحَمَّدٍ ﷺ نَبِيًّا", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"اللَّهُمَّ إِنِّي أَسْأَلُكَ عِلْمًا نَافِعًا وَرِزْقًا طَيِّبًا وَعَمَلًا مُتَقَبَّلًا", count:1, label:"مرة واحدة", src:"ابن ماجه" },
        { text:"سُبْحَانَ اللَّهِ وَبِحَمْدِهِ", count:100, label:"100 مرة", src:"مسلم" },
        { text:"لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ", count:10, label:"10 مرات", src:"مسلم" },
        { text:"سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، عَدَدَ خَلْقِهِ وَرِضَا نَفْسِهِ وَزِنَةَ عَرْشِهِ وَمِدَادَ كَلِمَاتِهِ", count:3, label:"3 مرات", src:"مسلم" },
        { text:"اللَّهُمَّ صَلِّ وَسَلِّمْ وَبَارِكْ عَلَى نَبِيِّنَا مُحَمَّدٍ ﷺ", count:10, label:"10 مرات", src:"السنة النبوية" },
        { text:"أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ", count:3, label:"3 مرات", src:"مسلم" },
        { text:"اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْهَمِّ وَالْحَزَنِ، وَأَعُوذُ بِكَ مِنَ الْعَجْزِ وَالْكَسَلِ، وَأَعُوذُ بِكَ مِنَ الْجُبْنِ وَالْبُخْلِ، وَأَعُوذُ بِكَ مِنْ غَلَبَةِ الدَّيْنِ وَقَهْرِ الرِّجَالِ", count:1, label:"مرة واحدة", src:"البخاري" },
        { text:"حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ", count:7, label:"7 مرات", src:"أبو داود" },
        { text:"بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ هُوَ اللَّهُ أَحَدٌ، اللَّهُ الصَّمَدُ، لَمْ يَلِدْ وَلَمْ يُولَدْ، وَلَمْ يَكُنْ لَهُ كُفُوًا أَحَدٌ﴾", count:3, label:"3 مرات · الإخلاص", src:"أبو داود" },
        { text:"بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ…﴾ وَ ﴿قُلْ أَعُوذُ بِرَبِّ النَّاسِ…﴾", count:3, label:"3 مرات · المعوذتان", src:"أبو داود" },
        { text:"آيَةُ الْكُرْسِيِّ — ﴿اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ…﴾", count:1, label:"مرة واحدة", src:"البخاري" },
    ];

    const AZKAR_MASAA = [
        { text:"أَعُوذُ بِاللَّهِ السَّمِيعِ الْعَلِيمِ مِنَ الشَّيْطَانِ الرَّجِيمِ", count:3, label:"3 مرات", src:"افتتاح" },
        { text:"اللَّهُمَّ بِكَ أَمْسَيْنَا وَبِكَ أَصْبَحْنَا وَبِكَ نَحْيَا وَبِكَ نَمُوتُ وَإِلَيْكَ الْمَصِيرُ", count:1, label:"مرة واحدة", src:"أبو داود" },
        { text:"اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ", count:1, label:"سيد الاستغفار", src:"البخاري" },
        { text:"أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ", count:1, label:"مرة واحدة", src:"مسلم" },
        { text:"اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لَا إِلَهَ إِلَّا أَنْتَ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، وَأَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلَهَ إِلَّا أَنْتَ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ", count:3, label:"3 مرات", src:"أبو داود" },
        { text:"اللَّهُمَّ صَلِّ وَسَلِّمْ وَبَارِكْ عَلَى نَبِيِّنَا مُحَمَّدٍ ﷺ", count:10, label:"10 مرات", src:"السنة" },
        { text:"سُبْحَانَ اللَّهِ وَبِحَمْدِهِ", count:100, label:"100 مرة", src:"مسلم" },
        { text:"سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، عَدَدَ خَلْقِهِ وَرِضَا نَفْسِهِ وَزِنَةَ عَرْشِهِ وَمِدَادَ كَلِمَاتِهِ", count:3, label:"3 مرات", src:"مسلم" },
        { text:"حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ", count:7, label:"7 مرات", src:"أبو داود" },
        { text:"أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ", count:3, label:"3 مرات", src:"مسلم" },
        { text:"بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ هُوَ اللَّهُ أَحَدٌ…﴾", count:3, label:"3 مرات · الإخلاص", src:"أبو داود" },
        { text:"بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ…﴾ وَ ﴿قُلْ أَعُوذُ بِرَبِّ النَّاسِ…﴾", count:3, label:"3 مرات · المعوذتان", src:"أبو داود" },
        { text:"آيَةُ الْكُرْسِيِّ — ﴿اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ…﴾", count:1, label:"مرة واحدة", src:"البخاري" },
        { text:"اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْهَمِّ وَالْحَزَنِ، وَالْعَجْزِ وَالْكَسَلِ، وَالْجُبْنِ وَالْبُخْلِ، وَغَلَبَةِ الدَّيْنِ وَقَهْرِ الرِّجَالِ", count:1, label:"مرة واحدة", src:"البخاري" },
        { text:"اللَّهُمَّ إِنَّكَ عَفُوٌّ تُحِبُّ الْعَفْوَ فَاعْفُ عَنِّي", count:3, label:"3 مرات", src:"الترمذي" },
        { text:"اللَّهُمَّ قِنِي عَذَابَكَ يَوْمَ تَبْعَثُ عِبَادَكَ", count:3, label:"3 مرات", src:"أبو داود" },
    ];

    const FOOTER_HTML = `
    <div class="mt-14 pb-8 pt-6 border-t border-white/6">
        <div class="text-center text-xs tracking-[0.2em] uppercase text-white/18 font-sans">Devoted By Eng. Mahmoud Attia</div>
    </div>`;

    let currentUser = localStorage.getItem('ramadanUserName');
    let currentTheme = localStorage.getItem('ramadanUserTheme') || 'male';
    let currentDate = new Date().toISOString().split('T')[0];
    let appData = {};
    let dhikrIndex = 0;
    let hasUnsavedChanges = false;
    let azkarCounters = {};

    /* ── Dhikr rotation (GPU: opacity + transform only) ── */
    function rotateDhikr() {
        const el = document.getElementById('dhikrText');
        if (!el) return;
        el.style.transition = 'opacity .38s ease, transform .38s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            dhikrIndex = (dhikrIndex + 1) % DHIKR_LIST.length;
            el.textContent = DHIKR_LIST[dhikrIndex];
            el.style.transition = 'none';
            el.style.transform = 'translateY(8px)';
            el.style.opacity = '0';
            requestAnimationFrame(() => requestAnimationFrame(() => {
                el.style.transition = 'opacity .42s ease, transform .42s ease';
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }));
        }, 400);
    }
    setInterval(rotateDhikr, 4000);

    /* ── Toast ── */
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3200);
    }

    /* ── Unsaved marker ── */
    function markUnsaved() {
        if (!hasUnsavedChanges) {
            hasUnsavedChanges = true;
            document.getElementById('stickySave')?.classList.add('visible');
            const btn = document.getElementById('stickySaveBtn');
            if (btn) {
                btn.style.background = currentTheme === 'male'
                    ? 'linear-gradient(135deg,#f59e0b,#d97706)' : 'linear-gradient(135deg,#d946ef,#7c3aed)';
                btn.style.color = currentTheme === 'male' ? '#000' : '#fff';
            }
        }
    }
    function markSaved() {
        hasUnsavedChanges = false;
        document.getElementById('stickySave')?.classList.remove('visible');
    }

    /* ── Firebase load ── */
    async function fetchData() {
        try {
            const snap = await getDoc(doc(db,"users",currentUser));
            if (snap.exists()) {
                const d = snap.data();
                appData = d.appData || {};
                currentTheme = d.theme || currentTheme;
            } else {
                const ls = localStorage.getItem('ramadanTrackerData_v5');
                if (ls) appData = JSON.parse(ls);
            }
        } catch {
            const ls = localStorage.getItem('ramadanTrackerData_v5');
            if (ls) try { appData = JSON.parse(ls); } catch {}
        }
        loadApp();
    }

    /* ══════════════════════════════════
       PERFORMANCE SECTION HTML
    ══════════════════════════════════ */
    function getPerformanceSectionHTML(isMale) {
        const m = isMale;
        const accentColor = m ? '#fbbf24' : '#d946ef';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-300';
        return `
        <div class="${m?'glass-panel':'glass-card'} rounded-3xl p-5 space-y-5">
            <div class="flex items-center gap-3 pb-3 border-b ${m?'border-amber-500/15':'border-fuchsia-500/15'}">
                <i class="fas fa-chart-line text-xl ${accentText}"></i>
                <h3 class="font-bold text-xl font-kufi text-white">أداؤك اليوم</h3>
            </div>

            <!-- Dual rings -->
            <div class="flex flex-col items-center gap-3">
                <div class="relative w-44 h-44">
                    <svg class="progress-ring w-full h-full -rotate-90" viewBox="0 0 200 200">
                        <!-- Track rings -->
                        <circle cx="100" cy="100" r="88" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="14"/>
                        <circle cx="100" cy="100" r="68" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="11"/>
                        <!-- Fard ring (outer) -->
                        <circle id="fardRing" cx="100" cy="100" r="88" fill="none"
                            stroke="${accentColor}" stroke-width="14" stroke-linecap="round"
                            stroke-dasharray="553" stroke-dashoffset="553"/>
                        <!-- Sunnah ring (inner) -->
                        <circle id="sunnahRing" cx="100" cy="100" r="68" fill="none"
                            stroke="#4ade80" stroke-width="11" stroke-linecap="round"
                            stroke-dasharray="427" stroke-dashoffset="427"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="performancePct" class="text-4xl font-bold text-white font-kufi">0%</span>
                        <span id="performanceLabel" class="text-xs font-amiri ${accentText} mt-0.5 text-center leading-tight">سعيٌ طيب</span>
                    </div>
                </div>
                <div class="flex gap-5 text-xs font-kufi">
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full" style="background:${accentColor}"></div><span class="text-white/45">الفروض</span></div>
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-green-400"></div><span class="text-white/45">السنن</span></div>
                </div>
            </div>

            <!-- Stat cards -->
            <div class="grid grid-cols-3 gap-2.5">
                <div class="perf-stat-card">
                    <div class="text-xs ${m?'text-amber-400/55':'text-fuchsia-300/55'} font-kufi mb-1">الفروض</div>
                    <div class="perf-stat-val ${m?'text-amber-400':'text-fuchsia-300'}" id="todayFardCount">0/5</div>
                    <div class="perf-bar-wrap"><div class="perf-bar-fill" style="background:${accentColor};width:0%" id="todayFardBar"></div></div>
                </div>
                <div class="perf-stat-card">
                    <div class="text-xs text-green-400/55 font-kufi mb-1">السنن</div>
                    <div class="perf-stat-val text-green-400" id="todaySunnahCount">0</div>
                    <div class="perf-bar-wrap"><div class="perf-bar-fill bg-green-400" style="width:0%" id="todaySunnahBar"></div></div>
                </div>
                <div class="perf-stat-card">
                    <div class="text-xs text-blue-400/55 font-kufi mb-1">الأذكار</div>
                    <div class="perf-stat-val text-blue-300" id="todayHabitsCount">0</div>
                    <div class="perf-bar-wrap"><div class="perf-bar-fill bg-blue-400" style="width:0%" id="todayHabitsBar"></div></div>
                </div>
            </div>

            <!-- Khatma progress -->
            <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'}">
                <div class="flex justify-between items-center mb-2.5">
                    <span class="text-sm font-bold text-white/55 font-kufi">مسار ختمة القرآن</span>
                    <span id="khatmaLabel" class="text-xs font-bold ${m?'text-amber-400 bg-amber-500/10':'text-fuchsia-300 bg-fuchsia-500/10'} px-2.5 py-1 rounded-lg font-kufi">الجزء 1</span>
                </div>
                <div class="relative h-2.5 bg-black/45 rounded-full overflow-hidden border border-white/4 mb-3">
                    <div id="khatmaBar" class="absolute top-0 right-0 h-full rounded-full transition-all duration-1000"
                        style="width:0%;background:${accentColor};box-shadow:0 0 10px ${accentColor}44"></div>
                </div>
                <div class="flex justify-between text-center">
                    <div><div class="text-xs ${m?'text-amber-400/45':'text-fuchsia-300/45'} font-kufi">قُرئت</div><div id="currentPages" class="text-2xl font-bold text-white font-amiri">0</div></div>
                    <div><div class="text-xs ${accentText} font-kufi font-bold">المجموع</div><div id="totalPagesAll" class="text-xl font-bold ${accentText} font-amiri">0</div></div>
                    <div><div class="text-xs text-white/28 font-kufi">متبقي</div><div id="remainingPages" class="text-2xl font-bold text-white/38 font-amiri">604</div></div>
                </div>
            </div>

            <!-- Month harvest -->
            <div>
                <div class="text-sm font-bold text-white/45 font-kufi mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-bar ${accentText} text-sm"></i>
                    حصاد الشهر المبارك
                </div>
                <div class="grid grid-cols-2 gap-2.5">
                    <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-3.5 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                        <div class="text-3xl font-bold text-white font-amiri" id="monthFard">0</div>
                        <div class="text-xs ${m?'text-amber-400/65':'text-fuchsia-300/65'} mt-1 font-kufi">فروض مؤداة</div>
                    </div>
                    <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-3.5 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                        <div class="text-3xl font-bold text-white font-amiri" id="monthSunnah">0</div>
                        <div class="text-xs ${m?'text-amber-400/65':'text-fuchsia-300/65'} mt-1 font-kufi">سنن ونوافل</div>
                    </div>
                    <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-3.5 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                        <div class="text-3xl font-bold text-white font-amiri" id="monthTaraweeh">0</div>
                        <div class="text-xs ${m?'text-amber-400/65':'text-fuchsia-300/65'} mt-1 font-kufi">أيام التراويح</div>
                    </div>
                    <div class="bg-gradient-to-br ${m?'from-amber-500/13':'from-fuchsia-500/13'} to-transparent p-3.5 rounded-2xl border ${m?'border-amber-500/22':'border-fuchsia-500/22'} text-center">
                        <div class="text-3xl font-bold ${m?'text-amber-400':'text-fuchsia-400'} font-amiri" id="monthScore">0%</div>
                        <div class="text-xs ${m?'text-amber-400':'text-fuchsia-400'} mt-1 font-kufi font-bold">الالتزام العام</div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    /* ══════════════════════════════════
       HABITS + DAILY LOG
    ══════════════════════════════════ */
    function getHabitsAndInputsHTML(isMale) {
        const m = isMale;
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const accentBg   = m ? 'bg-amber-500/10' : 'bg-fuchsia-500/10';
        const morningId  = m ? 'm_morning' : 'f_morning';
        const eveningId  = m ? 'm_evening' : 'f_evening';
        const taraweehId = m ? 'm_taraweeh' : 'f_taraweeh';
        const qiyamId    = m ? 'm_qiyam' : 'f_qiyam';
        const panel      = m ? 'glass-panel' : 'glass-card';
        const borderColor= m ? 'border-amber-500/13' : 'border-fuchsia-500/13';
        const cardBg     = m ? 'bg-[#1a120b]' : 'bg-[#220d3a]';
        const cardBorder = m ? 'border-amber-500/10' : 'border-fuchsia-500/10';
        const accentColor= m ? '#fbbf24' : '#d946ef';

        return `
        <!-- Habits -->
        <div class="${panel} rounded-3xl p-5 space-y-4">
            <div class="flex items-center gap-3 pb-3 border-b ${borderColor}">
                <i class="fas fa-gem text-xl ${accentText}"></i>
                <h3 class="font-bold text-xl font-kufi text-white">أذكارك ووِردك</h3>
            </div>
            <div class="space-y-3">
                <div id="${morningId}" onclick="window.toggleHabit('${morningId}')" class="prayer-row cursor-pointer select-none" role="button" aria-label="أذكار الصباح">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl ${accentBg} flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-cloud-sun ${accentText}"></i>
                        </div>
                        <span class="text-base font-amiri font-bold text-white">أذكار الصباح</span>
                    </div>
                    <div class="check-circle w-9 h-9 rounded-full border-2 border-white/18 flex items-center justify-center transition-all flex-shrink-0">
                        <i class="fas fa-check text-sm opacity-0 text-black"></i>
                    </div>
                </div>
                <div id="${eveningId}" onclick="window.toggleHabit('${eveningId}')" class="prayer-row cursor-pointer select-none" role="button" aria-label="أذكار المساء">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl ${accentBg} flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-moon ${accentText}"></i>
                        </div>
                        <span class="text-base font-amiri font-bold text-white">أذكار المساء</span>
                    </div>
                    <div class="check-circle w-9 h-9 rounded-full border-2 border-white/18 flex items-center justify-center transition-all flex-shrink-0">
                        <i class="fas fa-check text-sm opacity-0 text-black"></i>
                    </div>
                </div>
                <!-- Taraweeh + Qiyam -->
                <div class="taraweeh-qiyam-grid">
                    <div id="${taraweehId}" onclick="window.toggleHabit('${taraweehId}')"
                        class="night-prayer-card border border-white/7 ${cardBg} select-none">
                        <div class="w-10 h-10 rounded-full ${accentBg} flex items-center justify-center">
                            <i class="fas fa-star-and-crescent ${accentText} text-base"></i>
                        </div>
                        <span class="font-bold font-kufi text-white text-sm leading-tight">التراويح</span>
                        <span class="text-[10px] ${accentText}/55 font-amiri">صلاة الجماعة</span>
                        <div id="${taraweehId}-check" class="w-7 h-7 rounded-full border-2 border-white/18 flex items-center justify-center transition-all">
                            <i class="fas fa-check text-xs opacity-0 text-black"></i>
                        </div>
                    </div>
                    <div id="${qiyamId}" onclick="window.toggleHabit('${qiyamId}')"
                        class="night-prayer-card border border-white/7 ${cardBg} select-none">
                        <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center">
                            <i class="fas fa-moon text-blue-300 text-base"></i>
                        </div>
                        <span class="font-bold font-kufi text-white text-sm leading-tight">قيام الليل</span>
                        <span class="text-[10px] text-blue-300/55 font-amiri">صلاة في البيت</span>
                        <div id="${qiyamId}-check" class="w-7 h-7 rounded-full border-2 border-white/18 flex items-center justify-center transition-all">
                            <i class="fas fa-check text-xs opacity-0 text-black"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily log -->
        <div class="${panel} rounded-3xl p-5 space-y-4">
            <div class="flex items-center gap-3 pb-3 border-b ${borderColor}">
                <i class="fas fa-book-open text-xl ${accentText}"></i>
                <h3 class="font-bold text-xl font-kufi text-white">تسجيل اليوم</h3>
            </div>

            <!-- Quran pages + Juz counter -->
            <div class="grid grid-cols-2 gap-3">
                <div class="${cardBg} p-4 rounded-2xl border ${cardBorder} text-center">
                    <div class="text-xs font-bold ${accentText}/65 mb-2 font-kufi">صفحات القرآن</div>
                    <input type="number" id="quranInput" placeholder="0" inputmode="numeric"
                        class="w-full bg-transparent text-amber-300 text-4xl font-bold text-center focus:outline-none placeholder-zinc-800 font-amiri leading-none"
                        onchange="window.onInputChange();window.syncJuzFromPages()" oninput="window.onInputChange();window.syncJuzFromPages()">
                    <div class="text-xs text-white/18 mt-1.5 font-amiri">صفحة</div>
                </div>
                <div class="${cardBg} p-4 rounded-2xl border ${cardBorder} text-center flex flex-col items-center justify-between gap-2">
                    <div class="text-xs font-bold ${accentText}/65 font-kufi">أجزاء قرأت</div>
                    <div class="flex items-center gap-2">
                        <button onclick="window.changeJuz(-1)"
                            class="w-9 h-9 rounded-xl font-bold text-xl flex items-center justify-center active:scale-90 transition-transform ${m?'bg-amber-500/22 text-amber-300 border border-amber-500/28':'bg-fuchsia-500/22 text-fuchsia-300 border border-fuchsia-500/28'}">−</button>
                        <span id="juzCountDisplay" class="text-4xl font-bold text-amber-300 font-amiri w-10 text-center leading-none" style="transition:transform .18s ease">0</span>
                        <button onclick="window.changeJuz(1)"
                            class="w-9 h-9 rounded-xl font-bold text-xl flex items-center justify-center active:scale-90 transition-transform ${m?'bg-amber-500/22 text-amber-300 border border-amber-500/28':'bg-fuchsia-500/22 text-fuchsia-300 border border-fuchsia-500/28'}">+</button>
                    </div>
                    <div class="text-xs text-white/18 font-amiri">جزء</div>
                </div>
            </div>

            <!-- Khatma mini bar -->
            <div class="${cardBg} px-4 py-3 rounded-2xl border ${cardBorder}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-white/38 font-kufi">تقدمك نحو الختمة</span>
                    <span id="dashKhatmaLabel" class="text-xs font-bold ${accentText} font-kufi">الجزء 1</span>
                </div>
                <div class="h-2 bg-black/38 rounded-full overflow-hidden">
                    <div id="dashKhatmaBar" class="h-full rounded-full transition-all duration-700"
                        style="width:0%;background:${accentColor};box-shadow:0 0 7px ${accentColor}55"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs font-amiri">
                    <span id="dashPagesRead" class="text-white/45">0 صفحة</span>
                    <span class="${accentText}/65">فاضل <span id="dashPagesLeftNum">604</span> صفحة</span>
                </div>
            </div>

            <!-- Work hours -->
            <div class="${cardBg} p-4 rounded-2xl border ${cardBorder} text-center">
                <div class="text-xs font-bold ${accentText}/65 mb-2 font-kufi">ساعات العمل / المذاكرة</div>
                <input type="number" id="workInput" placeholder="0" inputmode="decimal"
                    class="w-full bg-transparent text-amber-300 text-4xl font-bold text-center focus:outline-none placeholder-zinc-800 font-amiri leading-none"
                    onchange="window.onInputChange()" oninput="window.onInputChange()">
                <div class="text-xs text-white/18 mt-1.5 font-amiri">ساعة</div>
            </div>

            <!-- Lessons list -->
            <div class="${cardBg} p-4 rounded-2xl border ${cardBorder}">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-headphones ${accentText} text-sm"></i>
                        <div class="text-xs font-bold ${accentText}/65 font-kufi">الدروس والبودكاست اليوم</div>
                    </div>
                    <span id="lessonsCount" class="text-xs ${accentText} bg-black/28 px-2 py-1 rounded-lg font-kufi font-bold">0 درس</span>
                </div>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="lessonInput" placeholder="اكتب الدرس أو البودكاست..."
                        class="flex-1 min-w-0 bg-black/28 border border-white/8 rounded-xl px-3 py-2.5 text-white text-sm focus:outline-none ${m?'focus:border-amber-500/38':'focus:border-fuchsia-500/38'} transition-colors font-amiri placeholder-zinc-700 text-right"
                        onkeydown="if(event.key==='Enter') window.addLesson()">
                    <button onclick="window.addLesson()"
                        class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0 font-bold text-xl transition-all active:scale-88 ${m?'bg-amber-500 text-black':'bg-fuchsia-500 text-white'}">+</button>
                </div>
                <div id="lessonsList" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
        </div>`;
    }

    /* ══════════════════════════════════
       MALE TEMPLATE
    ══════════════════════════════════ */
    function getMaleTemplate() {
        return `
        <header class="fixed bottom-0 left-0 right-0 z-50 bg-[#0c0804]/96 backdrop-blur-2xl border-t border-amber-500/12 pb-safe shadow-[0_-6px_20px_rgba(0,0,0,0.65)]">
            <nav class="flex justify-around items-center max-w-md mx-auto font-kufi text-xs font-bold px-1 py-2">
                <button onclick="window.toggleView('dashboard')" id="nav-dashboard" class="nav-item active text-amber-500 transition-colors">
                    <i class="fas fa-home text-xl"></i><span>الرئيسية</span>
                </button>
                <button onclick="window.toggleView('quran')" id="nav-quran" class="nav-item text-white/45 hover:text-white transition-colors">
                    <i class="fas fa-book-quran text-xl"></i><span>القرآن</span>
                </button>
                <button onclick="window.toggleView('azkar')" id="nav-azkar" class="nav-item text-white/45 hover:text-white transition-colors">
                    <i class="fas fa-hands-praying text-xl"></i><span>الأذكار</span>
                </button>
                <button onclick="window.toggleView('duaa')" id="nav-duaa" class="nav-item text-white/45 hover:text-white transition-colors">
                    <i class="fas fa-kaaba text-xl"></i><span>الدعاء</span>
                </button>
                <div class="flex flex-col items-center gap-0.5 text-white/55 px-1">
                    <div class="flex items-center gap-1"><i class="fas fa-fire text-amber-400 text-base"></i><span class="font-bold text-white font-amiri text-lg leading-none" id="streakCount">0</span></div>
                    <span class="text-[9px] text-white/28">يوم</span>
                </div>
            </nav>
        </header>

        <div id="dashboard-view" class="animate-fade-in px-4 max-w-lg mx-auto space-y-5 pb-36">
            <div class="text-center space-y-1.5 pt-2">
                <h2 class="text-2xl font-bold font-kufi text-white">أهلاً بك ${currentUser} ✨</h2>
                <p class="text-amber-300/60 font-amiri text-sm">نور الله قلبك وتقبل طاعتك</p>
            </div>

            <!-- Date nav -->
            <div class="flex items-center justify-between bg-[#1a120b]/85 border border-amber-500/18 rounded-2xl p-2 shadow-md backdrop-blur-sm">
                <button onclick="window.changeDate(1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#25180d] text-amber-300 active:bg-[#2e1f10] transition-all active:scale-90"><i class="fas fa-chevron-right text-sm"></i></button>
                <div class="text-center">
                    <span id="dateDisplay" class="font-bold text-sm font-kufi text-white block">...</span>
                    <span id="dateTag" class="text-xs text-amber-400/55 font-amiri">اليوم</span>
                </div>
                <button onclick="window.changeDate(-1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#25180d] text-amber-300 active:bg-[#2e1f10] transition-all active:scale-90"><i class="fas fa-chevron-left text-sm"></i></button>
            </div>

            <!-- Prayers -->
            <div class="glass-panel rounded-3xl p-5 space-y-4">
                <div class="flex items-center gap-3 pb-3 border-b border-amber-500/13">
                    <i class="fas fa-mosque text-xl text-amber-400"></i>
                    <h3 class="font-bold text-xl font-kufi text-white">الصلوات</h3>
                    <span id="prayerProgress" class="mr-auto text-xs font-bold text-amber-400/65 bg-amber-500/10 px-2.5 py-1 rounded-lg font-kufi">0/5 فروض</span>
                </div>
                <div class="flex gap-3 text-xs font-kufi pb-0.5">
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div><span class="text-white/38">فرض مؤدى</span></div>
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-green-400"></div><span class="text-white/38">سنة مؤداة</span></div>
                </div>
                <div id="prayersList" class="space-y-2.5"></div>
            </div>

            ${getHabitsAndInputsHTML(true)}
            ${getPerformanceSectionHTML(true)}

            <button onclick="window.saveData()" id="saveBtn" class="w-full bg-amber-500 active:bg-amber-600 text-black font-extrabold font-kufi py-4 rounded-2xl text-lg shadow-[0_4px_18px_rgba(251,191,36,0.32)] transition-all active:scale-95 border-b-4 border-amber-700">
                💾 حفظ يومياتي
            </button>
            <div class="flex justify-center gap-8 py-1">
                <button onclick="window.goHome()" class="text-sm text-white/35 font-kufi active:text-white transition-colors">تعديل الملف الشخصي</button>
                <button onclick="window.resetData()" class="text-sm text-red-500/45 font-kufi active:text-red-400 transition-colors">تصفير السجل</button>
            </div>
            ${FOOTER_HTML}
        </div>

        ${getAzkarViewHTML(true)}
        ${getQuranViewHTML(true)}
        ${getDuaaViewHTML(true)}`;
    }

    /* ══════════════════════════════════
       FEMALE TEMPLATE
    ══════════════════════════════════ */
    function getFemaleTemplate() {
        return `
        <header class="fixed bottom-0 left-0 right-0 z-50 bg-[#100620]/96 backdrop-blur-2xl border-t border-fuchsia-500/12 pb-safe shadow-[0_-6px_20px_rgba(0,0,0,0.65)]">
            <nav class="flex justify-around items-center max-w-md mx-auto font-kufi text-xs font-bold px-1 py-2">
                <button onclick="window.toggleView('dashboard')" id="nav-dashboard" class="nav-item active text-fuchsia-400 transition-colors">
                    <i class="fas fa-home text-xl"></i><span>الرئيسية</span>
                </button>
                <button onclick="window.toggleView('quran')" id="nav-quran" class="nav-item text-white/45 hover:text-white transition-colors">
                    <i class="fas fa-book-quran text-xl"></i><span>القرآن</span>
                </button>
                <button onclick="window.toggleView('azkar')" id="nav-azkar" class="nav-item text-white/45 hover:text-white transition-colors">
                    <i class="fas fa-hands-praying text-xl"></i><span>الأذكار</span>
                </button>
                <button onclick="window.toggleView('duaa')" id="nav-duaa" class="nav-item text-white/45 hover:text-white transition-colors">
                    <i class="fas fa-kaaba text-xl"></i><span>الدعاء</span>
                </button>
                <div class="flex flex-col items-center gap-0.5 text-white/55 px-1">
                    <div class="flex items-center gap-1"><i class="fas fa-heart text-fuchsia-400 text-base"></i><span class="font-bold text-white font-amiri text-lg leading-none" id="streakCount">0</span></div>
                    <span class="text-[9px] text-white/28">يوم</span>
                </div>
            </nav>
        </header>

        <div id="dashboard-view" class="animate-fade-in px-4 max-w-lg mx-auto space-y-5 pb-36">
            <div class="text-center space-y-1.5 pt-2">
                <h2 class="text-2xl font-bold font-kufi text-white">أهلاً بكِ ${currentUser} ✨</h2>
                <p class="text-fuchsia-300/60 font-amiri text-sm">نور الله قلبكِ وتقبل طاعتكِ</p>
            </div>

            <div class="flex items-center justify-between bg-[#220d3a]/85 border border-fuchsia-500/18 rounded-2xl p-2 shadow-md backdrop-blur-sm">
                <button onclick="window.changeDate(1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#2d114d] text-fuchsia-300 active:bg-[#3a1663] transition-all active:scale-90"><i class="fas fa-chevron-right text-sm"></i></button>
                <div class="text-center">
                    <span id="dateDisplay" class="font-bold text-sm font-kufi text-white block">...</span>
                    <span id="dateTag" class="text-xs text-fuchsia-400/55 font-amiri">اليوم</span>
                </div>
                <button onclick="window.changeDate(-1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#2d114d] text-fuchsia-300 active:bg-[#3a1663] transition-all active:scale-90"><i class="fas fa-chevron-left text-sm"></i></button>
            </div>

            <div class="glass-card rounded-3xl p-5 space-y-4">
                <div class="flex items-center gap-3 pb-3 border-b border-fuchsia-500/13">
                    <i class="fas fa-mosque text-xl text-fuchsia-400"></i>
                    <h3 class="font-bold text-xl font-kufi text-white">صلواتكِ اليوم</h3>
                    <span id="prayerProgress" class="mr-auto text-xs font-bold text-fuchsia-300/65 bg-fuchsia-500/10 px-2.5 py-1 rounded-lg font-kufi">0/5 فروض</span>
                </div>
                <div class="flex gap-3 text-xs font-kufi pb-0.5">
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-fuchsia-400"></div><span class="text-white/38">فرض مؤدى</span></div>
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-green-400"></div><span class="text-white/38">سنة مؤداة</span></div>
                </div>
                <div id="prayersList" class="space-y-2.5"></div>
            </div>

            ${getHabitsAndInputsHTML(false)}
            ${getPerformanceSectionHTML(false)}

            <button onclick="window.saveData()" id="saveBtn" class="w-full bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white font-extrabold font-kufi py-4 rounded-2xl text-lg shadow-[0_4px_18px_rgba(217,70,239,0.32)] transition-all active:scale-95 border-b-4 border-purple-900">
                ✨ حفظ يومياتي
            </button>
            <div class="flex justify-center gap-8 py-1">
                <button onclick="window.goHome()" class="text-sm text-white/35 font-kufi active:text-white transition-colors">إعدادات الملف الشخصي</button>
                <button onclick="window.resetData()" class="text-sm text-red-500/45 font-kufi active:text-red-400 transition-colors">تصفير السجل</button>
            </div>
            ${FOOTER_HTML}
        </div>

        ${getAzkarViewHTML(false)}
        ${getQuranViewHTML(false)}
        ${getDuaaViewHTML(false)}`;
    }

    /* ══════════════════════════════════
       AZKAR VIEW
    ══════════════════════════════════ */
    function getAzkarViewHTML(isMale) {
        const m = isMale;
        const panel = m ? 'glass-panel' : 'glass-card';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';

        return `
        <div id="azkar-view" class="hidden animate-fade-in pb-32 px-4 max-w-lg mx-auto space-y-4">
            <div class="text-center mt-4 mb-1 relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-28 h-28 ${m?'bg-amber-500/6':'bg-fuchsia-500/6'} blur-3xl rounded-full pointer-events-none"></div>
                <i class="fas fa-hands-praying text-5xl ${accentText} mb-3 block animate-float relative z-10"></i>
                <h2 class="text-3xl font-amiri font-bold text-white relative z-10">الأَذْكَارُ اليَوْمِيَّة</h2>
                <p class="text-sm font-kufi mt-1 relative z-10">
                    <span class="text-white/28">أتممت </span><span id="azkarProgressText" class="font-bold text-white/65">0</span><span class="text-white/28"> من الأذكار</span>
                </p>
                <div class="h-px w-14 bg-gradient-to-r from-transparent ${m?'via-amber-500':'via-fuchsia-500'} to-transparent mx-auto rounded-full mt-2"></div>
            </div>

            <div class="${panel} rounded-2xl p-2">
                <div class="flex gap-2 bg-black/28 p-1.5 rounded-xl">
                    <button onclick="window.switchAzkarTab('sabah')" id="azkar-tab-sabah" class="azkar-tab-btn ${m?'active-m':'active-f'}">🌅 أذكار الصباح</button>
                    <button onclick="window.switchAzkarTab('masaa')" id="azkar-tab-masaa" class="azkar-tab-btn">🌙 أذكار المساء</button>
                </div>
            </div>

            <div id="azkarList" class="${panel} rounded-3xl p-4"></div>

            <button onclick="window.markAllAzkarDone()"
                class="w-full py-4 rounded-2xl font-bold font-kufi text-lg transition-all active:scale-95 ${m?'bg-amber-500 text-black border-b-4 border-amber-700':'bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white border-b-4 border-purple-900'}">
                ✅ أتممت الأذكار
            </button>
            ${FOOTER_HTML}
        </div>`;
    }

    /* ══════════════════════════════════
       QURAN VIEW
    ══════════════════════════════════ */
    function getQuranViewHTML(isMale) {
        const m = isMale;
        const panel = m ? 'glass-panel' : 'glass-card';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const accentBorder = m ? 'border-amber-500/22' : 'border-fuchsia-500/22';

        return `
        <div id="quran-view" class="hidden animate-fade-in pb-32 px-4 max-w-lg mx-auto space-y-4">
            <div class="text-center mt-4 mb-1 relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-28 h-28 ${m?'bg-amber-500/6':'bg-fuchsia-500/6'} blur-3xl rounded-full pointer-events-none"></div>
                <i class="fas fa-book-quran text-5xl ${accentText} mb-3 block animate-float relative z-10"></i>
                <h2 class="text-3xl font-amiri font-bold text-white relative z-10">القُرْآنُ الكَرِيم</h2>
                <div class="h-px w-14 bg-gradient-to-r from-transparent ${m?'via-amber-500':'via-fuchsia-500'} to-transparent mx-auto rounded-full mt-2"></div>
            </div>

            <div class="${panel} rounded-3xl p-4 space-y-4">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fas fa-pencil-alt ${accentText} text-sm"></i>
                    <span class="text-sm font-bold font-kufi text-white/65">سجّل ما قرأته اليوم</span>
                </div>
                <div class="flex gap-2 bg-black/28 p-1 rounded-xl">
                    <button onclick="window.setQuranLogMode('pages')" id="qlog-pages-btn"
                        class="flex-1 py-2.5 rounded-lg font-kufi text-sm font-bold transition-all ${m?'bg-amber-500 text-black':'bg-fuchsia-500 text-white'} shadow-sm">صفحات</button>
                    <button onclick="window.setQuranLogMode('juz')" id="qlog-juz-btn"
                        class="flex-1 py-2.5 rounded-lg font-kufi text-sm font-bold transition-all text-white/38">أجزاء</button>
                </div>
                <div id="qlog-pages-mode">
                    <div class="flex items-center gap-3 bg-black/28 rounded-2xl p-4">
                        <button onclick="window.adjustQuranPages(-5)" class="w-11 h-11 rounded-xl bg-white/8 text-white font-bold text-sm active:scale-90 transition-transform">-5</button>
                        <button onclick="window.adjustQuranPages(-1)" class="w-11 h-11 rounded-xl bg-white/8 text-white font-bold text-sm active:scale-90 transition-transform">-1</button>
                        <div class="flex-1 text-center">
                            <input type="number" id="quranLogPages" placeholder="0" inputmode="numeric"
                                class="w-full bg-transparent text-white text-4xl font-bold text-center focus:outline-none placeholder-zinc-800 font-amiri leading-none"
                                onchange="window.onInputChange()" oninput="window.onInputChange()">
                            <div class="text-xs text-white/22 font-amiri mt-1">صفحة</div>
                        </div>
                        <button onclick="window.adjustQuranPages(1)" class="w-11 h-11 rounded-xl bg-white/8 text-white font-bold text-sm active:scale-90 transition-transform">+1</button>
                        <button onclick="window.adjustQuranPages(5)" class="w-11 h-11 rounded-xl bg-white/8 text-white font-bold text-sm active:scale-90 transition-transform">+5</button>
                    </div>
                </div>
                <div id="qlog-juz-mode" class="hidden">
                    <p class="text-xs text-white/35 font-kufi mb-3 text-center">اضغط على الأجزاء اللي قرأتها اليوم</p>
                    <div class="juz-grid" id="juzGrid"></div>
                    <p class="text-center text-xs ${accentText}/55 font-kufi mt-2" id="juzSumLabel">= 0 صفحة</p>
                </div>
            </div>

            <!-- Surah reader -->
            <div class="${panel} rounded-3xl p-4 space-y-3">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fas fa-book-open ${accentText} text-sm"></i>
                    <span class="text-sm font-bold font-kufi text-white/65">تلاوة السور</span>
                </div>
                <select id="surahSelect" onchange="window.loadSurah()"
                    class="w-full bg-black/35 border ${accentBorder} rounded-xl px-4 py-3 text-white text-sm font-amiri focus:outline-none appearance-none text-right">
                    <option value="">اختر السورة...</option>
                </select>
                <div id="surahInfo" class="hidden text-center pb-1">
                    <div class="font-amiri text-2xl font-bold text-white" id="surahNameAr"></div>
                    <div class="text-xs ${accentText}/55 font-kufi mt-0.5" id="surahVerseCount"></div>
                </div>
                <div class="text-center font-amiri text-xl text-amber-300/65 leading-relaxed py-1 border-y border-white/5" id="bismillah">
                    بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ
                </div>
                <div id="quranLoading" class="hidden text-center py-8">
                    <div class="w-10 h-10 border-3 border-white/10 border-t-amber-400 rounded-full animate-spin mx-auto mb-3"></div>
                    <p class="text-white/35 text-sm font-amiri">جارٍ التحميل...</p>
                </div>
                <div id="quranContainer" class="hidden">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex gap-2">
                            <button onclick="window.changeFontSize(-1)" class="w-9 h-9 rounded-lg bg-white/7 text-white text-sm active:scale-90 transition-transform">A−</button>
                            <button onclick="window.changeFontSize(1)" class="w-9 h-9 rounded-lg bg-white/7 text-white text-sm active:scale-90 transition-transform">A+</button>
                        </div>
                    </div>
                    <div id="quranVerses" class="font-amiri text-white leading-[2.5] text-right space-y-3" style="font-size:26px;"></div>
                </div>
                <div id="quranNavBar" class="hidden flex justify-between items-center pt-2 border-t border-white/5">
                    <button onclick="window.prevSurah()" class="px-4 py-2 rounded-xl bg-white/7 text-white text-sm font-kufi active:scale-90 transition-transform">السورة السابقة</button>
                    <span id="quranNavLabel" class="text-xs ${accentText}/55 font-kufi"></span>
                    <button onclick="window.nextSurah()" class="px-4 py-2 rounded-xl bg-white/7 text-white text-sm font-kufi active:scale-90 transition-transform">السورة التالية</button>
                </div>
            </div>
            ${FOOTER_HTML}
        </div>`;
    }

    /* ══════════════════════════════════
       DUAA VIEW
    ══════════════════════════════════ */
    function getDuaaViewHTML(isMale) {
        const m = isMale;
        const panel = m ? 'glass-panel' : 'glass-card';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const accentBorder = m ? 'border-amber-500/22' : 'border-fuchsia-500/22';
        const borderColor = m ? 'border-amber-500/13' : 'border-fuchsia-500/13';
        const accentBg = m ? 'bg-amber-500/10' : 'bg-fuchsia-500/10';
        const accentBgBold = m ? 'bg-amber-500/15' : 'bg-fuchsia-500/12';
        const iftarText = m ? 'text-amber-400' : 'text-fuchsia-300';

        return `
        <div id="duaa-view" class="hidden animate-fade-in pb-32 px-4 max-w-lg mx-auto space-y-4">
            <div class="text-center mt-4 mb-1">
                <i class="fas fa-kaaba text-5xl ${accentText} mb-3 block animate-float"></i>
                <h2 class="text-3xl font-amiri font-bold text-white">الدُّعَاءُ وَالأَوْقَات</h2>
                <div class="h-px w-14 bg-gradient-to-r from-transparent ${m?'via-amber-500':'via-fuchsia-500'} to-transparent mx-auto rounded-full mt-2"></div>
            </div>

            <!-- City tabs -->
            <div class="${panel} rounded-2xl p-2">
                <div class="flex gap-2 bg-black/28 p-1.5 rounded-xl">
                    <button id="tab-cairo" onclick="window.selectCity('cairo')" class="flex-1 py-2 rounded-lg font-kufi text-xs font-bold ${m?'bg-amber-500 text-black':'bg-fuchsia-500 text-white'} shadow-sm transition-all">القاهرة</button>
                    <button id="tab-alex" onclick="window.selectCity('alex')" class="flex-1 py-2 rounded-lg font-kufi text-xs font-bold text-white/38 transition-all">الإسكندرية</button>
                    <button id="tab-mansoura" onclick="window.selectCity('mansoura')" class="flex-1 py-2 rounded-lg font-kufi text-xs font-bold text-white/38 transition-all">المنصورة</button>
                </div>
            </div>

            <!-- Prayer times grid -->
            <div class="${panel} rounded-3xl p-4 space-y-4">
                <div class="flex items-center gap-2 pb-2 border-b ${borderColor}">
                    <i class="fas fa-clock ${accentText} text-sm"></i>
                    <span class="text-sm font-bold font-kufi text-white/65" id="azanDateLabel">...</span>
                </div>
                <div class="grid grid-cols-3 gap-2.5">
                    <div class="bg-black/28 border ${m?'border-amber-500/8':'border-fuchsia-500/8'} rounded-xl p-3 text-center"><div class="text-xs ${accentText}/55 font-kufi mb-1">الفَجْر 🌙</div><div class="text-lg font-bold text-white font-amiri" id="az-fajr">--:--</div></div>
                    <div class="bg-black/28 border ${m?'border-amber-500/8':'border-fuchsia-500/8'} rounded-xl p-3 text-center"><div class="text-xs ${accentText}/55 font-kufi mb-1">الشُّرُوق ☀️</div><div class="text-lg font-bold text-white font-amiri" id="az-sunrise">--:--</div></div>
                    <div class="bg-black/28 border ${m?'border-amber-500/8':'border-fuchsia-500/8'} rounded-xl p-3 text-center"><div class="text-xs ${accentText}/55 font-kufi mb-1">الظُّهْر 🕛</div><div class="text-lg font-bold text-white font-amiri" id="az-dhuhr">--:--</div></div>
                    <div class="bg-black/28 border ${m?'border-amber-500/8':'border-fuchsia-500/8'} rounded-xl p-3 text-center"><div class="text-xs ${accentText}/55 font-kufi mb-1">العَصْر 🌤️</div><div class="text-lg font-bold text-white font-amiri" id="az-asr">--:--</div></div>
                    <div class="${accentBgBold} border ${accentBorder} rounded-xl p-3 text-center relative overflow-hidden">
                        <div class="absolute inset-0 ${accentBg} animate-pulse rounded-xl"></div>
                        <div class="text-xs ${iftarText} font-kufi mb-1 font-bold relative z-10">الإِفْطَار 🌅</div>
                        <div class="text-xl font-bold ${iftarText} font-amiri relative z-10" id="az-maghrib">--:--</div>
                    </div>
                    <div class="bg-black/28 border ${m?'border-amber-500/8':'border-fuchsia-500/8'} rounded-xl p-3 text-center"><div class="text-xs ${accentText}/55 font-kufi mb-1">العِشَاء 🌃</div><div class="text-lg font-bold text-white font-amiri" id="az-isha">--:--</div></div>
                </div>
                <div id="iftarCountdown" class="text-center py-1.5 text-sm font-kufi ${accentText}/65 hidden">
                    <i class="fas fa-hourglass-half ml-1 ${accentText}"></i>
                    <span id="iftarCountdownText"></span>
                </div>
            </div>

            <!-- Dua Iftar -->
            <div class="${panel} rounded-3xl p-5 relative overflow-hidden">
                <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent ${m?'via-amber-400':'via-fuchsia-400'} to-transparent opacity-45 rounded-t-3xl"></div>
                <div class="flex items-center gap-3 pb-3 border-b ${borderColor} mb-4"><span class="text-2xl">🌅</span><h3 class="font-bold text-xl font-kufi ${iftarText}">دُعَاءُ الإِفْطَار</h3></div>
                <p class="font-amiri text-xl text-white leading-[2.4] text-center mb-3 tracking-wide">اللَّهُمَّ لَكَ صُمْتُ، وَعَلَى رِزْقِكَ أَفْطَرْتُ،<br>ذَهَبَ الظَّمَأُ وَابْتَلَّتِ الْعُرُوقُ،<br>وَثَبَتَ الأَجْرُ إِنْ شَاءَ اللَّه</p>
                <div class="text-center text-xs ${accentText}/45 font-amiri">رواه أبو داود</div>
            </div>

            <!-- Dua Qadr -->
            <div class="${panel} rounded-3xl p-5 relative overflow-hidden">
                <div class="flex items-center gap-3 pb-3 border-b ${borderColor} mb-4"><span class="text-2xl">🌙</span><h3 class="font-bold text-xl font-kufi ${iftarText}">دُعَاءُ لَيْلَةِ الْقَدْر</h3></div>
                <p class="font-amiri text-xl text-white leading-[2.4] text-center tracking-wide">اللَّهُمَّ إِنَّكَ عَفُوٌّ كَرِيم،<br>تُحِبُّ الْعَفْوَ فَاعْفُ عَنِّي</p>
                <div class="text-center text-xs ${accentText}/45 font-amiri mt-3">رواه الترمذي وصححه</div>
            </div>

            <!-- Selected Duas -->
            <div class="${panel} rounded-3xl p-5 space-y-4">
                <div class="flex items-center gap-3 pb-3 border-b ${borderColor}"><i class="fas fa-book-open text-xl ${accentText}"></i><h3 class="font-bold text-xl font-kufi text-white">أَدْعِيَةٌ مُخْتَارَة</h3></div>
                <div class="space-y-3">
                    ${["اللَّهُمَّ أَعِنِّي عَلَى ذِكْرِكَ وَشُكْرِكَ وَحُسْنِ عِبَادَتِك",
                       "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّار",
                       "اللَّهُمَّ اهْدِنِي وَسَدِّدْنِي، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْهُدَى وَالسَّدَاد",
                       "اللَّهُمَّ تَقَبَّلْ صِيَامَنَا وَقِيَامَنَا وَاجْعَلْنَا مِنْ عُتَقَائِكَ مِنَ النَّار",
                       "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْجَنَّةَ وَمَا قَرَّبَ إِلَيْهَا مِنْ قَوْلٍ أَوْ عَمَل",
                       "اللَّهُمَّ بَلِّغْنَا رَمَضَان، وَبَلِّغْنَا لَيْلَةَ الْقَدْر، وَاجْعَلْنَا مِنَ الْفَائِزِين"
                    ].map(d=>`<div class="p-4 bg-black/22 rounded-2xl border border-white/5 active:scale-[0.98] transition-transform cursor-pointer text-right" onclick="window.copyDua(this)">
                        <p class="font-amiri text-lg text-white leading-[2.2]">${d}</p>
                        <div class="text-xs ${accentText}/35 font-kufi mt-2 flex items-center gap-1"><i class="fas fa-copy text-[10px]"></i> اضغط للنسخ</div>
                    </div>`).join('')}
                </div>
            </div>

            <!-- Sadaqa jaria -->
            <div class="${panel} p-5 rounded-3xl text-center relative overflow-hidden">
                <div class="text-sm font-bold ${accentText} mb-4 font-kufi">${m?'💛':'💜'} صَدَقَةٌ جَارِيَة</div>
                <p class="font-amiri text-lg text-white/82 leading-[2.4] mb-5 tracking-wide">اللَّهُمَّ اغْفِرْ لِمَوْتَانَا وَمَوْتَى الْمُسْلِمِين،<br>وَارْحَمْهُمْ بِرَحْمَتِكَ الَّتِي وَسِعَتْ كُلَّ شَيْء،<br>وَاجْعَلْ قُبُورَهُمْ رَوْضَةً مِنْ رِيَاضِ الْجَنَّة</p>
                <div class="font-amiri text-lg font-bold text-white space-y-2.5 leading-relaxed">
                    <div class="py-2 border-b ${m?'border-amber-500/13':'border-fuchsia-500/13'}">عَطِيَّة إِبْرَاهِيم</div>
                    <div class="${m?'text-amber-300':'text-fuchsia-200'} py-2 border-b ${m?'border-amber-500/13':'border-fuchsia-500/13'}">أَحْمَد مُحَمَّد السَّيِّد عَلِيوَه</div>
                    <div class="py-2">حَمْزَة مُحَمَّد إِبْرَاهِيم</div>
                </div>
            </div>
            ${FOOTER_HTML}
        </div>`;
    }

    /* ══════════════════════════════════
       SETUP
    ══════════════════════════════════ */
    window.selectSetupTheme = (t) => {
        document.getElementById('themeMale')?.classList.remove('selected-male','selected-female');
        document.getElementById('themeFemale')?.classList.remove('selected-male','selected-female');
        if (t === 'male') document.getElementById('themeMale')?.classList.add('selected-male');
        else document.getElementById('themeFemale')?.classList.add('selected-female');
        currentTheme = t;
    };

    window.finishSetup = async () => {
        const name = document.getElementById('setupName').value.trim();
        if (!name) return showToast('الاسم يزين تطبيقنا.. فضلاً أدخله');
        currentUser = name;
        localStorage.setItem('ramadanUserName', name);
        localStorage.setItem('ramadanUserTheme', currentTheme);
        await setDoc(doc(db,"users",name),{username:name,theme:currentTheme,appData:{}},{merge:true});
        location.reload();
    };

    /* ── Nav — delegate to avoid multiple listeners ── */
    window.toggleView = (view) => {
        ['dashboard','duaa','quran','azkar'].forEach(v => document.getElementById(`${v}-view`)?.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('text-amber-500','text-fuchsia-400');
            el.classList.add('text-white/45');
        });
        document.getElementById(`${view}-view`)?.classList.remove('hidden');
        const col = currentTheme === 'male' ? 'text-amber-500' : 'text-fuchsia-400';
        const navEl = document.getElementById(`nav-${view}`);
        if (navEl) { navEl.classList.remove('text-white/45'); navEl.classList.add(col); }
        window.scrollTo({ top:0, behavior:'smooth' });
        if (view === 'duaa') setTimeout(() => { renderPrayerTimes(selectedCity); window.selectCity(selectedCity); }, 50);
        if (view === 'quran') setTimeout(initQuran, 50);
        if (view === 'azkar') setTimeout(() => renderAzkarList('sabah'), 50);
    };

    /* ── Date ── */
    window.changeDate = (d) => {
        const dt = new Date(currentDate);
        dt.setDate(dt.getDate() - d);
        currentDate = dt.toISOString().split('T')[0];
        updateUI();
    };

    /* ── Prayer toggle ── */
    window.togglePrayer = (key, type) => {
        if (!appData[currentDate]) appData[currentDate] = { prayers:{} };
        if (!appData[currentDate].prayers) appData[currentDate].prayers = {};
        if (!appData[currentDate].prayers[key]) appData[currentDate].prayers[key] = {};
        appData[currentDate].prayers[key][type] = !appData[currentDate].prayers[key][type];
        markUnsaved();
        autoSave();
        updateUI();
        const btn = document.getElementById(`btn-${key}-${type}`);
        if (btn) { btn.classList.add('animate-pop'); setTimeout(() => btn.classList.remove('animate-pop'), 350); }
    };

    /* ── Habit toggle ── */
    window.toggleHabit = (id) => {
        if (!appData[currentDate]) appData[currentDate] = {};
        appData[currentDate][id] = !appData[currentDate][id];
        markUnsaved();
        autoSave();
        updateUI();
    };

    window.onInputChange = () => markUnsaved();

    /* ── Juz counter ── */
    window.changeJuz = (delta) => {
        if (!appData[currentDate]) appData[currentDate] = {};
        const next = Math.max(0, Math.min(30, (appData[currentDate].juzCount||0) + delta));
        appData[currentDate].juzCount = next;
        markUnsaved();
        refreshDashJuz();
        autoSave();
    };
    window.syncJuzFromPages = () => refreshDashKhatma();

    function refreshDashJuz() {
        const juzEl = document.getElementById('juzCountDisplay');
        if (juzEl) {
            juzEl.textContent = appData[currentDate]?.juzCount || 0;
            juzEl.style.transform = 'scale(1.28)';
            setTimeout(() => { juzEl.style.transform = 'scale(1)'; }, 200);
        }
        refreshDashKhatma();
    }

    function calcJuzPages(jc) { return jc > 0 ? 22 + (jc-1)*20 : 0; }

    function refreshDashKhatma() {
        let total = 0;
        Object.values(appData).forEach(d => { total += (d.quran||0) + calcJuzPages(d.juzCount||0); });
        const inCycle = total % 604;
        const khatmaNum = Math.floor(total/604)+1;
        const juzNum = Math.min(30, Math.floor(inCycle/20)+1);
        const pct = (inCycle/604*100).toFixed(1);

        const bar = document.getElementById('dashKhatmaBar');
        const lbl = document.getElementById('dashKhatmaLabel');
        const read = document.getElementById('dashPagesRead');
        const leftNum = document.getElementById('dashPagesLeftNum');
        if (bar) bar.style.width = pct+'%';
        if (lbl) lbl.textContent = khatmaNum > 1 ? `الختمة ${khatmaNum} · الجزء ${juzNum}` : `الجزء ${juzNum}`;
        if (read) read.textContent = `${inCycle} صفحة`;
        if (leftNum) leftNum.textContent = 604 - inCycle;
        const juzEl = document.getElementById('juzCountDisplay');
        if (juzEl) juzEl.textContent = appData[currentDate]?.juzCount || 0;
    }

    /* ── Auto-save (toggles) ── */
    async function autoSave() {
        const qi = document.getElementById('quranInput') || document.getElementById('quranLogPages');
        const wi = document.getElementById('workInput');
        if (!appData[currentDate]) appData[currentDate] = {};
        if (qi) appData[currentDate].quran = parseInt(qi.value)||0;
        if (wi) appData[currentDate].work  = parseFloat(wi.value)||0;
        try {
            await updateDoc(doc(db,"users",currentUser),{ appData });
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
        } catch {
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
        }
    }

    /* ── Prayer rows init — build once ── */
    function initPrayersUI() {
        const list = document.getElementById('prayersList');
        if (!list) return;
        const m = currentTheme === 'male';
        const iconBg = m ? 'bg-amber-500/10' : 'bg-fuchsia-500/10';
        const iconColor = m ? 'text-amber-400' : 'text-fuchsia-400';
        list.innerHTML = Object.keys(PRAYERS_CONFIG).map(key => {
            const p = PRAYERS_CONFIG[key];
            const icon = PRAYER_ICONS[key]||'fa-circle';
            return `<div class="prayer-row" id="row-${key}">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${iconBg}">
                        <i class="fas ${icon} ${iconColor} text-sm"></i>
                    </div>
                    <span class="text-base font-bold font-amiri text-white">${p.label}</span>
                </div>
                <div class="flex gap-2">
                    ${p.fard ? `<button onclick="window.togglePrayer('${key}','fard')" id="btn-${key}-fard" class="prayer-btn font-kufi">فرض</button>` : ''}
                    ${p.sunnah ? `<button onclick="window.togglePrayer('${key}','sunnah')" id="btn-${key}-sunnah" class="prayer-btn font-amiri"><span class="sunnah-check">سنة</span></button>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    /* ── Update UI ── */
    function updateUI() {
        const today = new Date().toISOString().split('T')[0];
        const dateObj = new Date(currentDate);
        const dateEl = document.getElementById('dateDisplay');
        const tagEl = document.getElementById('dateTag');
        if (dateEl) dateEl.textContent = dateObj.toLocaleDateString('ar-EG',{weekday:'long',day:'numeric',month:'long'});
        if (tagEl) tagEl.textContent = currentDate===today ? 'اليوم' : currentDate<today ? 'يوم سابق' : 'يوم قادم';

        const day = appData[currentDate] || {};
        const prayers = day.prayers || {};
        let fardDone=0, fardTotal=0, sunnahDone=0;

        Object.keys(PRAYERS_CONFIG).forEach(key => {
            const state = prayers[key]||{};
            const p = PRAYERS_CONFIG[key];
            if (p.fard) fardTotal++;
            const fBtn = document.getElementById(`btn-${key}-fard`);
            const sBtn = document.getElementById(`btn-${key}-sunnah`);
            const row  = document.getElementById(`row-${key}`);
            const doneClass = currentTheme==='male' ? 'row-done-m' : 'row-done-f';

            if (fBtn) {
                if (state.fard) {
                    fardDone++;
                    fBtn.className = `prayer-btn font-kufi ${currentTheme==='male'?'btn-fard-done':'btn-fard-done-f'}`;
                    fBtn.innerHTML = '<i class="fas fa-check ml-1 text-xs"></i> فرض';
                } else {
                    fBtn.className = 'prayer-btn font-kufi';
                    fBtn.innerHTML = 'فرض';
                }
            }
            if (sBtn) {
                if (state.sunnah) {
                    sunnahDone++;
                    sBtn.className = `prayer-btn font-amiri ${currentTheme==='male'?'btn-sunnah-done':'btn-sunnah-done-f'}`;
                    sBtn.innerHTML = '<i class="fas fa-check ml-1 text-xs"></i> سنة';
                } else {
                    sBtn.className = 'prayer-btn font-amiri';
                    sBtn.innerHTML = '<span class="sunnah-check">سنة</span>';
                }
            }
            if (row) { if(state.fard) row.classList.add(doneClass); else row.classList.remove(doneClass); }
        });

        const ppEl = document.getElementById('prayerProgress');
        if (ppEl) ppEl.textContent = `${fardDone}/${fardTotal} فروض`;

        const habitIds = currentTheme==='male'
            ? ['m_morning','m_evening','m_taraweeh','m_qiyam']
            : ['f_morning','f_evening','f_taraweeh','f_qiyam'];

        habitIds.forEach(h => {
            const el = document.getElementById(h);
            if (!el) return;
            const isDone = !!day[h];
            const activeClass = currentTheme==='male' ? 'habit-active-m' : 'habit-active-f';

            if (h.includes('taraweeh') || h.includes('qiyam')) {
                const checkEl = document.getElementById(`${h}-check`);
                const checkIcon = checkEl?.querySelector('i.fa-check');
                if (isDone) {
                    el.style.borderColor = currentTheme==='male' ? 'rgba(251,191,36,0.55)' : 'rgba(240,171,252,0.55)';
                    el.style.background  = currentTheme==='male' ? 'rgba(251,191,36,0.1)' : 'rgba(240,171,252,0.08)';
                    if (checkEl) {
                        checkEl.style.background = h.includes('qiyam') ? '#4ade80' : (currentTheme==='male'?'#fbbf24':'#d946ef');
                        checkEl.style.borderColor = 'transparent';
                    }
                    if (checkIcon) { checkIcon.style.opacity='1'; checkIcon.style.color='#000'; }
                } else {
                    el.style.borderColor = ''; el.style.background = '';
                    if (checkEl) { checkEl.style.background=''; checkEl.style.borderColor=''; }
                    if (checkIcon) checkIcon.style.opacity='0';
                }
                return;
            }

            const circleBg = currentTheme==='male' ? 'bg-amber-400' : 'bg-fuchsia-400';
            const circleBorder = currentTheme==='male' ? 'border-amber-400' : 'border-fuchsia-400';
            const circle = el.querySelector('.check-circle');
            const cIcon  = el.querySelector('i.fa-check');
            if (isDone) {
                el.classList.add(activeClass);
                circle?.classList.add(circleBg, circleBorder);
                if (cIcon) { cIcon.classList.remove('opacity-0'); cIcon.classList.add('opacity-100'); }
            } else {
                el.classList.remove(activeClass);
                circle?.classList.remove(circleBg, circleBorder);
                if (cIcon) { cIcon.classList.add('opacity-0'); cIcon.classList.remove('opacity-100'); }
            }
        });

        const qi = document.getElementById('quranInput') || document.getElementById('quranLogPages');
        const wi = document.getElementById('workInput');
        if (qi) qi.value = day.quran || '';
        if (wi) wi.value = day.work  || '';
        refreshDashKhatma();
        renderLessonsList();
        updateDashboard(fardDone, fardTotal, sunnahDone);
    }

    /* ── Dashboard stats ── */
    function updateDashboard(fardDoneToday=0, fardTotalToday=5, sunnahDoneToday=0) {
        let totalQ=0, totalFard=0, totalSunnah=0, totalTaraweeh=0, totalQiyam=0;
        const daysTracked = Math.max(Object.keys(appData).length, 1);
        const cd = appData[currentDate] || {};

        const hasMorning  = !!(cd.m_morning  || cd.f_morning);
        const hasEvening  = !!(cd.m_evening  || cd.f_evening);
        const hasTaraweeh = !!(cd.m_taraweeh || cd.f_taraweeh);
        const hasQiyam    = !!(cd.m_qiyam    || cd.f_qiyam);
        const habitsCount = [hasMorning,hasEvening,hasTaraweeh,hasQiyam].filter(Boolean).length;

        Object.values(appData).forEach(d => {
            totalQ += (d.quran||0) + calcJuzPages(d.juzCount||0);
            if (d.prayers) {
                Object.keys(PRAYERS_CONFIG).forEach(k => {
                    if (PRAYERS_CONFIG[k].fard   && d.prayers[k]?.fard)   totalFard++;
                    if (PRAYERS_CONFIG[k].sunnah && d.prayers[k]?.sunnah) totalSunnah++;
                });
            }
            if (d.m_taraweeh || d.f_taraweeh) totalTaraweeh++;
            if (d.m_qiyam    || d.f_qiyam)    totalQiyam++;
        });

        const quranScore = Math.min((cd.quran||0)/10, 1);
        const dailyPerf  = Math.round(
            (fardDoneToday/Math.max(fardTotalToday,1))*50 +
            (sunnahDoneToday/5)*20 +
            (habitsCount/4)*20 +
            quranScore*10
        );

        // Rings — adjusted for compact SVG (r=88→circumf≈553, r=68→≈427)
        const fardRing = document.getElementById('fardRing');
        const sunnahRing = document.getElementById('sunnahRing');
        if (fardRing)   fardRing.style.strokeDashoffset   = 553 - 553*(fardDoneToday/Math.max(fardTotalToday,1));
        if (sunnahRing) sunnahRing.style.strokeDashoffset = 427 - 427*Math.min(sunnahDoneToday/5,1);

        const pPct = document.getElementById('performancePct');
        const pLabel = document.getElementById('performanceLabel');
        if (pPct) pPct.textContent = Math.min(dailyPerf,100)+'%';
        if (pLabel) {
            let lbl = 'سعيٌ طيِّب';
            if (dailyPerf>=30) lbl = 'أنتَ في الطريق';
            if (dailyPerf>=55) lbl = 'قُربٌ جميل';
            if (dailyPerf>=75) lbl = 'نورٌ على نور';
            if (dailyPerf>=90) lbl = 'رُوحٌ وريحان ✨';
            pLabel.textContent = lbl;
        }

        const setEl = (id,val) => { const e=document.getElementById(id); if(e) e.textContent=val; };
        const setW  = (id,pct) => { const e=document.getElementById(id); if(e) e.style.width=pct+'%'; };

        setEl('todayFardCount', `${fardDoneToday}/${fardTotalToday}`);
        setW('todayFardBar', fardDoneToday/Math.max(fardTotalToday,1)*100);
        setEl('todaySunnahCount', sunnahDoneToday);
        setW('todaySunnahBar', Math.min(sunnahDoneToday/5*100,100));
        setEl('todayHabitsCount', `${habitsCount}/4`);
        setW('todayHabitsBar', habitsCount/4*100);

        setEl('monthFard', totalFard);
        setEl('monthSunnah', totalSunnah);
        setEl('monthTaraweeh', totalTaraweeh+totalQiyam);
        const score = Math.round(
            (totalFard/(daysTracked*5))*50 +
            (totalSunnah/(daysTracked*5))*20 +
            ((totalTaraweeh+totalQiyam)/(daysTracked*2))*20 +
            Math.min(totalQ/(daysTracked*10),1)*10
        );
        setEl('monthScore', Math.min(score,100)+'%');

        const cQ = totalQ % 604;
        const kBar = document.getElementById('khatmaBar');
        if (kBar) kBar.style.width = (cQ/604*100)+'%';
        setEl('currentPages', cQ);
        setEl('remainingPages', 604-cQ);
        setEl('totalPagesAll', totalQ);
        const kLabel = document.getElementById('khatmaLabel');
        if (kLabel) { const j=Math.floor(totalQ/20)+1; kLabel.textContent=`الجزء ${j<=30?j:'30+'}`; }

        // Streak
        let streak=0;
        const dates=Object.keys(appData).sort().reverse();
        for (const d of dates) {
            const fc=Object.keys(PRAYERS_CONFIG).filter(k=>PRAYERS_CONFIG[k].fard&&appData[d].prayers?.[k]?.fard).length;
            if (fc>=3) streak++; else break;
        }
        setEl('streakCount', streak);
    }

    /* ── Quran log mode ── */
    let quranLogMode='pages', selectedJuz=new Set();

    window.setQuranLogMode = (mode) => {
        quranLogMode = mode;
        const m = currentTheme==='male';
        const pageBtn  = document.getElementById('qlog-pages-btn');
        const juzBtn   = document.getElementById('qlog-juz-btn');
        const pageMode = document.getElementById('qlog-pages-mode');
        const juzMode  = document.getElementById('qlog-juz-mode');
        const active   = m ? ['bg-amber-500','text-black'] : ['bg-fuchsia-500','text-white'];
        const inactive = ['text-white/38'];
        if (mode==='pages') {
            pageBtn?.classList.remove(...inactive); pageBtn?.classList.add(...active);
            juzBtn?.classList.add(...inactive);     juzBtn?.classList.remove(...active);
            pageMode?.classList.remove('hidden');   juzMode?.classList.add('hidden');
        } else {
            juzBtn?.classList.remove(...inactive);  juzBtn?.classList.add(...active);
            pageBtn?.classList.add(...inactive);    pageBtn?.classList.remove(...active);
            juzMode?.classList.remove('hidden');    pageMode?.classList.add('hidden');
            renderJuzGrid();
        }
    };

    window.adjustQuranPages = (delta) => {
        const inp = document.getElementById('quranLogPages') || document.getElementById('quranInput');
        if (!inp) return;
        inp.value = Math.max(0, (parseInt(inp.value)||0) + delta);
        markUnsaved();
    };

    function renderJuzGrid() {
        const grid = document.getElementById('juzGrid');
        if (!grid) return;
        const m = currentTheme==='male';
        selectedJuz = new Set(appData[currentDate]?.juz||[]);
        grid.innerHTML = '';
        for (let i=1;i<=30;i++) {
            const done = selectedJuz.has(i);
            const btn = document.createElement('button');
            btn.className = `juz-btn ${done?(m?'done-m':'done-f'):''}`;
            btn.textContent = i;
            btn.onclick = () => {
                if (selectedJuz.has(i)) selectedJuz.delete(i); else selectedJuz.add(i);
                const totalPages = selectedJuz.size * 20;
                if (!appData[currentDate]) appData[currentDate]={};
                appData[currentDate].quran = totalPages;
                appData[currentDate].juz   = [...selectedJuz];
                markUnsaved();
                renderJuzGrid();
                const lbl = document.getElementById('juzSumLabel');
                if (lbl) lbl.textContent = `= ${totalPages} صفحة`;
            };
            grid.appendChild(btn);
        }
        const tp = selectedJuz.size*20;
        const lbl = document.getElementById('juzSumLabel');
        if (lbl) lbl.textContent = `= ${tp} صفحة`;
    }

    /* ── Azkar ── */
    let currentAzkarTab='sabah', azkarProgress={};

    window.switchAzkarTab = (tab) => {
        currentAzkarTab = tab;
        const m = currentTheme==='male';
        const sabah = document.getElementById('azkar-tab-sabah');
        const masaa = document.getElementById('azkar-tab-masaa');
        if (tab==='sabah') { sabah?.classList.add(m?'active-m':'active-f'); masaa?.classList.remove('active-m','active-f'); }
        else               { masaa?.classList.add(m?'active-m':'active-f'); sabah?.classList.remove('active-m','active-f'); }
        renderAzkarList(tab);
    };

    function renderAzkarList(tab) {
        const list = document.getElementById('azkarList');
        if (!list) return;
        const data = tab==='sabah' ? AZKAR_SABAH : AZKAR_MASAA;
        const m = currentTheme==='male';
        const accentColor = m ? '#fbbf24' : '#f0abfc';
        const accentText  = m ? 'text-amber-400' : 'text-fuchsia-400';
        const doneBg     = m ? 'rgba(251,191,36,0.1)' : 'rgba(217,70,239,0.08)';
        const doneBorder = m ? 'rgba(251,191,36,0.42)' : 'rgba(217,70,239,0.38)';

        const doneCount = data.filter((_,i) => (azkarProgress[`${tab}-${i}`]||0) >= data[i].count).length;
        const hdr = document.getElementById('azkarProgressText');
        if (hdr) hdr.textContent = `${doneCount}/${data.length}`;

        // Build HTML via array join (faster than repeated innerHTML +=)
        const html = data.map((item, idx) => {
            const key = `${tab}-${idx}`;
            const progress = azkarProgress[key]||0;
            const isDone = progress >= item.count;
            const pct = item.count>1 ? Math.round(progress/item.count*100) : (isDone?100:0);
            return `<div class="azkar-item" style="${isDone ? `background:${doneBg};border-color:${doneBorder};` : ''}">
                <p class="font-amiri text-xl text-white leading-[1.95] text-right mb-3">${item.text}</p>
                <div class="flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 flex-wrap">
                        ${item.src ? `<span class="text-[10px] text-white/22 font-kufi border border-white/8 px-1.5 py-0.5 rounded">${item.src}</span>` : ''}
                        <span class="text-xs ${accentText}/65 font-kufi font-bold">${item.label}</span>
                    </div>
                    <button onclick="window.tapAzkar('${tab}',${idx},${item.count})"
                        class="flex items-center gap-1.5 px-4 py-2 rounded-xl font-bold font-kufi text-sm transition-transform active:scale-90 flex-shrink-0"
                        style="${isDone
                            ? `background:${accentColor};color:#000;box-shadow:0 3px 12px ${accentColor}44;`
                            : 'background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.55);border:1px solid rgba(255,255,255,0.09);'}">
                        ${isDone ? '<i class="fas fa-check text-sm"></i>'
                            : progress > 0 ? `<span>${progress}/${item.count}</span>`
                            : '<span>ابدأ</span>'}
                    </button>
                </div>
                ${item.count>1 && progress>0 && !isDone ? `
                <div class="mt-2 h-1 bg-white/8 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-300" style="width:${pct}%;background:${accentColor}"></div>
                </div>` : ''}
            </div>`;
        }).join('');
        list.innerHTML = html;
    }

    window.tapAzkar = (tab, idx, total) => {
        const key = `${tab}-${idx}`;
        const cur = azkarProgress[key]||0;
        if (cur < total) {
            azkarProgress[key] = cur+1;
            if (azkarProgress[key] >= total) confetti({particleCount:55,spread:55,origin:{y:0.6},colors:['#fbbf24','#4ade80','#fff']});
        } else {
            azkarProgress[key] = 0;
        }
        renderAzkarList(tab);
    };

    window.markAllAzkarDone = () => {
        const data = currentAzkarTab==='sabah' ? AZKAR_SABAH : AZKAR_MASAA;
        data.forEach((item,idx) => { azkarProgress[`${currentAzkarTab}-${idx}`] = item.count; });
        const habitId = currentAzkarTab==='sabah'
            ? (currentTheme==='male'?'m_morning':'f_morning')
            : (currentTheme==='male'?'m_evening':'f_evening');
        if (!appData[currentDate]) appData[currentDate]={};
        appData[currentDate][habitId] = true;
        markUnsaved(); autoSave(); updateUI();
        confetti({particleCount:140,spread:78,origin:{y:0.5},colors:['#fbbf24','#4ade80','#f0abfc']});
        showToast('أحسنت! بارك الله في ذكرك ✨');
        renderAzkarList(currentAzkarTab);
    };

    /* ── Lessons ── */
    window.addLesson = () => {
        const inp = document.getElementById('lessonInput');
        const text = inp?.value?.trim();
        if (!text) return;
        if (!appData[currentDate]) appData[currentDate]={};
        if (!appData[currentDate].lessons) appData[currentDate].lessons=[];
        appData[currentDate].lessons.push({ text, time: new Date().toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}) });
        inp.value='';
        markUnsaved();
        renderLessonsList();
        autoSave();
    };

    window.removeLesson = (idx) => {
        if (!appData[currentDate]?.lessons) return;
        appData[currentDate].lessons.splice(idx,1);
        markUnsaved();
        renderLessonsList();
        autoSave();
    };

    function renderLessonsList() {
        const listEl   = document.getElementById('lessonsList');
        const countEl  = document.getElementById('lessonsCount');
        if (!listEl) return;
        const lessons = appData[currentDate]?.lessons||[];
        if (countEl) countEl.textContent = lessons.length+' درس';
        const m = currentTheme==='male';
        if (!lessons.length) {
            listEl.innerHTML=`<p class="text-xs text-white/22 text-center font-amiri py-1.5">لم تسجّل دروساً بعد</p>`;
            return;
        }
        listEl.innerHTML = lessons.map((l,i)=>`
            <div class="flex items-center gap-2 bg-black/22 rounded-xl px-3 py-2.5 border border-white/5">
                <i class="fas fa-podcast ${m?'text-amber-400':'text-fuchsia-400'} text-xs flex-shrink-0"></i>
                <span class="flex-1 text-sm font-amiri text-white/88 text-right leading-snug">${l.text}</span>
                <span class="text-[10px] text-white/22 font-kufi flex-shrink-0">${l.time||''}</span>
                <button onclick="window.removeLesson(${i})" class="opacity-38 active:opacity-100 transition-opacity active:scale-88 flex-shrink-0 p-1">
                    <i class="fas fa-times text-red-400 text-xs"></i>
                </button>
            </div>`).join('');
    }

    /* ── Save ── */
    window.saveData = async () => {
        const qi = document.getElementById('quranInput') || document.getElementById('quranLogPages');
        const wi = document.getElementById('workInput');
        const quran = parseInt(qi?.value)||(appData[currentDate]?.quran||0);
        const work  = parseFloat(wi?.value)||0;

        if (!appData[currentDate]) appData[currentDate]={};
        appData[currentDate].quran = quran;
        appData[currentDate].work  = work;

        const btn = document.getElementById('saveBtn');
        if (btn) { btn.textContent='⏳ يُسجَّل سعيُك..'; btn.disabled=true; }

        try {
            await updateDoc(doc(db,"users",currentUser),{ appData });
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
            showToast('تقبل الله منك صالح الأعمال ✨');
            if (quran>0) confetti({particleCount:110,spread:65,origin:{y:0.7},colors:['#fbbf24','#f59e0b','#fff']});
            markSaved();
        } catch {
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
            showToast('تم الحفظ على الجهاز بنجاح ✓');
            markSaved();
        } finally {
            if (btn) {
                btn.textContent = currentTheme==='male' ? '💾 حفظ يومياتي' : '✨ حفظ يومياتي';
                btn.disabled = false;
            }
            updateUI();
        }
    };

    window.goHome = () => {
        if (confirm('هل تود العودة لتغيير الاسم أو النمط؟')) {
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('welcomeScreen').style.display='flex';
        }
    };
    window.resetData = () => {
        if (confirm('تحذير: سيتم حذف كافة سجلاتك نهائياً. هل أنت متأكد؟')) {
            localStorage.clear(); location.reload();
        }
    };

    /* ── App load ── */
    function loadApp() {
        const container = document.getElementById('app-container');
        document.body.className = `min-h-dvh text-zinc-100 theme-${currentTheme}`;
        container.innerHTML = currentTheme==='male' ? getMaleTemplate() : getFemaleTemplate();
        initPrayersUI();
        updateUI();
        document.getElementById('loadingScreen')?.classList.add('hidden');
        container.classList.remove('hidden');
        // rAF to avoid FCP block
        requestAnimationFrame(() => container.classList.add('opacity-100'));
    }

    function init() {
        if (currentUser) fetchData();
        else {
            document.getElementById('loadingScreen')?.classList.add('hidden');
            document.getElementById('welcomeScreen').style.display='flex';
        }
    }

    /* ══════════════════════════════════
       PRAYER TIMES
    ══════════════════════════════════ */
    const CITIES = {
        cairo:    { lat:30.0444, lng:31.2357, name:'القاهرة'    },
        alex:     { lat:31.2001, lng:29.9187, name:'الإسكندرية' },
        mansoura: { lat:31.0409, lng:31.3785, name:'المنصورة'   },
    };
    let selectedCity='cairo', iftarTimerInterval=null;

    function calcPrayerTimes(lat,lng,dateObj) {
        const rad=d=>d*Math.PI/180, deg=r=>r*180/Math.PI;
        const Y=dateObj.getFullYear(), M=dateObj.getMonth()+1, D=dateObj.getDate();
        const JD=(367*Y)-Math.floor(7*(Y+Math.floor((M+9)/12))/4)+Math.floor(275*M/9)+D+1721013.5+0.5-lng/360;
        const d2=JD-2451545.0;
        const g=rad(357.529+0.98560028*d2);
        const q=280.459+0.98564736*d2;
        const L=rad(q+1.915*Math.sin(g)+0.020*Math.sin(2*g));
        const e=rad(23.439-0.00000036*d2);
        const RA=deg(Math.atan2(Math.cos(e)*Math.sin(L),Math.cos(L)))/15;
        const decl=deg(Math.asin(Math.sin(e)*Math.sin(L)));
        const EqT=q/15-(RA-24*Math.floor(RA/24));
        const transit=12+2-lng/15-EqT;
        const ha=angle=>{ const cosH=(Math.sin(rad(angle))-Math.sin(rad(lat))*Math.sin(rad(decl)))/(Math.cos(rad(lat))*Math.cos(rad(decl))); return Math.abs(cosH)>1?NaN:deg(Math.acos(cosH))/15; };
        const asrHA=()=>ha(-deg(Math.atan(1/(1+Math.tan(rad(Math.abs(lat-decl)))))));
        const fmt=h=>{ if(isNaN(h)) return '--:--'; h=((h%24)+24)%24; const hh=Math.floor(h),mm=Math.round((h-hh)*60); const hF=mm===60?(hh+1)%24:hh, mF=mm===60?0:mm; return `${hF%12||12}:${String(mF).padStart(2,'0')} ${hF>=12?'م':'ص'}`; };
        return {
            fajr:    {fmt:fmt(transit-ha(-19.5)),   raw:transit-ha(-19.5)  },
            sunrise: {fmt:fmt(transit-ha(-0.8333)), raw:transit-ha(-0.8333)},
            dhuhr:   {fmt:fmt(transit),              raw:transit            },
            asr:     {fmt:fmt(transit+asrHA()),      raw:transit+asrHA()    },
            maghrib: {fmt:fmt(transit+ha(-0.8333)), raw:transit+ha(-0.8333)},
            isha:    {fmt:fmt(transit+ha(-17.5)),   raw:transit+ha(-17.5)  },
        };
    }

    function renderPrayerTimes(city) {
        const c=CITIES[city], now=new Date();
        const times=calcPrayerTimes(c.lat,c.lng,now);
        ['fajr','sunrise','dhuhr','asr','maghrib','isha'].forEach(k => {
            const el = document.getElementById(`az-${k}`);
            if (el) el.textContent = times[k].fmt;
        });
        const dl=document.getElementById('azanDateLabel');
        if (dl) dl.textContent=now.toLocaleDateString('ar-EG',{weekday:'long',day:'numeric',month:'long'});
        startIftarCountdown(times.maghrib.raw);
    }

    function startIftarCountdown(maghribRaw) {
        if (iftarTimerInterval) clearInterval(iftarTimerInterval);
        const cdEl=document.getElementById('iftarCountdown');
        const cdText=document.getElementById('iftarCountdownText');
        if (!cdEl||!cdText) return;
        function tick() {
            const now=new Date();
            const nowH=now.getHours()+now.getMinutes()/60+now.getSeconds()/3600;
            const diff=maghribRaw-nowH;
            if (diff>0&&diff<12) {
                const s=Math.round(diff*3600), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
                cdEl.classList.remove('hidden');
                cdText.textContent=h>0?`متبقي للإفطار: ${h} س ${m} د`:`متبقي للإفطار: ${m} د ${sec} ث`;
            } else if (diff<=0&&diff>-0.5) {
                cdEl.classList.remove('hidden');
                cdText.textContent='🌅 حان وقت الإفطار! أَفْطِرْ هَنِيئاً مريئاً';
            } else { cdEl.classList.add('hidden'); }
        }
        tick();
        iftarTimerInterval = setInterval(tick, 1000);
    }

    window.selectCity = (city) => {
        selectedCity=city;
        const m=currentTheme==='male';
        const active=m?['bg-amber-500','text-black','shadow-sm']:['bg-fuchsia-500','text-white','shadow-sm'];
        ['cairo','alex','mansoura'].forEach(c => {
            const tab=document.getElementById(`tab-${c}`);
            if (!tab) return;
            tab.classList.remove(...active,'text-white/38');
            if(c===city) tab.classList.add(...active); else tab.classList.add('text-white/38');
        });
        renderPrayerTimes(city);
    };

    /* ══════════════════════════════════
       QURAN READER
    ══════════════════════════════════ */
    let surahList=[], currentSurahNum=1, quranFontSize=26, quranInitialized=false;

    async function initQuran() {
        if (quranInitialized) return;
        const sel=document.getElementById('surahSelect');
        if (!sel||surahList.length) { quranInitialized=true; return; }
        try {
            const json=await (await fetch('https://api.alquran.cloud/v1/surah')).json();
            surahList=json.data;
            const frag=document.createDocumentFragment();
            surahList.forEach(s => {
                const opt=document.createElement('option');
                opt.value=s.number; opt.textContent=`${s.number}. ${s.name} — ${s.englishName}`;
                frag.appendChild(opt);
            });
            sel.appendChild(frag);
            quranInitialized=true;
            sel.value='1';
            window.loadSurah();
        } catch { showToast('تعذّر تحميل قائمة السور، تحقق من الإنترنت'); }
    }

    window.loadSurah = async () => {
        const sel=document.getElementById('surahSelect');
        if (!sel?.value) return;
        currentSurahNum=parseInt(sel.value);
        const loading=document.getElementById('quranLoading');
        const container=document.getElementById('quranContainer');
        const navBar=document.getElementById('quranNavBar');
        if(loading) loading.classList.remove('hidden');
        if(container) container.classList.add('hidden');
        if(navBar) navBar.classList.add('hidden');
        try {
            const json=await (await fetch(`https://api.alquran.cloud/v1/surah/${currentSurahNum}/ar.alafasy`)).json();
            const surah=json.data;
            if(loading) loading.classList.add('hidden');
            if(container) container.classList.remove('hidden');
            if(navBar) navBar.classList.remove('hidden');
            const nameEl=document.getElementById('surahNameAr');
            const countEl=document.getElementById('surahVerseCount');
            const infoEl=document.getElementById('surahInfo');
            if(infoEl) infoEl.classList.remove('hidden');
            if(nameEl) nameEl.textContent=surah.name;
            if(countEl) countEl.textContent=`${surah.numberOfAyahs} آية · ${surah.revelationType==='Meccan'?'مكية':'مدنية'}`;
            const bism=document.getElementById('bismillah');
            if(bism) bism.style.display=(currentSurahNum===1||currentSurahNum===9)?'none':'block';
            const versesEl=document.getElementById('quranVerses');
            if (versesEl) {
                versesEl.style.fontSize=quranFontSize+'px';
                const m=currentTheme==='male';
                const html=surah.ayahs.map(a=>`
                    <div class="pb-4 border-b border-white/4 last:border-0">
                        <p class="font-amiri text-white leading-[2.45] text-right mb-1">${a.text}</p>
                        <div class="flex justify-end">
                            <span class="text-xs px-2.5 py-0.5 rounded-full ${m?'bg-amber-500/8 text-amber-400/55':'bg-fuchsia-500/8 text-fuchsia-400/55'} font-amiri">﴿${toArabicNum(a.numberInSurah)}﴾</span>
                        </div>
                    </div>`).join('');
                versesEl.innerHTML=html;
            }
            const navLabel=document.getElementById('quranNavLabel');
            if(navLabel) navLabel.textContent=`${surah.name} (${currentSurahNum}/114)`;
            window.scrollTo({top:0,behavior:'smooth'});
        } catch { if(loading) loading.classList.add('hidden'); showToast('تعذّر تحميل السورة، تحقق من الإنترنت'); }
    };

    const toArabicNum=n=>String(n).replace(/\d/g,d=>'٠١٢٣٤٥٦٧٨٩'[d]);
    window.changeFontSize=delta=>{ quranFontSize=Math.max(18,Math.min(40,quranFontSize+delta*2)); const el=document.getElementById('quranVerses'); if(el) el.style.fontSize=quranFontSize+'px'; };
    window.nextSurah=()=>{ if(currentSurahNum<114){currentSurahNum++;const sel=document.getElementById('surahSelect');if(sel){sel.value=currentSurahNum;window.loadSurah();}} };
    window.prevSurah=()=>{ if(currentSurahNum>1){currentSurahNum--;const sel=document.getElementById('surahSelect');if(sel){sel.value=currentSurahNum;window.loadSurah();}} };
    window.copyDua=el=>{ const t=el.querySelector('p')?.textContent?.trim(); if(!t) return; navigator.clipboard.writeText(t).then(()=>showToast('تم نسخ الدعاء ✨')).catch(()=>showToast('الدعاء في قلبك 🤍')); };

    init();
</script>

<!-- NIGHT SKY — isolated IIFE, no layout impact -->
<script>
(function() {
    const canvas = document.getElementById('starCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d', { alpha: true });
    let stars=[], W=0, H=0, raf=null;

    function resize() {
        W = canvas.width  = window.innerWidth;
        H = canvas.height = window.innerHeight;
        buildStars();
    }

    function buildStars() {
        stars=[];
        // Cap at ~180 stars for perf on small screens
        const count = Math.min(Math.floor((W*H)/5000), 180);
        for (let i=0;i<count;i++) {
            stars.push({
                x:Math.random()*W, y:Math.random()*H*0.65,
                r:Math.random()*1.3+0.3, a:Math.random(),
                da:(Math.random()*0.007+0.002)*(Math.random()>.5?1:-1),
            });
        }
    }

    function draw() {
        ctx.clearRect(0,0,W,H);
        const isFemale=document.body.classList.contains('theme-female');
        stars.forEach(s => {
            s.a += s.da;
            if(s.a>1){s.a=1;s.da*=-1;}
            if(s.a<0.04){s.a=0.04;s.da*=-1;}
            ctx.beginPath();
            ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
            ctx.fillStyle=isFemale?`rgba(240,171,252,${s.a*.65})`:`rgba(255,238,195,${s.a*.72})`;
            ctx.fill();
            // Glow only for larger stars — batched to reduce draw calls
            if (s.r>1.0) {
                const grd=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*2.8);
                grd.addColorStop(0,isFemale?`rgba(240,171,252,${s.a*.13})`:`rgba(251,191,36,${s.a*.13})`);
                grd.addColorStop(1,'transparent');
                ctx.beginPath(); ctx.arc(s.x,s.y,s.r*2.8,0,Math.PI*2);
                ctx.fillStyle=grd; ctx.fill();
            }
        });
        raf=requestAnimationFrame(draw);
    }

    // Pause animation when tab hidden (saves battery)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) { cancelAnimationFrame(raf); }
        else { raf=requestAnimationFrame(draw); }
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(resize, 250); // debounce resize
    });

    resize();
    draw();

    function spawnShootingStar() {
        const el=document.createElement('div');
        el.className='shooting-star';
        const sx=Math.random()*window.innerWidth*.7+window.innerWidth*.15;
        const sy=Math.random()*window.innerHeight*.28+55;
        const dur=Math.random()*1400+900;
        el.style.cssText=`top:${sy}px;left:${sx}px;animation-duration:${dur}ms;`;
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), dur+80);
    }
    function scheduleShoot() {
        setTimeout(()=>{ spawnShootingStar(); scheduleShoot(); }, Math.random()*8000+6000);
    }
    scheduleShoot();
})();
</script>

</body>
</html>
