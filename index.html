<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>رفيق رمضان | رحلة روحانية</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&family=Reem+Kufi:wght@500;700&family=Alexandria:wght@400;500;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: { 'xs': '375px' },
                    colors: {
                        ramadan: { base: '#000000', surface: '#09090b', card: '#18181b', gold: '#fbbf24', teal: '#2dd4bf', rose: '#fb7185', accent: '#27272a' },
                        theme: { bg: '#1a0b33', surface: '#3b1f63', primary: '#d8b4fe', accent: '#f0abfc', gold: '#fcd34d', success: '#4ade80' }
                    },
                    fontFamily: {
                        sans: ['IBM Plex Sans Arabic', 'sans-serif'],
                        alexandria: ['Alexandria', 'sans-serif'],
                        kufi: ['Reem Kufi', 'sans-serif'],
                        amiri: ['Amiri', 'serif'],
                    },
                    animation: {
                        'swing-1': 'swing 4s ease-in-out infinite alternate',
                        'swing-2': 'swing 5s ease-in-out infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards',
                        'slow-glow': 'slowGlow 5s ease-in-out infinite',
                        'pulse-ring': 'pulseRing 1.5s ease-out forwards',
                        'pop': 'pop 0.35s cubic-bezier(0.34,1.56,0.64,1) forwards',
                    },
                    keyframes: {
                        swing: { '0%': { transform: 'rotate(-4deg)' }, '100%': { transform: 'rotate(4deg)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-12px)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(8px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slowGlow: { '0%, 100%': { opacity: '0.4' }, '50%': { opacity: '0.8' } },
                        pulseRing: { '0%': { transform: 'scale(1)', opacity: '1' }, '100%': { transform: 'scale(1.8)', opacity: '0' } },
                        pop: { '0%': { transform: 'scale(0.85)' }, '60%': { transform: 'scale(1.08)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { transition: background-color 0.8s ease; overscroll-behavior: none; }
        
        .theme-male { 
            background-color: #0f0a06; 
            background-image: radial-gradient(circle at top, rgba(251, 191, 36, 0.06) 0%, transparent 55%);
            font-family: 'IBM Plex Sans Arabic', sans-serif; 
        }
        .theme-female { 
            background-color: #150824; 
            background-image: radial-gradient(circle at top, rgba(240, 171, 252, 0.06) 0%, transparent 55%);
            font-family: 'Alexandria', sans-serif; 
        }
        
        /* Glass panels */
        .glass-panel { 
            background: rgba(20, 15, 10, 0.75); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(251, 191, 36, 0.15); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05); 
        }
        .glass-card { 
            background: rgba(30, 10, 50, 0.65); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(240, 171, 252, 0.15); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05); 
        }
        
        /* ═══ FIX 1: Prayer buttons with CLEAR done states ═══ */
        /* Male - Fard done = golden solid */
        .btn-fard-done { 
            background: linear-gradient(135deg, #f59e0b, #d97706) !important; 
            color: #000 !important; 
            font-weight: 800 !important;
            border: none !important; 
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.55) !important;
            transform: scale(1.02);
        }
        /* Male - Sunnah done = GREEN to differentiate clearly */
        .btn-sunnah-done { 
            background: linear-gradient(135deg, #16a34a, #15803d) !important; 
            color: #fff !important; 
            border: none !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 14px rgba(22, 163, 74, 0.5) !important;
            transform: scale(1.02);
        }
        /* Male - hover states for un-done buttons */
        .prayer-btn:not(.btn-fard-done):not(.btn-sunnah-done):not(.btn-fard-done-f):not(.btn-sunnah-done-f):hover {
            border-color: rgba(251,191,36,0.5) !important;
            color: rgba(255,255,255,0.7) !important;
        }
        
        /* Female - Fard done = fuchsia */
        .btn-fard-done-f { 
            background: linear-gradient(135deg, #d946ef, #a21caf) !important; 
            color: #fff !important; 
            font-weight: 800 !important;
            border: none !important; 
            box-shadow: 0 4px 16px rgba(217, 70, 239, 0.5) !important;
            transform: scale(1.02);
        }
        /* Female - Sunnah done = GREEN */
        .btn-sunnah-done-f { 
            background: linear-gradient(135deg, #16a34a, #15803d) !important; 
            color: #fff !important; 
            border: none !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 14px rgba(22, 163, 74, 0.5) !important;
            transform: scale(1.02);
        }

        /* ══ Sunnah check icon ══ */
        .sunnah-check {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Habit items */
        .habit-active-m { 
            background: linear-gradient(135deg, rgba(251,191,36,0.12), rgba(251,191,36,0.03)) !important; 
            border-color: rgba(251,191,36,0.55) !important; 
        }
        .habit-active-f { 
            background: linear-gradient(135deg, rgba(240,171,252,0.12), rgba(240,171,252,0.03)) !important; 
            border-color: rgba(240,171,252,0.55) !important; 
        }

        /* Night glow cards */
        .night-glow-card { 
            background: linear-gradient(160deg, rgba(35,25,12,0.95), rgba(10,5,0,1)); 
            border: 1px solid rgba(251,191,36,0.25); 
        }
        .night-glow-f-card { 
            background: linear-gradient(160deg, rgba(45,18,65,0.9), rgba(15,5,30,1)); 
            border: 1px solid rgba(240,171,252,0.25); 
        }
        
        /* Progress ring */
        .progress-ring circle { transition: stroke-dashoffset 2.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Lanterns */
        .lantern-svg { 
            position: absolute; top: -5px; width: 45px; height: 100px; z-index: 40; 
            filter: drop-shadow(0 0 12px rgba(251, 191, 36, 0.5)); opacity: 0.85; 
        }

        /* Toast */
        #toast { 
            position: fixed; bottom: 100px; left: 50%; 
            transform: translateX(-50%) translateY(20px); 
            z-index: 10000; opacity: 0; 
            transition: all 0.45s cubic-bezier(0.34, 1.56, 0.64, 1); 
            pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Dhikr bar */
        .dhikr-float { 
            background: rgba(12, 8, 4, 0.88); 
            backdrop-filter: blur(18px);
            border: 1px solid rgba(251,191,36,0.25);
            box-shadow: 0 8px 24px rgba(0,0,0,0.6), inset 0 0 20px rgba(251,191,36,0.04);
        }
        .theme-female .dhikr-float {
            background: rgba(18, 8, 28, 0.88);
            border: 1px solid rgba(240,171,252,0.25);
            box-shadow: 0 8px 24px rgba(0,0,0,0.6), inset 0 0 20px rgba(240,171,252,0.04);
        }

        /* Dhikr text transition */
        #dhikrText { transition: opacity 0.3s ease; }
        
        /* Input style */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        /* Save indicator dot */
        .unsaved-dot {
            width: 8px; height: 8px;
            background: #f87171;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(248,113,113,0.8);
            animation: blink 1.5s ease-in-out infinite;
        }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Sticky save bar */
        .sticky-save {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 45;
            transition: all 0.4s cubic-bezier(0.34,1.56,0.64,1);
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(20px);
        }
        .sticky-save.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }

        /* Prayer row enhanced */
        .prayer-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.06);
            background: rgba(0,0,0,0.25);
            transition: all 0.3s ease;
        }
        .prayer-row.row-done-m {
            background: rgba(251,191,36,0.06);
            border-color: rgba(251,191,36,0.2);
        }
        .prayer-row.row-done-f {
            background: rgba(240,171,252,0.06);
            border-color: rgba(240,171,252,0.2);
        }

        /* Prayer button base */
        .prayer-btn {
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            min-width: 68px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
            border: 1.5px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.35);
            background: rgba(0,0,0,0.3);
            position: relative;
        }
        .prayer-btn:active { transform: scale(0.9) !important; }

        /* ══ FIX 7: Performance section ══ */
        .perf-stat-card {
            background: rgba(0,0,0,0.35);
            border-radius: 16px;
            padding: 14px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .perf-stat-val {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'Amiri', serif;
            line-height: 1;
        }
        .perf-bar-wrap {
            height: 6px;
            background: rgba(255,255,255,0.07);
            border-radius: 99px;
            overflow: hidden;
            margin-top: 6px;
        }
        .perf-bar-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 1.2s cubic-bezier(0.4,0,0.2,1);
        }

        /* ══ FIX 4: Quran pages input in quran view ══ */
        .quran-page-input-wrap {
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        /* ══ FIX 5: Azkar page tabs ══ */
        .azkar-tab-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 14px;
            font-family: 'Reem Kufi', sans-serif;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            color: rgba(255,255,255,0.4);
            background: transparent;
            border: none;
        }
        .azkar-tab-btn.active-m {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
            box-shadow: 0 4px 16px rgba(245,158,11,0.35);
        }
        .azkar-tab-btn.active-f {
            background: linear-gradient(135deg, #d946ef, #7c3aed);
            color: #fff;
            box-shadow: 0 4px 16px rgba(217,70,239,0.35);
        }

        /* Azkar card */
        .azkar-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .azkar-item:active { transform: scale(0.98); }
        .azkar-counter-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Amiri', serif;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }
        .azkar-counter-btn:active { transform: scale(0.92); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(251,191,36,0.2); border-radius: 10px; }

        /* ══ RAMADAN NIGHT ATMOSPHERE ══ */
        #starCanvas {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }
        .crescent-moon {
            position: fixed; top: 68px; left: 18px;
            z-index: 2; pointer-events: none;
            animation: moonFloat 8s ease-in-out infinite;
            filter: drop-shadow(0 0 18px rgba(251,191,36,0.6)) drop-shadow(0 0 50px rgba(251,191,36,0.2));
        }
        .theme-female .crescent-moon {
            filter: drop-shadow(0 0 18px rgba(240,171,252,0.5)) drop-shadow(0 0 40px rgba(240,171,252,0.15));
        }
        @keyframes moonFloat {
            0%,100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(0deg); }
        }
        .kaaba-scene {
            position: fixed; bottom: 75px; left: 0; right: 0;
            z-index: 1; pointer-events: none; opacity: 0.08;
            transition: opacity 1s;
        }
        .theme-female .kaaba-scene { opacity: 0.055; }
        .bg-orb {
            position: fixed; border-radius: 50%;
            filter: blur(90px); pointer-events: none;
            z-index: 0; animation: orbPulse 12s ease-in-out infinite;
        }
        @keyframes orbPulse {
            0%,100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(1.12); }
        }
        .sparkle-star {
            position: fixed; pointer-events: none; z-index: 2;
            color: #fbbf24; font-size: 10px;
            animation: twinkle ease-in-out infinite;
        }
        .theme-female .sparkle-star { color: #f0abfc; }
        @keyframes twinkle {
            0%,100% { opacity: 0.08; transform: scale(0.7); }
            50% { opacity: 1; transform: scale(1.3); }
        }
        .shooting-star {
            position: fixed; pointer-events: none; z-index: 3;
            width: 1px; height: 1px;
            background: white; border-radius: 50%;
            opacity: 0;
            animation: shoot linear forwards;
        }
        @keyframes shoot {
            0%   { opacity: 0; }
            2%   { opacity: 1; }
            100% { opacity: 0; transform: translate(-280px, 160px) scaleX(80); }
        }
        #app-container { position: relative; z-index: 10; }

        /* ══ FIX 2: Taraweeh/Qiyam separate ══ */
        .taraweeh-qiyam-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .night-prayer-card {
            padding: 14px;
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.25s ease;
            user-select: none;
            text-align: center;
        }
        .night-prayer-card:active { transform: scale(0.95); }

        /* ══ Quran juz selector ══ */
        .juz-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            max-height: 220px;
            overflow-y: auto;
        }
        .juz-btn {
            padding: 8px 4px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            font-family: 'Amiri', serif;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1.5px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.3);
            color: rgba(255,255,255,0.5);
        }
        .juz-btn.done-m { background: linear-gradient(135deg,#f59e0b,#d97706); color:#000; border-color:transparent; }
        .juz-btn.done-f { background: linear-gradient(135deg,#d946ef,#7c3aed); color:#fff; border-color:transparent; }
        .juz-btn:active { transform: scale(0.92); }
    </style>
</head>
<body class="min-h-screen text-zinc-100 overflow-x-hidden">

<!-- NIGHT SKY -->
<canvas id="starCanvas"></canvas>
<div class="bg-orb" style="width:300px;height:300px;top:-80px;right:-60px;background:rgba(251,191,36,0.15);animation-delay:0s;"></div>
<div class="bg-orb" style="width:200px;height:200px;top:40%;left:-80px;background:rgba(251,191,36,0.08);animation-delay:4s;"></div>

<!-- CRESCENT MOON -->
<div class="crescent-moon">
    <svg width="52" height="52" viewBox="0 0 52 52" fill="none">
        <path d="M38 26C38 33.732 31.732 40 24 40C19.5 40 15.5 37.8 13 34.4C14.5 34.8 16 35 17.6 35C26.4 35 33.6 27.8 33.6 19C33.6 15.2 32.3 11.7 30.1 9C34.8 11.7 38 18.5 38 26Z" fill="#fbbf24" opacity="0.9"/>
        <circle cx="44" cy="10" r="1.5" fill="#fbbf24" opacity="0.8"><animate attributeName="opacity" values="0.3;1;0.3" dur="2.5s" repeatCount="indefinite"/></circle>
        <circle cx="48" cy="18" r="1" fill="#fbbf24" opacity="0.6"><animate attributeName="opacity" values="0.6;1;0.6" dur="3.2s" repeatCount="indefinite"/></circle>
    </svg>
</div>

<!-- SPARKLE STARS -->
<div class="sparkle-star" style="top:12%;left:15%;animation-duration:3.1s;font-size:8px;">✦</div>
<div class="sparkle-star" style="top:18%;right:20%;animation-duration:2.4s;font-size:6px;animation-delay:1s;">✦</div>
<div class="sparkle-star" style="top:8%;left:40%;animation-duration:4s;font-size:5px;animation-delay:0.5s;">★</div>
<div class="sparkle-star" style="top:22%;left:60%;animation-duration:2.8s;font-size:7px;animation-delay:1.8s;">✦</div>
<div class="sparkle-star" style="top:5%;right:35%;animation-duration:3.5s;font-size:9px;animation-delay:0.3s;">✧</div>
<div class="sparkle-star" style="top:15%;right:8%;animation-duration:2s;font-size:5px;animation-delay:2.2s;">✦</div>

<!-- KAABA SILHOUETTE -->
<div class="kaaba-scene">
    <svg width="100%" viewBox="0 0 800 220" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMax meet">
        <path d="M0 180 Q100 120 200 150 Q300 100 400 130 Q500 90 600 140 Q700 110 800 150 L800 220 L0 220 Z" fill="white" opacity="0.3"/>
        <rect x="0" y="200" width="800" height="20" fill="white" opacity="0.4"/>
        <rect x="100" y="60" width="14" height="140" fill="white"/><polygon points="107,40 100,65 114,65" fill="white"/><rect x="104" y="38" width="6" height="8" fill="white"/>
        <rect x="240" y="80" width="12" height="120" fill="white"/><polygon points="246,62 240,82 252,82" fill="white"/><rect x="243" y="60" width="6" height="8" fill="white"/>
        <rect x="548" y="80" width="12" height="120" fill="white"/><polygon points="554,62 548,82 560,82" fill="white"/><rect x="551" y="60" width="6" height="8" fill="white"/>
        <rect x="686" y="60" width="14" height="140" fill="white"/><polygon points="693,40 686,65 700,65" fill="white"/><rect x="690" y="38" width="6" height="8" fill="white"/>
        <rect x="330" y="100" width="140" height="110" fill="white"/>
        <rect x="330" y="100" width="140" height="18" fill="white" opacity="0.6"/>
        <rect x="385" y="148" width="30" height="62" fill="white" opacity="0.4"/>
        <ellipse cx="400" cy="98" rx="30" ry="12" fill="white" opacity="0.5"/>
        <rect x="170" y="155" width="460" height="55" fill="white" opacity="0.5"/>
    </svg>
</div>

<!-- GROUND MIST -->
<div class="fixed bottom-0 left-0 right-0 h-24 pointer-events-none z-[1]" style="background:linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 100%);"></div>

<!-- LANTERNS -->
<div class="fixed top-0 left-0 w-full h-32 pointer-events-none z-[65]">
    <div class="lantern-svg animate-swing-1" style="left: 7%;"><svg viewBox="0 0 50 100"><path d="M25 0 L25 25 M15 25 L35 25 L40 55 L25 75 L10 55 Z" fill="rgba(251,191,36,0.12)" stroke="#fbbf24" stroke-width="1.5"/><circle cx="25" cy="50" r="4" fill="#fbbf24" class="animate-pulse"/></svg></div>
    <div class="lantern-svg animate-swing-2 hidden md:block" style="left: 34%;"><svg viewBox="0 0 50 100"><path d="M25 0 L25 40 M10 40 L40 40 L45 70 L25 90 L5 70 Z" fill="rgba(251,191,36,0.12)" stroke="#fbbf24" stroke-width="2"/><circle cx="25" cy="65" r="3" fill="#fbbf24" class="animate-pulse"/></svg></div>
    <div class="lantern-svg animate-swing-1 hidden md:block" style="right: 34%;"><svg viewBox="0 0 50 100"><path d="M25 0 L25 40 M10 40 L40 40 L45 70 L25 90 L5 70 Z" fill="rgba(251,191,36,0.12)" stroke="#fbbf24" stroke-width="2"/><circle cx="25" cy="65" r="3" fill="#fbbf24" class="animate-pulse"/></svg></div>
    <div class="lantern-svg animate-swing-2" style="right: 7%;"><svg viewBox="0 0 50 100"><path d="M25 0 L25 25 M15 25 L35 25 L40 55 L25 75 L10 55 Z" fill="rgba(251,191,36,0.12)" stroke="#fbbf24" stroke-width="2"/><circle cx="25" cy="50" r="4" fill="#fbbf24" class="animate-pulse"/></svg></div>
</div>

<!-- LOADING SCREEN -->
<div id="loadingScreen" class="fixed inset-0 z-[200] bg-[#0a0604] flex flex-col items-center justify-center transition-opacity duration-700">
    <div class="w-16 h-16 border-4 border-zinc-900 border-t-amber-500 rounded-full animate-spin mb-6 shadow-[0_0_20px_rgba(251,191,36,0.3)]"></div>
    <p class="text-amber-500/80 text-lg font-amiri tracking-widest">سكونُ الطاعة..</p>
</div>

<!-- WELCOME SCREEN -->
<div id="welcomeScreen" class="fixed inset-0 z-[100] flex-col items-center justify-center p-5 hidden overflow-y-auto"
     style="display:none; background: radial-gradient(ellipse at 50% 20%, rgba(251,191,36,0.12) 0%, #0a0604 60%);">
    <div class="relative z-10 w-full max-w-sm mx-auto text-center py-8">
        <div class="relative inline-flex items-center justify-center mb-6">
            <div class="absolute w-36 h-36 bg-amber-400/15 blur-2xl rounded-full"></div>
            <div class="w-28 h-28 rounded-full bg-gradient-to-b from-[#2a1d08] to-[#0f0a04] border-2 border-amber-500/50 flex items-center justify-center shadow-[0_0_50px_rgba(251,191,36,0.3)] relative z-10 animate-float">
                <svg width="60" height="56" viewBox="0 0 60 56" fill="none">
                    <rect x="8" y="18" width="44" height="34" rx="1" fill="#fbbf24" opacity="0.9"/>
                    <rect x="8" y="18" width="44" height="8" fill="#f59e0b" opacity="0.7"/>
                    <rect x="8" y="22" width="44" height="2" fill="#fde68a" opacity="0.5"/>
                    <rect x="23" y="36" width="14" height="16" rx="1" fill="#92400e" opacity="0.8"/>
                    <polygon points="8,18 30,4 52,18" fill="#d97706" opacity="0.95"/>
                    <rect x="27" y="0" width="6" height="6" rx="1" fill="#fbbf24"/>
                </svg>
            </div>
        </div>
        <h1 class="text-5xl font-amiri font-bold text-white mb-2 leading-tight">رفيقُ رمضان</h1>
        <p class="text-amber-400/70 text-sm font-kufi mb-8 tracking-wide">أهلاً بك في رحلتك الروحانية · ١٤٤٦هـ</p>
        <div class="bg-[#110d06]/90 backdrop-blur-xl border border-amber-500/20 rounded-[2rem] p-6 space-y-6 shadow-[0_20px_60px_rgba(0,0,0,0.7)]">
            <div class="space-y-2 text-right">
                <label class="text-xs text-amber-500/80 font-bold font-kufi tracking-wider">اسمُك الكريم</label>
                <div class="relative">
                    <input type="text" id="setupName" placeholder="كيف نُناديك؟"
                        class="w-full bg-[#0a0604] border border-amber-500/25 rounded-2xl px-5 py-4 text-white text-center focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 transition-all font-bold text-xl font-amiri placeholder-zinc-700"
                        onkeydown="if(event.key==='Enter') window.finishSetup()">
                    <div class="absolute left-4 top-1/2 -translate-y-1/2 w-2 h-2 bg-amber-500 rounded-full opacity-50 animate-pulse"></div>
                </div>
            </div>
            <div class="space-y-3 text-right">
                <label class="text-xs text-amber-500/80 font-bold font-kufi tracking-wider">اختَر واجهتك</label>
                <div class="grid grid-cols-2 gap-3">
                    <div onclick="window.selectSetupTheme('male')" id="themeMale" class="setup-theme-card cursor-pointer rounded-2xl p-4 flex flex-col items-center gap-3 border-2 border-amber-500/40 bg-gradient-to-b from-[#1a120b] to-[#0a0604] transition-all active:scale-95 selected-male">
                        <div class="w-14 h-14 rounded-2xl bg-amber-500/15 flex items-center justify-center border border-amber-500/30">
                            <svg width="30" height="30" viewBox="0 0 30 30" fill="none"><circle cx="15" cy="8" r="5" fill="#fbbf24" opacity="0.9"/><path d="M6 26c0-5 4-9 9-9s9 4 9 9" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" fill="none" opacity="0.9"/><rect x="11" y="16" width="8" height="6" rx="2" fill="#fbbf24" opacity="0.7"/></svg>
                        </div>
                        <div><span class="text-base font-bold font-kufi text-white block">رجالي</span><span class="text-xs text-amber-400/50 font-amiri">ذهبي</span></div>
                    </div>
                    <div onclick="window.selectSetupTheme('female')" id="themeFemale" class="setup-theme-card cursor-pointer rounded-2xl p-4 flex flex-col items-center gap-3 border-2 border-fuchsia-500/25 bg-gradient-to-b from-[#150824] to-[#0a0604] transition-all active:scale-95">
                        <div class="w-14 h-14 rounded-2xl bg-fuchsia-500/15 flex items-center justify-center border border-fuchsia-500/30">
                            <svg width="30" height="30" viewBox="0 0 30 30" fill="none"><circle cx="15" cy="8" r="4.5" fill="#f0abfc" opacity="0.9"/><path d="M8 14 Q8 8 15 7 Q22 8 22 14 Q22 18 15 19 Q8 18 8 14Z" fill="#d946ef" opacity="0.7"/><path d="M7 26c0-5 4-8 8-8s8 3 8 8" stroke="#f0abfc" stroke-width="2.5" stroke-linecap="round" fill="none" opacity="0.9"/></svg>
                        </div>
                        <div><span class="text-base font-bold font-kufi text-white block">بناتي</span><span class="text-xs text-fuchsia-400/50 font-amiri">وردي</span></div>
                    </div>
                </div>
            </div>
            <button onclick="window.finishSetup()" class="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-black font-extrabold font-kufi py-4 rounded-2xl shadow-[0_0_25px_rgba(251,191,36,0.45)] transition-all active:scale-95 text-xl border-b-4 border-amber-700 mt-2">
                ابدأ الرحلةَ المباركة ✨
            </button>
        </div>
        <p class="text-white/20 text-xs font-amiri mt-6">رَمَضَانُ شَهْرُ الْقُرْآن</p>
    </div>
</div>

<style>
    .selected-male  { border-color: rgba(251,191,36,0.8) !important; box-shadow: 0 0 20px rgba(251,191,36,0.2); }
    .selected-female{ border-color: rgba(217,70,239,0.8) !important; box-shadow: 0 0 20px rgba(217,70,239,0.2); }
</style>

<!-- DHIKR BAR -->
<div class="fixed z-[70] pointer-events-none" style="top: 10px; left: 60px; right: 60px;">
    <div id="dhikrOverlay" class="dhikr-float mx-auto max-w-md rounded-2xl px-4 py-3 flex items-center justify-between relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/4 to-transparent animate-slow-glow"></div>
        <i class="fas fa-star-and-crescent text-amber-400/70 text-lg animate-pulse relative z-10 flex-shrink-0"></i>
        <div class="flex flex-col flex-grow px-3 relative z-10 text-center">
            <span id="dhikrText" class="text-xl font-bold font-amiri text-white leading-relaxed">لَا إِلَهَ إِلَّا اللَّه</span>
        </div>
        <i class="fas fa-star text-amber-400/70 text-base animate-pulse relative z-10 flex-shrink-0"></i>
    </div>
</div>

<!-- TOAST -->
<div id="toast" class="bg-[#1a120b]/95 backdrop-blur-xl text-amber-400 px-8 py-4 rounded-2xl shadow-[0_10px_30px_rgba(0,0,0,0.8)] border border-amber-500/30 font-bold text-lg font-kufi text-center whitespace-nowrap"></div>

<!-- STICKY SAVE -->
<div id="stickySave" class="sticky-save">
    <button onclick="window.saveData()" class="flex items-center gap-2 px-8 py-3 rounded-2xl font-bold font-kufi text-lg shadow-2xl backdrop-blur-xl transition-all active:scale-95" id="stickySaveBtn">
        <span class="unsaved-dot"></span>
        <span>حفظ التغييرات</span>
    </button>
</div>

<!-- APP CONTAINER -->
<div id="app-container" class="hidden opacity-0 transition-opacity duration-700 min-h-screen" style="padding-top: 80px;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBtHvklnxlP7ZgTvwJrpgMz4cbWiuhq9TM",
        authDomain: "create-project-36d4c.firebaseapp.com",
        projectId: "create-project-36d4c",
        storageBucket: "create-project-36d4c.firebasestorage.app",
        messagingSenderId: "384696044918",
        appId: "1:384696044918:web:f78daf55009be623b1fe57"
    };
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);

    const PRAYERS_CONFIG = {
        fajr:   { label: 'الفجر',   fard: true,  sunnah: true  },
        duha:   { label: 'الضحى',   fard: false, sunnah: true  },
        dhuhr:  { label: 'الظهر',   fard: true,  sunnah: true  },
        asr:    { label: 'العصر',   fard: true,  sunnah: false },
        maghrib:{ label: 'المغرب',  fard: true,  sunnah: true  },
        isha:   { label: 'العشاء',  fard: true,  sunnah: true  }
    };

    const PRAYER_ICONS = {
        fajr: 'fa-moon', duha: 'fa-sun', dhuhr: 'fa-circle-dot',
        asr: 'fa-sun', maghrib: 'fa-cloud', isha: 'fa-star-and-crescent'
    };

    const DHIKR_LIST = [
        "صَلِّ عَلَى مُحَمَّدٍ ﷺ",
        "لَا إِلَهَ إِلَّا اللَّه",
        "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ",
        "أَسْتَغْفِرُ اللَّهَ الْعَظِيم",
        "لَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللَّه",
        "اللَّهُمَّ إِنَّكَ عَفُوٌّ تُحِبُّ الْعَفْوَ فَاعْفُ عَنَّا",
        "اللَّهُمَّ بَلِّغْنَا لَيْلَةَ الْقَدْر"
    ];

    /* ══ AZKAR DATA ══ */
    const AZKAR_SABAH = [
        { text: "أَعُوذُ بِاللَّهِ السَّمِيعِ الْعَلِيمِ مِنَ الشَّيْطَانِ الرَّجِيمِ", count: 3, label: "3 مرات", src:"افتتاح" },
        { text: "اللَّهُمَّ بِكَ أَصْبَحْنَا وَبِكَ أَمْسَيْنَا وَبِكَ نَحْيَا وَبِكَ نَمُوتُ وَإِلَيْكَ النُّشُورُ", count: 1, label: "مرة واحدة", src:"أبو داود" },
        { text: "اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ", count: 1, label: "سيد الاستغفار", src:"البخاري" },
        { text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لَا إِلَهَ إِلَّا أَنْتَ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، وَأَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلَهَ إِلَّا أَنْتَ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "رَضِيتُ بِاللَّهِ رَبًّا وَبِالْإِسْلَامِ دِينًا وَبِمُحَمَّدٍ ﷺ نَبِيًّا", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ عِلْمًا نَافِعًا وَرِزْقًا طَيِّبًا وَعَمَلًا مُتَقَبَّلًا", count: 1, label: "مرة واحدة", src:"ابن ماجه" },
        { text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ", count: 100, label: "100 مرة", src:"مسلم" },
        { text: "لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ", count: 10, label: "10 مرات", src:"مسلم" },
        { text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، عَدَدَ خَلْقِهِ وَرِضَا نَفْسِهِ وَزِنَةَ عَرْشِهِ وَمِدَادَ كَلِمَاتِهِ", count: 3, label: "3 مرات", src:"مسلم" },
        { text: "اللَّهُمَّ صَلِّ وَسَلِّمْ وَبَارِكْ عَلَى نَبِيِّنَا مُحَمَّدٍ ﷺ", count: 10, label: "10 مرات", src:"السنة النبوية" },
        { text: "أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ", count: 3, label: "3 مرات", src:"مسلم" },
        { text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْهَمِّ وَالْحَزَنِ، وَأَعُوذُ بِكَ مِنَ الْعَجْزِ وَالْكَسَلِ، وَأَعُوذُ بِكَ مِنَ الْجُبْنِ وَالْبُخْلِ، وَأَعُوذُ بِكَ مِنْ غَلَبَةِ الدَّيْنِ وَقَهْرِ الرِّجَالِ", count: 1, label: "مرة واحدة", src:"البخاري" },
        { text: "حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ", count: 7, label: "7 مرات", src:"أبو داود" },
        { text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ هُوَ اللَّهُ أَحَدٌ، اللَّهُ الصَّمَدُ، لَمْ يَلِدْ وَلَمْ يُولَدْ، وَلَمْ يَكُنْ لَهُ كُفُوًا أَحَدٌ﴾", count: 3, label: "3 مرات · الإخلاص", src:"أبو داود" },
        { text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ…﴾ وَ ﴿قُلْ أَعُوذُ بِرَبِّ النَّاسِ…﴾", count: 3, label: "3 مرات · المعوذتان", src:"أبو داود" },
        { text: "آيَةُ الْكُرْسِيِّ — ﴿اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ…﴾", count: 1, label: "مرة واحدة", src:"البخاري" },
    ];

    const AZKAR_MASAA = [
        { text: "أَعُوذُ بِاللَّهِ السَّمِيعِ الْعَلِيمِ مِنَ الشَّيْطَانِ الرَّجِيمِ", count: 3, label: "3 مرات", src:"افتتاح" },
        { text: "اللَّهُمَّ بِكَ أَمْسَيْنَا وَبِكَ أَصْبَحْنَا وَبِكَ نَحْيَا وَبِكَ نَمُوتُ وَإِلَيْكَ الْمَصِيرُ", count: 1, label: "مرة واحدة", src:"أبو داود" },
        { text: "اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ", count: 1, label: "سيد الاستغفار", src:"البخاري" },
        { text: "أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ", count: 1, label: "مرة واحدة", src:"مسلم" },
        { text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لَا إِلَهَ إِلَّا أَنْتَ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، وَأَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلَهَ إِلَّا أَنْتَ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ", count: 3, label: "3 مرات", src:"أبو داود" },
        { text: "اللَّهُمَّ صَلِّ وَسَلِّمْ وَبَارِكْ عَلَى نَبِيِّنَا مُحَمَّدٍ ﷺ", count: 10, label: "10 مرات", src:"السنة" },
        { text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ", count: 100, label: "100 مرة", src:"مسلم" },
        { text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، عَدَدَ خَلْقِهِ وَرِضَا نَفْسِهِ وَزِنَةَ عَرْشِهِ وَمِدَادَ كَلِمَاتِهِ", count: 3, label: "3 مرات", src:"مسلم" },
        { text: "حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ", count: 7, label: "7 مرات", src:"أبو داود" },
        { text: "أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ", count: 3, label: "3 مرات", src:"مسلم" },
        { text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ هُوَ اللَّهُ أَحَدٌ…﴾", count: 3, label: "3 مرات · الإخلاص", src:"أبو داود" },
        { text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ ﴿قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ…﴾ وَ ﴿قُلْ أَعُوذُ بِرَبِّ النَّاسِ…﴾", count: 3, label: "3 مرات · المعوذتان", src:"أبو داود" },
        { text: "آيَةُ الْكُرْسِيِّ — ﴿اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ…﴾", count: 1, label: "مرة واحدة", src:"البخاري" },
        { text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْهَمِّ وَالْحَزَنِ، وَالْعَجْزِ وَالْكَسَلِ، وَالْجُبْنِ وَالْبُخْلِ، وَغَلَبَةِ الدَّيْنِ وَقَهْرِ الرِّجَالِ", count: 1, label: "مرة واحدة", src:"البخاري" },
        { text: "اللَّهُمَّ إِنَّكَ عَفُوٌّ تُحِبُّ الْعَفْوَ فَاعْفُ عَنِّي", count: 3, label: "3 مرات", src:"الترمذي" },
        { text: "اللَّهُمَّ قِنِي عَذَابَكَ يَوْمَ تَبْعَثُ عِبَادَكَ", count: 3, label: "3 مرات", src:"أبو داود" },
    ];

    const FOOTER_HTML = `
    <div class="mt-16 pb-10 pt-8 border-t border-white/8">
        <div class="text-center">
            <div class="text-xs tracking-[0.25em] uppercase text-white/25 font-sans">Devoted By Eng. Mahmoud Attia</div>
        </div>
    </div>`;

    let currentUser = localStorage.getItem('ramadanUserName');
    let currentTheme = localStorage.getItem('ramadanUserTheme') || 'male';
    let currentDate = new Date().toISOString().split('T')[0];
    let appData = {};
    let dhikrIndex = 0;
    let hasUnsavedChanges = false;
    let azkarCounters = {}; // tracks azkar tap counts per session

    /* ── Dhikr rotation with slide animation ── */
    function rotateDhikr() {
        const el = document.getElementById('dhikrText');
        if (!el) return;
        // Slide out to top
        el.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateY(-12px)';
        setTimeout(() => {
            dhikrIndex = (dhikrIndex + 1) % DHIKR_LIST.length;
            el.textContent = DHIKR_LIST[dhikrIndex];
            // Slide in from bottom
            el.style.transition = 'none';
            el.style.transform = 'translateY(10px)';
            el.style.opacity = '0';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    el.style.transition = 'opacity 0.45s ease, transform 0.45s ease';
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                });
            });
        }, 420);
    }
    setInterval(rotateDhikr, 4000);

    /* ── Toast ── */
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3200);
    }

    /* ── Unsaved indicator ── */
    function markUnsaved() {
        hasUnsavedChanges = true;
        const ss = document.getElementById('stickySave');
        if (ss) ss.classList.add('visible');
        const btn = document.getElementById('stickySaveBtn');
        if (btn) {
            if (currentTheme === 'male') {
                btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                btn.style.color = '#000';
                btn.style.border = 'none';
            } else {
                btn.style.background = 'linear-gradient(135deg, #d946ef, #7c3aed)';
                btn.style.color = '#fff';
                btn.style.border = 'none';
            }
        }
    }
    function markSaved() {
        hasUnsavedChanges = false;
        const ss = document.getElementById('stickySave');
        if (ss) ss.classList.remove('visible');
    }

    /* ── Firebase ── */
    async function fetchData() {
        try {
            const docRef = doc(db, "users", currentUser);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) appData = docSnap.data().appData || {};
            loadApp();
        } catch {
            appData = JSON.parse(localStorage.getItem('ramadanTrackerData_v5') || '{}');
            loadApp();
        }
    }

    /* ════════════════════════════════════
       FIX 7: PERFORMANCE HTML - Much richer
    ════════════════════════════════════ */
    function getPerformanceSectionHTML(isMale) {
        const accentColor = isMale ? '#fbbf24' : '#f0abfc';
        const ringColor = isMale ? '#fbbf24' : '#f0abfc';
        return `
        <div class="${isMale?'glass-panel':'glass-card'} rounded-3xl p-6 space-y-6 relative overflow-hidden">
            <div class="text-center relative z-10">
                <h3 class="text-2xl font-bold font-kufi text-white">${isMale?'إشراقات اليوم':'إشراقتكِ الروحية'}</h3>
                <div class="h-0.5 w-12 ${isMale?'bg-amber-500/40':'bg-fuchsia-500/40'} mx-auto rounded-full mt-2"></div>
            </div>

            <!-- Big ring + stats grid -->
            <div class="flex flex-col items-center gap-6">
                <!-- Ring -->
                <div class="relative w-48 h-48">
                    <div class="absolute inset-0 ${isMale?'bg-amber-500/8':'bg-fuchsia-500/8'} blur-[35px] rounded-full animate-slow-glow"></div>
                    <svg class="w-full h-full -rotate-90 relative z-10" viewBox="0 0 256 256">
                        <!-- bg track -->
                        <circle cx="128" cy="128" r="105" stroke="rgba(255,255,255,0.05)" stroke-width="18" fill="none"/>
                        <!-- fard ring -->
                        <circle id="fardRing" cx="128" cy="128" r="105" stroke="${ringColor}" stroke-width="18" fill="none"
                            stroke-dasharray="660" stroke-dashoffset="660" stroke-linecap="round" opacity="0.9"/>
                        <!-- sunnah inner ring -->
                        <circle cx="128" cy="128" r="82" stroke="rgba(255,255,255,0.03)" stroke-width="12" fill="none"/>
                        <circle id="sunnahRing" cx="128" cy="128" r="82" stroke="#4ade80" stroke-width="12" fill="none"
                            stroke-dasharray="515" stroke-dashoffset="515" stroke-linecap="round" opacity="0.85"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center z-20">
                        <span id="performancePct" class="text-5xl font-bold text-white font-kufi">0%</span>
                        <span id="performanceLabel" class="text-xs font-amiri ${isMale?'text-amber-400':'text-fuchsia-300'} mt-1">سعيٌ طيب</span>
                    </div>
                </div>

                <!-- Ring legend -->
                <div class="flex gap-4 text-xs font-kufi">
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-full" style="background:${accentColor}"></div>
                        <span class="text-white/50">الفروض</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        <span class="text-white/50">السنن</span>
                    </div>
                </div>
            </div>

            <!-- Stats cards row -->
            <div class="grid grid-cols-3 gap-3">
                <div class="perf-stat-card">
                    <div class="text-xs ${isMale?'text-amber-400/60':'text-fuchsia-300/60'} font-kufi mb-1">الفروض</div>
                    <div class="perf-stat-val ${isMale?'text-amber-400':'text-fuchsia-300'}" id="todayFardCount">0/5</div>
                    <div class="perf-bar-wrap"><div class="perf-bar-fill" style="background:${accentColor};width:0%" id="todayFardBar"></div></div>
                </div>
                <div class="perf-stat-card">
                    <div class="text-xs text-green-400/60 font-kufi mb-1">السنن</div>
                    <div class="perf-stat-val text-green-400" id="todaySunnahCount">0</div>
                    <div class="perf-bar-wrap"><div class="perf-bar-fill bg-green-400" style="width:0%" id="todaySunnahBar"></div></div>
                </div>
                <div class="perf-stat-card">
                    <div class="text-xs text-blue-400/60 font-kufi mb-1">الأذكار</div>
                    <div class="perf-stat-val text-blue-300" id="todayHabitsCount">0</div>
                    <div class="perf-bar-wrap"><div class="perf-bar-fill bg-blue-400" style="width:0%" id="todayHabitsBar"></div></div>
                </div>
            </div>

            <!-- Khatma progress -->
            <div class="${isMale?'bg-[#1a120b]':'bg-[#220d3a]'} p-5 rounded-2xl border ${isMale?'border-amber-500/10':'border-fuchsia-500/10'}">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm font-bold text-white/60 font-kufi">مسار ختمة القرآن</span>
                    <span id="khatmaLabel" class="text-xs font-bold ${isMale?'text-amber-400 bg-amber-500/10':'text-fuchsia-300 bg-fuchsia-500/10'} px-3 py-1 rounded-lg font-kufi">الجزء 1</span>
                </div>
                <div class="relative h-3 bg-black/50 rounded-full overflow-hidden border border-white/5 mb-3">
                    <div id="khatmaBar" class="absolute top-0 right-0 h-full rounded-full shadow-lg transition-all duration-1000" 
                        style="width:0%;background:${accentColor};box-shadow:0 0 12px ${accentColor}55"></div>
                </div>
                <div class="flex justify-between text-center">
                    <div>
                        <div class="text-xs ${isMale?'text-amber-400/50':'text-fuchsia-300/50'} font-kufi">قُرئت</div>
                        <div id="currentPages" class="text-2xl font-bold text-white font-amiri">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs ${isMale?'text-amber-400':'text-fuchsia-300'} font-kufi font-bold">المجموع</div>
                        <div id="totalPagesAll" class="text-lg font-bold ${isMale?'text-amber-400':'text-fuchsia-300'} font-amiri">0</div>
                    </div>
                    <div>
                        <div class="text-xs text-white/30 font-kufi">متبقي</div>
                        <div id="remainingPages" class="text-2xl font-bold text-white/40 font-amiri">604</div>
                    </div>
                </div>
            </div>

            <!-- Month Harvest inline -->
            <div>
                <div class="text-sm font-bold text-white/50 font-kufi mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-bar ${isMale?'text-amber-400':'text-fuchsia-400'} text-base"></i>
                    حصاد الشهر المبارك
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="${isMale?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${isMale?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                        <div class="text-3xl font-bold text-white font-amiri" id="monthFard">0</div>
                        <div class="text-xs ${isMale?'text-amber-400/70':'text-fuchsia-300/70'} mt-1 font-kufi">فروض مؤداة</div>
                    </div>
                    <div class="${isMale?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${isMale?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                        <div class="text-3xl font-bold text-white font-amiri" id="monthSunnah">0</div>
                        <div class="text-xs ${isMale?'text-amber-400/70':'text-fuchsia-300/70'} mt-1 font-kufi">سنن ونوافل</div>
                    </div>
                    <div class="${isMale?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${isMale?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                        <div class="text-3xl font-bold text-white font-amiri" id="monthTaraweeh">0</div>
                        <div class="text-xs ${isMale?'text-amber-400/70':'text-fuchsia-300/70'} mt-1 font-kufi">أيام التراويح</div>
                    </div>
                    <div class="bg-gradient-to-br ${isMale?'from-amber-500/15':'from-fuchsia-500/15'} to-transparent p-4 rounded-2xl border ${isMale?'border-amber-500/25':'border-fuchsia-500/25'} text-center">
                        <div class="text-3xl font-bold ${isMale?'text-amber-400':'text-fuchsia-400'} font-amiri" id="monthScore">0%</div>
                        <div class="text-xs ${isMale?'text-amber-400':'text-fuchsia-400'} mt-1 font-kufi font-bold">الالتزام العام</div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    /* ════════════════════════════════════
       FIX 2: Night Prayer (Taraweeh + Qiyam separate)
       FIX 3: Added Lesson/Podcast input
    ════════════════════════════════════ */
    function getHabitsAndInputsHTML(isMale) {
        const m = isMale;
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const accentBg = m ? 'bg-amber-500/10' : 'bg-fuchsia-500/10';
        const morningId = m ? 'm_morning' : 'f_morning';
        const eveningId = m ? 'm_evening' : 'f_evening';
        const taraweehId = m ? 'm_taraweeh' : 'f_taraweeh';
        const qiyamId = m ? 'm_qiyam' : 'f_qiyam';
        const panel = m ? 'glass-panel' : 'glass-card';
        const borderColor = m ? 'border-amber-500/15' : 'border-fuchsia-500/15';

        return `
        <!-- Habits -->
        <div class="${panel} rounded-3xl p-5 space-y-5">
            <div class="flex items-center gap-3 pb-3 border-b ${borderColor}">
                <i class="fas fa-gem text-xl ${accentText}"></i>
                <h3 class="font-bold text-xl font-kufi text-white">أذكارك ووِردك</h3>
            </div>
            <div class="space-y-3">
                <div id="${morningId}" onclick="window.toggleHabit('${morningId}')" class="prayer-row cursor-pointer select-none" role="button">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl ${accentBg} flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-cloud-sun ${accentText}"></i>
                        </div>
                        <span class="text-lg font-amiri font-bold text-white">أذكار الصباح</span>
                    </div>
                    <div class="check-circle w-9 h-9 rounded-full border-2 border-white/20 flex items-center justify-center transition-all flex-shrink-0">
                        <i class="fas fa-check text-sm opacity-0 text-black"></i>
                    </div>
                </div>
                <div id="${eveningId}" onclick="window.toggleHabit('${eveningId}')" class="prayer-row cursor-pointer select-none" role="button">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl ${accentBg} flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-moon ${accentText}"></i>
                        </div>
                        <span class="text-lg font-amiri font-bold text-white">أذكار المساء</span>
                    </div>
                    <div class="check-circle w-9 h-9 rounded-full border-2 border-white/20 flex items-center justify-center transition-all flex-shrink-0">
                        <i class="fas fa-check text-sm opacity-0 text-black"></i>
                    </div>
                </div>

                <!-- FIX 2: Taraweeh + Qiyam SEPARATED -->
                <div class="taraweeh-qiyam-grid">
                    <div id="${taraweehId}" onclick="window.toggleHabit('${taraweehId}')"
                        class="night-prayer-card border border-white/8 ${m?'bg-[#1a120b]':'bg-[#220d3a]'} select-none">
                        <div class="w-11 h-11 rounded-full ${accentBg} flex items-center justify-center">
                            <i class="fas fa-star-and-crescent ${accentText} text-lg"></i>
                        </div>
                        <span class="font-bold font-kufi text-white text-sm">التراويح</span>
                        <span class="text-[10px] ${accentText}/60 font-amiri">صلاة الجماعة</span>
                        <div id="${taraweehId}-check" class="w-7 h-7 rounded-full border-2 border-white/20 flex items-center justify-center transition-all">
                            <i class="fas fa-check text-xs opacity-0 text-black"></i>
                        </div>
                    </div>
                    <div id="${qiyamId}" onclick="window.toggleHabit('${qiyamId}')"
                        class="night-prayer-card border border-white/8 ${m?'bg-[#1a120b]':'bg-[#220d3a]'} select-none">
                        <div class="w-11 h-11 rounded-full bg-blue-500/10 flex items-center justify-center">
                            <i class="fas fa-moon text-blue-300 text-lg"></i>
                        </div>
                        <span class="font-bold font-kufi text-white text-sm">قيام الليل</span>
                        <span class="text-[10px] text-blue-300/60 font-amiri">صلاة في البيت</span>
                        <div id="${qiyamId}-check" class="w-7 h-7 rounded-full border-2 border-white/20 flex items-center justify-center transition-all">
                            <i class="fas fa-check text-xs opacity-0 text-black"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily log: pages + juz + work + lesson -->
        <div class="${panel} rounded-3xl p-5 space-y-4">
            <div class="flex items-center gap-3 pb-3 border-b ${borderColor}">
                <i class="fas fa-book-open text-xl ${accentText}"></i>
                <h3 class="font-bold text-xl font-kufi text-white">تسجيل اليوم</h3>
            </div>

            <!-- Row 1: Quran pages + Juz counter -->
            <div class="grid grid-cols-2 gap-3">
                <!-- Pages input -->
                <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                    <div class="text-xs font-bold ${accentText}/70 mb-2 font-kufi">صفحات القرآن</div>
                    <input type="number" id="quranInput" placeholder="0" inputmode="numeric"
                        class="w-full bg-transparent text-amber-300 text-4xl font-bold text-center focus:outline-none placeholder-zinc-800 font-amiri"
                        onchange="window.onInputChange(); window.syncJuzFromPages()" oninput="window.onInputChange(); window.syncJuzFromPages()">
                    <div class="text-xs text-white/20 mt-1 font-amiri">صفحة</div>
                </div>

                <!-- Juz counter -->
                <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'} text-center flex flex-col items-center justify-between gap-2">
                    <div class="text-xs font-bold ${accentText}/70 font-kufi">أجزاء قرأت</div>
                    <div class="flex items-center gap-2">
                        <button onclick="window.changeJuz(-1)"
                            class="w-9 h-9 rounded-xl font-bold text-xl leading-none active:scale-90 transition-all flex items-center justify-center shadow-inner ${m?'bg-amber-500/25 text-amber-300 border border-amber-500/30':'bg-fuchsia-500/25 text-fuchsia-300 border border-fuchsia-500/30'}">−</button>
                        <span id="juzCountDisplay" class="text-4xl font-bold text-amber-300 font-amiri w-10 text-center transition-transform duration-200">0</span>
                        <button onclick="window.changeJuz(1)"
                            class="w-9 h-9 rounded-xl font-bold text-xl leading-none active:scale-90 transition-all flex items-center justify-center shadow-inner ${m?'bg-amber-500/25 text-amber-300 border border-amber-500/30':'bg-fuchsia-500/25 text-fuchsia-300 border border-fuchsia-500/30'}">+</button>
                    </div>
                    <div class="text-xs text-white/20 font-amiri">جزء</div>
                </div>
            </div>

            <!-- Khatma mini progress - shows right here after quran input -->
            <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} px-4 py-3 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-white/40 font-kufi">تقدمك نحو الختمة</span>
                    <span id="dashKhatmaLabel" class="text-xs font-bold ${accentText} font-kufi">الجزء 1</span>
                </div>
                <div class="h-2 bg-black/40 rounded-full overflow-hidden">
                    <div id="dashKhatmaBar" class="h-full rounded-full transition-all duration-700" style="width:0%;background:${m?'#fbbf24':'#d946ef'};box-shadow:0 0 8px ${m?'#fbbf2466':'#d946ef66'}"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs font-amiri">
                    <span id="dashPagesRead" class="text-white/50">0 صفحة</span>
                    <span id="dashPagesLeft" class="${accentText}/70">فاضل <span id="dashPagesLeftNum">604</span> صفحة</span>
                </div>
            </div>

            <!-- Row 2: Work hours -->
            <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'} text-center">
                <div class="text-xs font-bold ${accentText}/70 mb-2 font-kufi">ساعات العمل / المذاكرة</div>
                <input type="number" id="workInput" placeholder="0" inputmode="decimal"
                    class="w-full bg-transparent text-amber-300 text-4xl font-bold text-center focus:outline-none placeholder-zinc-800 font-amiri"
                    onchange="window.onInputChange()" oninput="window.onInputChange()">
                <div class="text-xs text-white/20 mt-1 font-amiri">ساعة</div>
            </div>

            <!-- Row 3: Lessons list -->
            <div class="${m?'bg-[#1a120b]':'bg-[#220d3a]'} p-4 rounded-2xl border ${m?'border-amber-500/10':'border-fuchsia-500/10'}">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-headphones ${accentText} text-sm"></i>
                        <div class="text-xs font-bold ${accentText}/70 font-kufi">الدروس والبودكاست اليوم</div>
                    </div>
                    <span id="lessonsCount" class="text-xs ${accentText} bg-black/30 px-2 py-1 rounded-lg font-kufi font-bold">0 درس</span>
                </div>
                <!-- Input row -->
                <div class="flex gap-2 mb-3">
                    <input type="text" id="lessonInput" placeholder="اكتب الدرس أو البودكاست..."
                        class="flex-1 bg-black/30 border border-white/10 rounded-xl px-3 py-2.5 text-white text-sm focus:outline-none ${m?'focus:border-amber-500/40':'focus:border-fuchsia-500/40'} transition-all font-amiri placeholder-zinc-700 text-right"
                        onkeydown="if(event.key==='Enter') window.addLesson()">
                    <button onclick="window.addLesson()"
                        class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0 font-bold text-xl transition-all active:scale-90 ${m?'bg-amber-500 text-black':'bg-fuchsia-500 text-white'}">
                        +
                    </button>
                </div>
                <!-- Lessons list -->
                <div id="lessonsList" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
        </div>`;
    }

    /* ── Templates ── */
    function getMaleTemplate() {
        return `
        <header class="fixed bottom-0 left-0 right-0 z-50 bg-[#0f0a06]/96 backdrop-blur-2xl border-t border-amber-500/15 pb-safe shadow-[0_-8px_24px_rgba(0,0,0,0.7)]">
            <nav class="flex justify-around items-center max-w-md mx-auto font-kufi text-sm font-bold px-2 py-3">
                <button onclick="window.toggleView('dashboard')" id="nav-dashboard" class="nav-item active flex flex-col items-center gap-1 text-amber-500 transition-all min-w-[56px]">
                    <i class="fas fa-home text-xl"></i><span class="text-xs">الرئيسية</span>
                </button>
                <button onclick="window.toggleView('quran')" id="nav-quran" class="nav-item flex flex-col items-center gap-1 text-white/50 hover:text-white transition-all min-w-[56px]">
                    <i class="fas fa-book-quran text-xl"></i><span class="text-xs">القرآن</span>
                </button>
                <button onclick="window.toggleView('azkar')" id="nav-azkar" class="nav-item flex flex-col items-center gap-1 text-white/50 hover:text-white transition-all min-w-[56px]">
                    <i class="fas fa-hands-praying text-xl"></i><span class="text-xs">الأذكار</span>
                </button>
                <button onclick="window.toggleView('duaa')" id="nav-duaa" class="nav-item flex flex-col items-center gap-1 text-white/50 hover:text-white transition-all min-w-[56px]">
                    <i class="fas fa-kaaba text-xl"></i><span class="text-xs">الدعاء</span>
                </button>
                <div class="flex flex-col items-center gap-1 text-white/60 px-1">
                    <div class="flex items-center gap-1">
                        <i class="fas fa-fire text-amber-500 text-base"></i>
                        <span class="font-bold text-white font-amiri text-lg" id="streakCount">0</span>
                    </div>
                    <span class="text-[10px] text-white/30">يوم</span>
                </div>
            </nav>
        </header>

        <div id="dashboard-view" class="animate-fade-in px-4 max-w-lg mx-auto space-y-6 pb-36">
            <div class="text-center space-y-2 pt-2">
                <h2 class="text-3xl font-bold font-kufi text-white">مرحباً ${currentUser} 🌙</h2>
                <p class="text-amber-400/70 font-amiri text-base">تقبل الله طاعتك وصيامك</p>
            </div>

            <!-- Date Navigator -->
            <div class="flex items-center justify-between bg-[#1a120b]/80 border border-amber-500/20 rounded-2xl p-2 shadow-lg backdrop-blur-sm">
                <button onclick="window.changeDate(1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#2a1d13] text-amber-400 active:bg-[#3a2a1a] transition-all active:scale-90"><i class="fas fa-chevron-right text-sm"></i></button>
                <div class="text-center">
                    <span id="dateDisplay" class="font-bold text-base font-kufi text-white block">...</span>
                    <span id="dateTag" class="text-xs text-amber-500/60 font-amiri">اليوم</span>
                </div>
                <button onclick="window.changeDate(-1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#2a1d13] text-amber-400 active:bg-[#3a2a1a] transition-all active:scale-90"><i class="fas fa-chevron-left text-sm"></i></button>
            </div>

            <!-- Prayers -->
            <div class="glass-panel rounded-3xl p-5 space-y-5">
                <div class="flex items-center gap-3 pb-3 border-b border-amber-500/15">
                    <i class="fas fa-mosque text-xl text-amber-400"></i>
                    <h3 class="font-bold text-xl font-kufi text-white">الصلوات</h3>
                    <span id="prayerProgress" class="mr-auto text-xs font-bold text-amber-400/70 bg-amber-500/10 px-3 py-1 rounded-lg font-kufi">0/5 فروض</span>
                </div>
                <!-- Legend -->
                <div class="flex gap-3 text-xs font-kufi pb-1">
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div><span class="text-white/40">فرض مؤدى</span></div>
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-green-400"></div><span class="text-white/40">سنة مؤداة</span></div>
                </div>
                <div id="prayersList" class="space-y-3"></div>
            </div>

            ${getHabitsAndInputsHTML(true)}

            ${getPerformanceSectionHTML(true)}

            <button onclick="window.saveData()" id="saveBtn" class="w-full bg-amber-500 hover:bg-amber-400 active:bg-amber-600 text-black font-extrabold font-kufi py-5 rounded-2xl text-xl shadow-[0_5px_20px_rgba(251,191,36,0.35)] transition-all active:scale-95 border-b-4 border-amber-700">
                💾 حفظ يومياتي
            </button>

            <div class="flex justify-center gap-8 py-2">
                <button onclick="window.goHome()" class="text-sm text-white/40 hover:text-white transition-all font-kufi">تعديل الملف الشخصي</button>
                <button onclick="window.resetData()" class="text-sm text-red-500/50 hover:text-red-400 transition-all font-kufi">تصفير السجل</button>
            </div>
            ${FOOTER_HTML}
        </div>

        <!-- FIX 5: Azkar View -->
        ${getAzkarViewHTML(true)}

        <!-- Quran View -->
        ${getQuranViewHTML(true)}

        <!-- Duaa View -->
        ${getDuaaViewHTML(true)}`;
    }

    function getFemaleTemplate() {
        return `
        <header class="fixed bottom-0 left-0 right-0 z-50 bg-[#150824]/96 backdrop-blur-2xl border-t border-fuchsia-500/15 pb-safe shadow-[0_-8px_24px_rgba(0,0,0,0.7)]">
            <nav class="flex justify-around items-center max-w-md mx-auto font-kufi text-sm font-bold px-2 py-3">
                <button onclick="window.toggleView('dashboard')" id="nav-dashboard" class="nav-item active flex flex-col items-center gap-1 text-fuchsia-400 transition-all min-w-[56px]">
                    <i class="fas fa-home text-xl"></i><span class="text-xs">الرئيسية</span>
                </button>
                <button onclick="window.toggleView('quran')" id="nav-quran" class="nav-item flex flex-col items-center gap-1 text-white/50 hover:text-white transition-all min-w-[56px]">
                    <i class="fas fa-book-quran text-xl"></i><span class="text-xs">القرآن</span>
                </button>
                <button onclick="window.toggleView('azkar')" id="nav-azkar" class="nav-item flex flex-col items-center gap-1 text-white/50 hover:text-white transition-all min-w-[56px]">
                    <i class="fas fa-hands-praying text-xl"></i><span class="text-xs">الأذكار</span>
                </button>
                <button onclick="window.toggleView('duaa')" id="nav-duaa" class="nav-item flex flex-col items-center gap-1 text-white/50 hover:text-white transition-all min-w-[56px]">
                    <i class="fas fa-kaaba text-xl"></i><span class="text-xs">الدعاء</span>
                </button>
                <div class="flex flex-col items-center gap-1 text-white/60 px-1">
                    <div class="flex items-center gap-1">
                        <i class="fas fa-heart text-fuchsia-400 text-base"></i>
                        <span class="font-bold text-white font-amiri text-lg" id="streakCount">0</span>
                    </div>
                    <span class="text-[10px] text-white/30">يوم</span>
                </div>
            </nav>
        </header>

        <div id="dashboard-view" class="animate-fade-in px-4 max-w-lg mx-auto space-y-6 pb-36">
            <div class="text-center space-y-2 pt-2">
                <h2 class="text-3xl font-bold font-kufi text-white">أهلاً بكِ ${currentUser} ✨</h2>
                <p class="text-fuchsia-300/70 font-amiri text-base">نور الله قلبكِ وتقبل طاعتكِ</p>
            </div>

            <div class="flex items-center justify-between bg-[#220d3a]/80 border border-fuchsia-500/20 rounded-2xl p-2 shadow-lg backdrop-blur-sm">
                <button onclick="window.changeDate(1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#2d114d] text-fuchsia-300 active:bg-[#3a1663] transition-all active:scale-90"><i class="fas fa-chevron-right text-sm"></i></button>
                <div class="text-center">
                    <span id="dateDisplay" class="font-bold text-base font-kufi text-white block">...</span>
                    <span id="dateTag" class="text-xs text-fuchsia-400/60 font-amiri">اليوم</span>
                </div>
                <button onclick="window.changeDate(-1)" class="w-11 h-11 flex items-center justify-center rounded-xl bg-[#2d114d] text-fuchsia-300 active:bg-[#3a1663] transition-all active:scale-90"><i class="fas fa-chevron-left text-sm"></i></button>
            </div>

            <div class="glass-card rounded-3xl p-5 space-y-5">
                <div class="flex items-center gap-3 pb-3 border-b border-fuchsia-500/15">
                    <i class="fas fa-mosque text-xl text-fuchsia-400"></i>
                    <h3 class="font-bold text-xl font-kufi text-white">صلواتكِ اليوم</h3>
                    <span id="prayerProgress" class="mr-auto text-xs font-bold text-fuchsia-300/70 bg-fuchsia-500/10 px-3 py-1 rounded-lg font-kufi">0/5 فروض</span>
                </div>
                <div class="flex gap-3 text-xs font-kufi pb-1">
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-fuchsia-400"></div><span class="text-white/40">فرض مؤدى</span></div>
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-green-400"></div><span class="text-white/40">سنة مؤداة</span></div>
                </div>
                <div id="prayersList" class="space-y-3"></div>
            </div>

            ${getHabitsAndInputsHTML(false)}

            ${getPerformanceSectionHTML(false)}

            <button onclick="window.saveData()" id="saveBtn" class="w-full bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white font-extrabold font-kufi py-5 rounded-2xl text-xl shadow-[0_5px_20px_rgba(217,70,239,0.35)] transition-all active:scale-95 border-b-4 border-purple-900">
                ✨ حفظ يومياتي
            </button>

            <div class="flex justify-center gap-8 py-2">
                <button onclick="window.goHome()" class="text-sm text-white/40 hover:text-white transition-all font-kufi">إعدادات الملف الشخصي</button>
                <button onclick="window.resetData()" class="text-sm text-red-500/50 hover:text-red-400 transition-all font-kufi">تصفير السجل</button>
            </div>
            ${FOOTER_HTML}
        </div>

        ${getAzkarViewHTML(false)}
        ${getQuranViewHTML(false)}
        ${getDuaaViewHTML(false)}`;
    }

    /* ════════════════════════════════════
       FIX 5: AZKAR VIEW
    ════════════════════════════════════ */
    function getAzkarViewHTML(isMale) {
        const m = isMale;
        const panel = m ? 'glass-panel' : 'glass-card';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const borderColor = m ? 'border-amber-500/15' : 'border-fuchsia-500/15';

        return `
        <div id="azkar-view" class="hidden animate-fade-in pb-32 px-4 max-w-lg mx-auto space-y-4">
            <div class="text-center mt-4 mb-2 relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 ${m?'bg-amber-500/8':'bg-fuchsia-500/8'} blur-3xl rounded-full"></div>
                <i class="fas fa-hands-praying text-5xl ${accentText} mb-3 block animate-float relative z-10 drop-shadow-[0_0_25px_currentColor]"></i>
                <h2 class="text-3xl font-amiri font-bold text-white relative z-10">الأَذْكَارُ اليَوْمِيَّة</h2>
                <p class="text-sm font-kufi mt-1 relative z-10" id="azkarProgressWrap"><span class="text-white/30">أتممت </span><span id="azkarProgressText" class="font-bold text-white/70">0</span><span class="text-white/30"> من الأذكار</span></p>
                <div class="h-0.5 w-16 bg-gradient-to-r from-transparent ${m?'via-amber-500':'via-fuchsia-500'} to-transparent mx-auto rounded-full mt-2"></div>
            </div>

            <!-- Tab switcher -->
            <div class="${panel} rounded-2xl p-2">
                <div class="flex gap-2 bg-black/30 p-1.5 rounded-xl">
                    <button onclick="window.switchAzkarTab('sabah')" id="azkar-tab-sabah" class="azkar-tab-btn ${m?'active-m':'active-f'}">
                        🌅 أذكار الصباح
                    </button>
                    <button onclick="window.switchAzkarTab('masaa')" id="azkar-tab-masaa" class="azkar-tab-btn">
                        🌙 أذكار المساء
                    </button>
                </div>
            </div>

            <!-- Azkar list -->
            <div id="azkarList" class="${panel} rounded-3xl p-4 space-y-1">
                <!-- Filled by JS -->
            </div>

            <!-- Done all button -->
            <button onclick="window.markAllAzkarDone()" 
                class="w-full py-4 rounded-2xl font-bold font-kufi text-lg transition-all active:scale-95 ${m?'bg-amber-500 text-black border-b-4 border-amber-700':'bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white border-b-4 border-purple-900'}">
                ✅ أتممت الأذكار
            </button>

            ${FOOTER_HTML}
        </div>`;
    }

    /* ════════════════════════════════════
       FIX 4: QURAN VIEW with Juz/Pages toggle
    ════════════════════════════════════ */
    function getQuranViewHTML(isMale) {
        const m = isMale;
        const panel = m ? 'glass-panel' : 'glass-card';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const accentBorder = m ? 'border-amber-500/25' : 'border-fuchsia-500/25';

        return `
        <div id="quran-view" class="hidden animate-fade-in pb-32 px-4 max-w-lg mx-auto space-y-4">
            <div class="text-center mt-4 mb-2 relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 ${m?'bg-amber-500/8':'bg-fuchsia-500/8'} blur-3xl rounded-full"></div>
                <i class="fas fa-book-quran text-5xl ${accentText} drop-shadow-[0_0_25px_currentColor] mb-3 block animate-float relative z-10"></i>
                <h2 class="text-3xl font-amiri font-bold text-white relative z-10">القُرْآنُ الكَرِيم</h2>
                <div class="h-0.5 w-16 bg-gradient-to-r from-transparent ${m?'via-amber-500':'via-fuchsia-500'} to-transparent mx-auto rounded-full mt-2"></div>
            </div>

            <!-- FIX 4: Pages / Juz toggle for today's log -->
            <div class="${panel} rounded-3xl p-4 space-y-4">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fas fa-pencil-alt ${accentText} text-sm"></i>
                    <span class="text-sm font-bold font-kufi text-white/70">سجّل ما قرأته اليوم</span>
                </div>
                <!-- Mode tabs -->
                <div class="flex gap-2 bg-black/30 p-1 rounded-xl">
                    <button onclick="window.setQuranLogMode('pages')" id="qlog-pages-btn"
                        class="flex-1 py-2.5 rounded-lg font-kufi text-sm font-bold transition-all ${m?'bg-amber-500 text-black':'bg-fuchsia-500 text-white'} shadow-sm" >
                        صفحات
                    </button>
                    <button onclick="window.setQuranLogMode('juz')" id="qlog-juz-btn"
                        class="flex-1 py-2.5 rounded-lg font-kufi text-sm font-bold transition-all text-white/40">
                        أجزاء
                    </button>
                </div>

                <!-- Pages mode -->
                <div id="qlog-pages-mode">
                    <div class="flex items-center gap-4 bg-black/30 rounded-2xl p-4">
                        <button onclick="window.adjustQuranPages(-5)" class="w-10 h-10 rounded-xl bg-white/10 text-white font-bold text-lg active:scale-90 transition-all">-5</button>
                        <button onclick="window.adjustQuranPages(-1)" class="w-10 h-10 rounded-xl bg-white/10 text-white font-bold text-lg active:scale-90 transition-all">-1</button>
                        <div class="flex-1 text-center">
                            <input type="number" id="quranLogPages" placeholder="0" inputmode="numeric"
                                class="w-full bg-transparent text-white text-4xl font-bold text-center focus:outline-none placeholder-zinc-800 font-amiri"
                                onchange="window.onInputChange()" oninput="window.onInputChange()">
                            <div class="text-xs text-white/25 font-amiri">صفحة</div>
                        </div>
                        <button onclick="window.adjustQuranPages(1)" class="w-10 h-10 rounded-xl bg-white/10 text-white font-bold text-lg active:scale-90 transition-all">+1</button>
                        <button onclick="window.adjustQuranPages(5)" class="w-10 h-10 rounded-xl bg-white/10 text-white font-bold text-lg active:scale-90 transition-all">+5</button>
                    </div>
                </div>

                <!-- Juz mode -->
                <div id="qlog-juz-mode" class="hidden">
                    <p class="text-xs text-white/40 font-kufi mb-3 text-center">اضغط على الأجزاء اللي قرأتها اليوم</p>
                    <div class="juz-grid" id="juzGrid">
                        <!-- filled by JS -->
                    </div>
                    <p class="text-center text-xs ${accentText}/60 font-kufi mt-2" id="juzSumLabel">= 0 صفحة</p>
                </div>
            </div>

            <!-- Surah Reader -->
            <div class="${panel} rounded-3xl p-4 space-y-3">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fas fa-book-open ${accentText} text-sm"></i>
                    <span class="text-sm font-bold font-kufi text-white/70">تصفح السور</span>
                </div>
                <div class="flex gap-2">
                    <select id="surahSelect" onchange="window.loadSurah()"
                        class="flex-1 bg-black/50 border ${accentBorder} rounded-2xl px-4 py-3 text-white font-amiri text-base focus:outline-none transition-all appearance-none text-right cursor-pointer">
                        <option value="">اختر السورة...</option>
                    </select>
                    <div class="flex gap-2">
                        <button onclick="window.changeFontSize(-1)" class="w-11 h-11 rounded-xl bg-black/40 border ${accentBorder} ${accentText} font-bold text-lg active:scale-90 transition-all">ـ</button>
                        <button onclick="window.changeFontSize(1)"  class="w-11 h-11 rounded-xl bg-black/40 border ${accentBorder} ${accentText} font-bold text-lg active:scale-90 transition-all">+</button>
                    </div>
                </div>
                <div id="surahInfo" class="hidden flex items-center justify-between text-xs font-kufi px-1">
                    <span id="surahNameAr" class="${accentText} font-bold text-sm font-amiri"></span>
                    <span id="surahVerseCount" class="text-white/40"></span>
                </div>
            </div>

            <div id="quranLoading" class="hidden text-center py-12">
                <div class="w-10 h-10 border-3 ${m?'border-amber-500/30 border-t-amber-400':'border-fuchsia-500/30 border-t-fuchsia-400'} rounded-full animate-spin mx-auto mb-3"></div>
                <p class="${accentText}/60 font-amiri text-lg">جاري تحميل السورة...</p>
            </div>

            <div id="quranContainer" class="${panel} rounded-3xl p-5 hidden">
                <div id="bismillah" class="text-center mb-6 py-4 border-b ${m?'border-amber-500/15':'border-fuchsia-500/15'}">
                    <p class="font-amiri text-3xl ${m?'text-amber-300':'text-fuchsia-200'} leading-loose">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</p>
                </div>
                <div id="quranVerses" class="space-y-5 text-right leading-[2.8]" style="font-size: 26px;"></div>
            </div>

            <div id="quranNavBar" class="hidden ${panel} rounded-2xl p-3 flex items-center justify-between gap-2">
                <button onclick="window.prevSurah()" class="flex-shrink-0 w-10 h-10 rounded-xl ${m?'bg-amber-500/15 text-amber-400':'bg-fuchsia-500/15 text-fuchsia-400'} active:scale-90 transition-all text-sm font-bold">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <span id="quranNavLabel" class="text-xs text-white/50 font-kufi text-center flex-1">السورة</span>
                <button onclick="window.nextSurah()" class="flex-shrink-0 w-10 h-10 rounded-xl ${m?'bg-amber-500/15 text-amber-400':'bg-fuchsia-500/15 text-fuchsia-400'} active:scale-90 transition-all text-sm font-bold">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>`;
    }

    function getDuaaViewHTML(isMale) {
        const m = isMale;
        const panel = m ? 'glass-panel' : 'glass-card';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const borderColor = m ? 'border-amber-500/15' : 'border-fuchsia-500/15';
        const accentBg = m ? 'bg-amber-500/10' : 'bg-fuchsia-500/10';
        const accentBgBold = m ? 'bg-amber-500/15' : 'bg-fuchsia-500/15';
        const accentBorder = m ? 'border-amber-400/40' : 'border-fuchsia-400/40';
        const iftarText = m ? 'text-amber-300' : 'text-fuchsia-300';

        return `
        <div id="duaa-view" class="hidden animate-fade-in pb-32 px-4 max-w-lg mx-auto space-y-5">
            <div class="text-center mt-4 mb-2 relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 ${m?'bg-amber-500/10':'bg-fuchsia-500/10'} blur-3xl rounded-full"></div>
                <i class="fas fa-kaaba text-5xl ${accentText} drop-shadow-[0_0_25px_currentColor] mb-3 block animate-float relative z-10"></i>
                <h2 class="text-3xl font-amiri font-bold text-white relative z-10">دُعَاءٌ وَمُنَاجَاة</h2>
                <div class="h-0.5 w-16 bg-gradient-to-r from-transparent ${m?'via-amber-500':'via-fuchsia-500'} to-transparent mx-auto rounded-full mt-2"></div>
            </div>

            <!-- Prayer Times -->
            <div class="${panel} rounded-3xl p-5 space-y-4">
                <div class="flex items-center gap-3 pb-3 border-b ${borderColor}">
                    <i class="fas fa-mosque text-xl ${accentText}"></i>
                    <h3 class="font-bold text-xl font-kufi text-white">مَوَاقِيتُ الصَّلاَة</h3>
                    <span id="azanDateLabel" class="mr-auto text-xs ${accentText}/50 font-kufi"></span>
                </div>
                <div class="flex gap-2 bg-black/30 p-1 rounded-2xl">
                    <button onclick="window.selectCity('cairo')" id="tab-cairo" class="city-tab flex-1 py-2.5 rounded-xl font-kufi text-sm font-bold transition-all ${m?'bg-amber-500 text-black':'bg-fuchsia-500 text-white'} shadow-md">القاهرة</button>
                    <button onclick="window.selectCity('alex')" id="tab-alex" class="city-tab flex-1 py-2.5 rounded-xl font-kufi text-sm font-bold transition-all text-white/50 hover:text-white">الإسكندرية</button>
                    <button onclick="window.selectCity('mansoura')" id="tab-mansoura" class="city-tab flex-1 py-2.5 rounded-xl font-kufi text-sm font-bold transition-all text-white/50 hover:text-white">المنصورة</button>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-black/30 border ${m?'border-amber-500/10':'border-fuchsia-500/10'} rounded-2xl p-3 text-center"><div class="text-xs ${accentText}/60 font-kufi mb-1">الفَجْر 🌙</div><div class="text-lg font-bold text-white font-amiri" id="az-fajr">--:--</div></div>
                    <div class="bg-black/30 border ${m?'border-amber-500/10':'border-fuchsia-500/10'} rounded-2xl p-3 text-center"><div class="text-xs ${accentText}/60 font-kufi mb-1">الشُّرُوق ☀️</div><div class="text-lg font-bold text-white font-amiri" id="az-sunrise">--:--</div></div>
                    <div class="bg-black/30 border ${m?'border-amber-500/10':'border-fuchsia-500/10'} rounded-2xl p-3 text-center"><div class="text-xs ${accentText}/60 font-kufi mb-1">الظُّهْر 🕛</div><div class="text-lg font-bold text-white font-amiri" id="az-dhuhr">--:--</div></div>
                    <div class="bg-black/30 border ${m?'border-amber-500/10':'border-fuchsia-500/10'} rounded-2xl p-3 text-center"><div class="text-xs ${accentText}/60 font-kufi mb-1">العَصْر 🌤️</div><div class="text-lg font-bold text-white font-amiri" id="az-asr">--:--</div></div>
                    <div class="${accentBgBold} border ${accentBorder} rounded-2xl p-3 text-center relative overflow-hidden">
                        <div class="absolute inset-0 ${accentBg} animate-pulse rounded-2xl"></div>
                        <div class="text-xs ${iftarText} font-kufi mb-1 font-bold relative z-10">الإِفْطَار 🌅</div>
                        <div class="text-xl font-bold ${iftarText} font-amiri relative z-10" id="az-maghrib">--:--</div>
                    </div>
                    <div class="bg-black/30 border ${m?'border-amber-500/10':'border-fuchsia-500/10'} rounded-2xl p-3 text-center"><div class="text-xs ${accentText}/60 font-kufi mb-1">العِشَاء 🌃</div><div class="text-lg font-bold text-white font-amiri" id="az-isha">--:--</div></div>
                </div>
                <div id="iftarCountdown" class="text-center py-2 text-sm font-kufi ${accentText}/70 hidden">
                    <i class="fas fa-hourglass-half ml-1 ${accentText}"></i>
                    <span id="iftarCountdownText"></span>
                </div>
            </div>

            <!-- Dua Iftar -->
            <div class="${panel} rounded-3xl p-5 relative overflow-hidden">
                <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent ${m?'via-amber-400':'via-fuchsia-400'} to-transparent opacity-50 rounded-t-3xl"></div>
                <div class="flex items-center gap-3 pb-3 border-b ${borderColor} mb-4"><span class="text-2xl">🌅</span><h3 class="font-bold text-xl font-kufi ${iftarText}">دُعَاءُ الإِفْطَار</h3></div>
                <p class="font-amiri text-2xl text-white leading-[2.4] text-center mb-4 tracking-wide">اللَّهُمَّ لَكَ صُمْتُ، وَعَلَى رِزْقِكَ أَفْطَرْتُ،<br>ذَهَبَ الظَّمَأُ وَابْتَلَّتِ الْعُرُوقُ،<br>وَثَبَتَ الأَجْرُ إِنْ شَاءَ اللَّه</p>
                <div class="text-center text-xs ${accentText}/50 font-amiri">رواه أبو داود</div>
            </div>

            <!-- Dua Qadr -->
            <div class="${panel} rounded-3xl p-5 relative overflow-hidden">
                <div class="flex items-center gap-3 pb-3 border-b ${borderColor} mb-4"><span class="text-2xl">🌙</span><h3 class="font-bold text-xl font-kufi ${iftarText}">دُعَاءُ لَيْلَةِ الْقَدْر</h3></div>
                <p class="font-amiri text-2xl text-white leading-[2.4] text-center tracking-wide">اللَّهُمَّ إِنَّكَ عَفُوٌّ كَرِيم،<br>تُحِبُّ الْعَفْوَ فَاعْفُ عَنِّي</p>
                <div class="text-center text-xs ${accentText}/50 font-amiri mt-3">رواه الترمذي وصححه</div>
            </div>

            <!-- Selected Duas -->
            <div class="${panel} rounded-3xl p-5 space-y-4">
                <div class="flex items-center gap-3 pb-3 border-b ${borderColor}"><i class="fas fa-book-open text-xl ${accentText}"></i><h3 class="font-bold text-xl font-kufi text-white">أَدْعِيَةٌ مُخْتَارَة</h3></div>
                <div class="space-y-3">
                    ${[
                        "اللَّهُمَّ أَعِنِّي عَلَى ذِكْرِكَ وَشُكْرِكَ وَحُسْنِ عِبَادَتِك",
                        "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّار",
                        "اللَّهُمَّ اهْدِنِي وَسَدِّدْنِي، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْهُدَى وَالسَّدَاد",
                        "اللَّهُمَّ تَقَبَّلْ صِيَامَنَا وَقِيَامَنَا وَاجْعَلْنَا مِنْ عُتَقَائِكَ مِنَ النَّار",
                        "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْجَنَّةَ وَمَا قَرَّبَ إِلَيْهَا مِنْ قَوْلٍ أَوْ عَمَل",
                        "اللَّهُمَّ بَلِّغْنَا رَمَضَان، وَبَلِّغْنَا لَيْلَةَ الْقَدْر، وَاجْعَلْنَا مِنَ الْفَائِزِين"
                    ].map(d=>`<div class="dua-card p-4 bg-black/30 rounded-2xl border border-white/5 hover:${m?'border-amber-500/30':'border-fuchsia-500/30'} active:scale-[0.98] transition-all cursor-pointer text-right" onclick="window.copyDua(this)">
                        <p class="font-amiri text-xl text-white leading-[2.2]">${d}</p>
                        <div class="text-xs ${accentText}/40 font-kufi mt-2 flex items-center gap-1"><i class="fas fa-copy text-[10px]"></i> اضغط للنسخ</div>
                    </div>`).join('')}
                </div>
            </div>

            <!-- Sadaqa jaria -->
            <div class="${panel} p-6 rounded-3xl relative overflow-hidden text-center">
                <div class="text-base font-bold ${accentText} mb-4 font-kufi">${m?'💛':'💜'} صَدَقَةٌ جَارِيَة</div>
                <p class="font-amiri text-xl text-white/85 leading-[2.4] relative z-10 mb-6 tracking-wide">اللَّهُمَّ اغْفِرْ لِمَوْتَانَا وَمَوْتَى الْمُسْلِمِين،<br>وَارْحَمْهُمْ بِرَحْمَتِكَ الَّتِي وَسِعَتْ كُلَّ شَيْء،<br>وَاجْعَلْ قُبُورَهُمْ رَوْضَةً مِنْ رِيَاضِ الْجَنَّة</p>
                <div class="font-amiri text-xl font-bold text-white space-y-3 leading-relaxed relative z-10">
                    <div class="py-2 border-b ${m?'border-amber-500/15':'border-fuchsia-500/15'}">عَطِيَّة إِبْرَاهِيم</div>
                    <div class="${m?'text-amber-300':'text-fuchsia-200'} py-2 border-b ${m?'border-amber-500/15':'border-fuchsia-500/15'}">أَحْمَد مُحَمَّد السَّيِّد عَلِيوَه</div>
                    <div class="py-2">حَمْزَة مُحَمَّد إِبْرَاهِيم</div>
                </div>
            </div>
            ${FOOTER_HTML}
        </div>`;
    }

    /* ── Setup ── */
    window.selectSetupTheme = (t) => {
        const mEl = document.getElementById('themeMale');
        const fEl = document.getElementById('themeFemale');
        if (mEl) { mEl.classList.remove('selected-male','selected-female'); }
        if (fEl) { fEl.classList.remove('selected-male','selected-female'); }
        if (t === 'male' && mEl) mEl.classList.add('selected-male');
        else if (t === 'female' && fEl) fEl.classList.add('selected-female');
        currentTheme = t;
    };

    window.finishSetup = async () => {
        const name = document.getElementById('setupName').value.trim();
        if (!name) return showToast('الاسم يزين تطبيقنا.. فضلاً أدخله');
        currentUser = name;
        localStorage.setItem('ramadanUserName', name);
        localStorage.setItem('ramadanUserTheme', currentTheme);
        await setDoc(doc(db,"users",name),{username:name,theme:currentTheme,appData:{}},{merge:true});
        location.reload();
    };

    /* ── Nav ── */
    window.toggleView = (view) => {
        ['dashboard','duaa','quran','azkar'].forEach(v => document.getElementById(`${v}-view`)?.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('text-amber-500','text-fuchsia-400');
            el.classList.add('text-white/50');
        });
        document.getElementById(`${view}-view`)?.classList.remove('hidden');
        const activeColor = currentTheme === 'male' ? 'text-amber-500' : 'text-fuchsia-400';
        const navEl = document.getElementById(`nav-${view}`);
        if (navEl) { navEl.classList.remove('text-white/50'); navEl.classList.add(activeColor); }
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if (view === 'duaa') setTimeout(() => { renderPrayerTimes(selectedCity); window.selectCity(selectedCity); }, 50);
        if (view === 'quran') setTimeout(() => initQuran(), 50);
        if (view === 'azkar') setTimeout(() => renderAzkarList('sabah'), 50);
    };

    /* ── Date ── */
    window.changeDate = (d) => {
        const date = new Date(currentDate);
        date.setDate(date.getDate() - d);
        currentDate = date.toISOString().split('T')[0];
        updateUI();
    };

    /* ── FIX 1: Prayer toggle - separate fard/sunnah buttons ── */
    window.togglePrayer = (key, type) => {
        if (!appData[currentDate]) appData[currentDate] = { prayers: {} };
        if (!appData[currentDate].prayers) appData[currentDate].prayers = {};
        if (!appData[currentDate].prayers[key]) appData[currentDate].prayers[key] = {};
        appData[currentDate].prayers[key][type] = !appData[currentDate].prayers[key][type];
        markUnsaved();
        // FIX 6: Auto-save on toggle
        autoSave();
        updateUI();
        const btn = document.getElementById(`btn-${key}-${type}`);
        if (btn) { btn.classList.add('animate-pop'); setTimeout(() => btn.classList.remove('animate-pop'), 400); }
    };

    /* ── Habits ── */
    window.toggleHabit = (id) => {
        if (!appData[currentDate]) appData[currentDate] = {};
        appData[currentDate][id] = !appData[currentDate][id];
        markUnsaved();
        // FIX 6: Auto-save on toggle
        autoSave();
        updateUI();
    };

    /* ── Input change ── */
    window.onInputChange = () => markUnsaved();

    /* ── Juz counter (dashboard) ── */
    window.changeJuz = (delta) => {
        if (!appData[currentDate]) appData[currentDate] = {};
        const current = appData[currentDate].juzCount || 0;
        const next = Math.max(0, Math.min(30, current + delta));
        appData[currentDate].juzCount = next;
        markUnsaved();
        refreshDashJuz();
        autoSave();
    };

    window.syncJuzFromPages = () => { refreshDashKhatma(); };

    function refreshDashJuz() {
        const day = appData[currentDate] || {};
        const juzEl = document.getElementById('juzCountDisplay');
        if (juzEl) {
            juzEl.textContent = day.juzCount || 0;
            juzEl.style.transform = 'scale(1.3)';
            setTimeout(() => { juzEl.style.transform = 'scale(1)'; }, 200);
        }
        refreshDashKhatma();
    }

    function refreshDashKhatma() {
        let totalPages = 0;
        Object.values(appData).forEach(d => {
            const jc = d.juzCount || 0;
            const juzPg = jc > 0 ? 22 + (jc - 1) * 20 : 0;
            totalPages += (d.quran || 0) + juzPg;
        });
        const pagesInCycle = totalPages % 604;
        const khatmaNum = Math.floor(totalPages / 604) + 1;
        const juzNum = Math.min(30, Math.floor(pagesInCycle / 20) + 1);
        const pct = (pagesInCycle / 604 * 100).toFixed(1);

        const bar = document.getElementById('dashKhatmaBar');
        const lbl = document.getElementById('dashKhatmaLabel');
        const read = document.getElementById('dashPagesRead');
        const leftNum = document.getElementById('dashPagesLeftNum');
        if (bar) bar.style.width = pct + '%';
        if (lbl) lbl.textContent = khatmaNum > 1 ? `الختمة ${khatmaNum} · الجزء ${juzNum}` : `الجزء ${juzNum}`;
        if (read) read.textContent = `${pagesInCycle} صفحة`;
        if (leftNum) leftNum.textContent = 604 - pagesInCycle;
        // sync juz display for current day
        const day = appData[currentDate] || {};
        const juzEl = document.getElementById('juzCountDisplay');
        if (juzEl) juzEl.textContent = day.juzCount || 0;
    }

    /* ── FIX 6: Auto-save (silent, for toggles) ── */
    async function autoSave() {
        const qi = document.getElementById('quranInput') || document.getElementById('quranLogPages');
        const wi = document.getElementById('workInput');
        const li = document.getElementById('lessonInput');
        if (!appData[currentDate]) appData[currentDate] = {};
        if (qi) appData[currentDate].quran = parseInt(qi.value) || 0;
        if (wi) appData[currentDate].work = parseFloat(wi.value) || 0;
        if (li) appData[currentDate].lesson = li.value || '';
        // juzCount already stored directly via changeJuz()
        // Save lessons list
        if (!appData[currentDate]) appData[currentDate] = {};
        // lessons already saved via addLesson/removeLesson
        try {
            await updateDoc(doc(db,"users",currentUser),{ appData });
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
        } catch {
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
        }
    }

    /* ── Init prayers UI ── */
    function initPrayersUI() {
        const list = document.getElementById('prayersList');
        if (!list) return;
        list.innerHTML = '';
        Object.keys(PRAYERS_CONFIG).forEach(key => {
            const p = PRAYERS_CONFIG[key];
            const icon = PRAYER_ICONS[key] || 'fa-circle';
            list.innerHTML += `
            <div class="prayer-row" id="row-${key}">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${currentTheme==='male'?'bg-amber-500/10':'bg-fuchsia-500/10'}">
                        <i class="fas ${icon} ${currentTheme==='male'?'text-amber-400':'text-fuchsia-400'} text-sm"></i>
                    </div>
                    <span class="text-lg font-bold font-amiri text-white">${p.label}</span>
                </div>
                <div class="flex gap-2">
                    ${p.fard ? `<button onclick="window.togglePrayer('${key}','fard')" id="btn-${key}-fard" class="prayer-btn font-kufi">
                        فرض
                    </button>` : ''}
                    ${p.sunnah ? `<button onclick="window.togglePrayer('${key}','sunnah')" id="btn-${key}-sunnah" class="prayer-btn font-amiri">
                        <span class="sunnah-check">سنة</span>
                    </button>` : ''}
                </div>
            </div>`;
        });
    }

    /* ── Update UI ── */
    function updateUI() {
        const today = new Date().toISOString().split('T')[0];
        const dateObj = new Date(currentDate);
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        const dateEl = document.getElementById('dateDisplay');
        const tagEl = document.getElementById('dateTag');
        if (dateEl) dateEl.textContent = dateObj.toLocaleDateString('ar-EG', options);
        if (tagEl) tagEl.textContent = currentDate === today ? 'اليوم' : currentDate < today ? 'يوم سابق' : 'يوم قادم';

        const day = appData[currentDate] || {};
        const prayers = day.prayers || {};

        let fardDone = 0, fardTotal = 0, sunnahDone = 0;
        Object.keys(PRAYERS_CONFIG).forEach(key => {
            const state = prayers[key] || {};
            const p = PRAYERS_CONFIG[key];
            if (p.fard) fardTotal++;

            const fBtn = document.getElementById(`btn-${key}-fard`);
            const sBtn = document.getElementById(`btn-${key}-sunnah`);
            const row = document.getElementById(`row-${key}`);

            if (fBtn) {
                if (state.fard) {
                    fardDone++;
                    // FIX 1: Clear golden = fard done
                    fBtn.className = `prayer-btn font-kufi ${currentTheme==='male'?'btn-fard-done':'btn-fard-done-f'}`;
                    fBtn.innerHTML = '<i class="fas fa-check ml-1 text-xs"></i> فرض';
                } else {
                    fBtn.className = 'prayer-btn font-kufi';
                    fBtn.innerHTML = 'فرض';
                }
            }
            if (sBtn) {
                if (state.sunnah) {
                    sunnahDone++;
                    // FIX 1: GREEN = sunnah done, clearly different
                    sBtn.className = `prayer-btn font-amiri ${currentTheme==='male'?'btn-sunnah-done':'btn-sunnah-done-f'}`;
                    sBtn.innerHTML = '<i class="fas fa-check ml-1 text-xs"></i> سنة';
                } else {
                    sBtn.className = 'prayer-btn font-amiri';
                    sBtn.innerHTML = '<span class="sunnah-check">سنة</span>';
                }
            }
            if (row) {
                const doneClass = currentTheme==='male' ? 'row-done-m' : 'row-done-f';
                if (state.fard) row.classList.add(doneClass); else row.classList.remove(doneClass);
            }
        });

        const ppEl = document.getElementById('prayerProgress');
        if (ppEl) ppEl.textContent = `${fardDone}/${fardTotal} فروض`;

        // Habits
        const habitIds = currentTheme === 'male'
            ? ['m_morning','m_evening','m_taraweeh','m_qiyam']
            : ['f_morning','f_evening','f_taraweeh','f_qiyam'];

        habitIds.forEach(h => {
            const el = document.getElementById(h);
            if (!el) return;
            // FIX 2: Taraweeh/Qiyam cards have their own check div
            const checkEl = document.getElementById(`${h}-check`) || el.querySelector('.check-circle');
            const checkIcon = checkEl?.querySelector('i.fa-check');
            const activeClass = currentTheme === 'male' ? 'habit-active-m' : 'habit-active-f';

            if (h.includes('taraweeh') || h.includes('qiyam')) {
                const isDone = !!day[h];
                if (isDone) {
                    el.style.borderColor = currentTheme==='male' ? 'rgba(251,191,36,0.6)' : 'rgba(240,171,252,0.6)';
                    el.style.background = currentTheme==='male' ? 'rgba(251,191,36,0.12)' : 'rgba(240,171,252,0.1)';
                    if (checkEl) {
                        checkEl.style.background = h.includes('qiyam') ? '#4ade80' : (currentTheme==='male'?'#fbbf24':'#d946ef');
                        checkEl.style.borderColor = 'transparent';
                    }
                    if (checkIcon) { checkIcon.style.opacity='1'; checkIcon.style.color='#000'; }
                } else {
                    el.style.borderColor = '';
                    el.style.background = '';
                    if (checkEl) { checkEl.style.background=''; checkEl.style.borderColor=''; }
                    if (checkIcon) { checkIcon.style.opacity='0'; }
                }
                return;
            }

            const circleBg = currentTheme === 'male' ? 'bg-amber-400' : 'bg-fuchsia-400';
            const circleBorder = currentTheme === 'male' ? 'border-amber-400' : 'border-fuchsia-400';
            const circle = el.querySelector('.check-circle');
            const cIcon = el.querySelector('i.fa-check');

            if (day[h]) {
                el.classList.add(activeClass);
                circle?.classList.add(circleBg, circleBorder);
                if (cIcon) { cIcon.classList.remove('opacity-0'); cIcon.classList.add('opacity-100'); }
            } else {
                el.classList.remove(activeClass);
                circle?.classList.remove(circleBg, circleBorder);
                if (cIcon) { cIcon.classList.add('opacity-0'); cIcon.classList.remove('opacity-100'); }
            }
        });

        // Inputs
        const qi = document.getElementById('quranInput') || document.getElementById('quranLogPages');
        const wi = document.getElementById('workInput');
        const li = document.getElementById('lessonInput');
        if (qi) qi.value = day.quran || '';
        if (wi) wi.value = day.work || '';
        if (li) li.value = day.lesson || '';
        // Refresh juz counter and mini khatma bar
        refreshDashKhatma();
        // Refresh lessons list
        renderLessonsList();

        updateDashboard(fardDone, fardTotal, sunnahDone);
    }

    /* ── FIX 7: Dashboard stats ── */
    function updateDashboard(fardDoneToday=0, fardTotalToday=5, sunnahDoneToday=0) {
        let totalQ=0, totalFard=0, totalSunnah=0, totalTaraweeh=0, totalQiyam=0;
        let daysTracked = Math.max(Object.keys(appData).length, 1);

        const cd = appData[currentDate] || {};
        const hasMorning = !!(cd.m_morning || cd.f_morning);
        const hasEvening = !!(cd.m_evening || cd.f_evening);
        const hasTaraweeh = !!(cd.m_taraweeh || cd.f_taraweeh);
        const hasQiyam = !!(cd.m_qiyam || cd.f_qiyam);
        const habitsCount = [hasMorning, hasEvening, hasTaraweeh, hasQiyam].filter(Boolean).length;

        Object.values(appData).forEach(day => {
            const jc = day.juzCount || 0;
            const juzPages = jc > 0 ? 22 + (jc - 1) * 20 : 0; // first juz=22, rest=20
            totalQ += (day.quran || 0) + juzPages;
            if (day.prayers) {
                Object.keys(PRAYERS_CONFIG).forEach(k => {
                    if (PRAYERS_CONFIG[k].fard && day.prayers[k]?.fard) totalFard++;
                    if (PRAYERS_CONFIG[k].sunnah && day.prayers[k]?.sunnah) totalSunnah++;
                });
            }
            if (day.m_taraweeh || day.f_taraweeh) totalTaraweeh++;
            if (day.m_qiyam || day.f_qiyam) totalQiyam++;
        });

        // Performance: fard 50%, sunnah 20%, habits 20%, quran 10%
        const quranToday = cd.quran || 0;
        const quranScore = Math.min(quranToday / 10, 1); // 10 pages = 100%
        const dailyPerf = Math.round(
            (fardDoneToday / Math.max(fardTotalToday,1)) * 50 +
            (sunnahDoneToday / 5) * 20 +
            (habitsCount / 4) * 20 +
            quranScore * 10
        );

        // FIX 7: Dual rings - outer=fard, inner=sunnah
        const fardRingLen = 660;
        const sunnahRingLen = 515;
        const fardRing = document.getElementById('fardRing');
        const sunnahRing = document.getElementById('sunnahRing');
        if (fardRing) fardRing.style.strokeDashoffset = fardRingLen - (fardRingLen * (fardDoneToday / Math.max(fardTotalToday,1)));
        if (sunnahRing) sunnahRing.style.strokeDashoffset = sunnahRingLen - (sunnahRingLen * Math.min(sunnahDoneToday / 5, 1));

        const pPct = document.getElementById('performancePct');
        const pLabel = document.getElementById('performanceLabel');
        if (pPct) pPct.textContent = Math.min(dailyPerf,100) + '%';
        if (pLabel) {
            let label = 'سعيٌ طيِّب';
            if (dailyPerf >= 30) label = 'أنتَ في الطريق';
            if (dailyPerf >= 55) label = 'قُربٌ جميل';
            if (dailyPerf >= 75) label = 'نورٌ على نور';
            if (dailyPerf >= 90) label = 'رُوحٌ وريحان ✨';
            pLabel.textContent = label;
        }

        // Stat mini-cards
        const tFardC = document.getElementById('todayFardCount');
        const tFardB = document.getElementById('todayFardBar');
        const tSunC = document.getElementById('todaySunnahCount');
        const tSunB = document.getElementById('todaySunnahBar');
        const tHabC = document.getElementById('todayHabitsCount');
        const tHabB = document.getElementById('todayHabitsBar');
        if (tFardC) tFardC.textContent = `${fardDoneToday}/${fardTotalToday}`;
        if (tFardB) tFardB.style.width = (fardDoneToday/Math.max(fardTotalToday,1)*100)+'%';
        if (tSunC) tSunC.textContent = sunnahDoneToday;
        if (tSunB) tSunB.style.width = Math.min(sunnahDoneToday/5*100,100)+'%';
        if (tHabC) tHabC.textContent = `${habitsCount}/4`;
        if (tHabB) tHabB.style.width = (habitsCount/4*100)+'%';

        // Month stats
        const mF = document.getElementById('monthFard');
        const mS = document.getElementById('monthSunnah');
        const mT = document.getElementById('monthTaraweeh');
        const mSc = document.getElementById('monthScore');
        if (mF) mF.textContent = totalFard;
        if (mS) mS.textContent = totalSunnah;
        if (mT) mT.textContent = totalTaraweeh + totalQiyam;
        if (mSc) {
            const score = Math.round(
                (totalFard/(daysTracked*5))*50 +
                (totalSunnah/(daysTracked*5))*20 +
                ((totalTaraweeh+totalQiyam)/(daysTracked*2))*20 +
                Math.min(totalQ/(daysTracked*10),1)*10
            );
            mSc.textContent = Math.min(score,100) + '%';
        }

        // Khatma
        const cQ = totalQ % 604;
        const bar = document.getElementById('khatmaBar');
        if (bar) bar.style.width = (cQ/604*100) + '%';
        const cpEl = document.getElementById('currentPages');
        const rpEl = document.getElementById('remainingPages');
        const tpEl = document.getElementById('totalPagesAll');
        const kLabel = document.getElementById('khatmaLabel');
        if (cpEl) cpEl.textContent = cQ;
        if (rpEl) rpEl.textContent = 604 - cQ;
        if (tpEl) tpEl.textContent = totalQ;
        if (kLabel) {
            const juzNum = Math.floor(totalQ/20) + 1;
            kLabel.textContent = `الجزء ${juzNum <= 30 ? juzNum : '30+'}`;
        }

        // Streak
        let streak = 0;
        const dates = Object.keys(appData).sort().reverse();
        const todayStr = new Date().toISOString().split('T')[0];
        for (const d of dates) {
            const day = appData[d];
            const fardCount = Object.keys(PRAYERS_CONFIG).filter(k => PRAYERS_CONFIG[k].fard && day.prayers?.[k]?.fard).length;
            if (fardCount >= 3) streak++; else break;
        }
        const sc = document.getElementById('streakCount');
        if (sc) sc.textContent = streak;
    }

    /* ── FIX 4: Quran Log Mode ── */
    let quranLogMode = 'pages';
    let selectedJuz = new Set();

    window.setQuranLogMode = (mode) => {
        quranLogMode = mode;
        const m = currentTheme === 'male';
        const pageBtn = document.getElementById('qlog-pages-btn');
        const juzBtn = document.getElementById('qlog-juz-btn');
        const pageMode = document.getElementById('qlog-pages-mode');
        const juzMode = document.getElementById('qlog-juz-mode');
        const activeClass = m ? ['bg-amber-500','text-black'] : ['bg-fuchsia-500','text-white'];
        const inactiveClass = ['text-white/40'];

        if (mode === 'pages') {
            pageBtn?.classList.remove(...inactiveClass); pageBtn?.classList.add(...activeClass);
            juzBtn?.classList.add(...inactiveClass); juzBtn?.classList.remove(...activeClass);
            pageMode?.classList.remove('hidden'); juzMode?.classList.add('hidden');
        } else {
            juzBtn?.classList.remove(...inactiveClass); juzBtn?.classList.add(...activeClass);
            pageBtn?.classList.add(...inactiveClass); pageBtn?.classList.remove(...activeClass);
            juzMode?.classList.remove('hidden'); pageMode?.classList.add('hidden');
            renderJuzGrid();
        }
    };

    window.adjustQuranPages = (delta) => {
        const inp = document.getElementById('quranLogPages') || document.getElementById('quranInput');
        if (!inp) return;
        const current = parseInt(inp.value) || 0;
        inp.value = Math.max(0, current + delta);
        markUnsaved();
    };

    function renderJuzGrid() {
        const grid = document.getElementById('juzGrid');
        if (!grid) return;
        const m = currentTheme === 'male';
        const dayJuz = (appData[currentDate]?.juz) || [];
        selectedJuz = new Set(dayJuz);
        grid.innerHTML = '';
        for (let i=1; i<=30; i++) {
            const done = selectedJuz.has(i);
            const btn = document.createElement('button');
            btn.className = `juz-btn ${done ? (m?'done-m':'done-f') : ''}`;
            btn.textContent = i;
            btn.onclick = () => {
                if (selectedJuz.has(i)) selectedJuz.delete(i);
                else selectedJuz.add(i);
                // Update pages
                const totalPages = selectedJuz.size * 20;
                if (!appData[currentDate]) appData[currentDate] = {};
                appData[currentDate].quran = totalPages;
                appData[currentDate].juz = [...selectedJuz];
                markUnsaved();
                renderJuzGrid();
                const lbl = document.getElementById('juzSumLabel');
                if (lbl) lbl.textContent = `= ${totalPages} صفحة`;
            };
            grid.appendChild(btn);
        }
        const totalPages = selectedJuz.size * 20;
        const lbl = document.getElementById('juzSumLabel');
        if (lbl) lbl.textContent = `= ${totalPages} صفحة`;
    }

    /* ── FIX 5: Azkar ── */
    let currentAzkarTab = 'sabah';
    let azkarProgress = {}; // { 'sabah-0': 3, ... }

    window.switchAzkarTab = (tab) => {
        currentAzkarTab = tab;
        const m = currentTheme === 'male';
        const sabah = document.getElementById('azkar-tab-sabah');
        const masaa = document.getElementById('azkar-tab-masaa');
        if (tab === 'sabah') {
            sabah?.classList.add(m?'active-m':'active-f');
            masaa?.classList.remove('active-m','active-f');
        } else {
            masaa?.classList.add(m?'active-m':'active-f');
            sabah?.classList.remove('active-m','active-f');
        }
        renderAzkarList(tab);
    };

    function renderAzkarList(tab) {
        const list = document.getElementById('azkarList');
        if (!list) return;
        const data = tab === 'sabah' ? AZKAR_SABAH : AZKAR_MASAA;
        const m = currentTheme === 'male';
        const accentColor = m ? '#fbbf24' : '#f0abfc';
        const accentText = m ? 'text-amber-400' : 'text-fuchsia-400';
        const doneBg = m ? 'rgba(251,191,36,0.12)' : 'rgba(217,70,239,0.1)';
        const doneBorder = m ? 'rgba(251,191,36,0.45)' : 'rgba(217,70,239,0.4)';

        const doneCount = data.filter((_,i) => (azkarProgress[`${tab}-${i}`]||0) >= data[i].count).length;
        // Update header progress
        const hdr = document.getElementById('azkarProgressText');
        if (hdr) hdr.textContent = `${doneCount}/${data.length}`;

        list.innerHTML = data.map((item, idx) => {
            const key = `${tab}-${idx}`;
            const progress = azkarProgress[key] || 0;
            const isDone = progress >= item.count;
            const pct = item.count > 1 ? Math.round(progress/item.count*100) : (isDone?100:0);
            return `<div class="azkar-item" style="${isDone ? `background:${doneBg};border-color:${doneBorder};` : ''}">
                <div class="flex items-start justify-between gap-2 mb-3">
                    <p class="font-amiri text-xl text-white leading-[2.0] flex-1 text-right">${item.text}</p>
                </div>
                <div class="flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2">
                        ${item.src ? `<span class="text-[10px] text-white/25 font-kufi border border-white/10 px-1.5 py-0.5 rounded">${item.src}</span>` : ''}
                        <span class="text-xs ${accentText}/70 font-kufi font-bold">${item.label}</span>
                    </div>
                    <button onclick="window.tapAzkar('${tab}',${idx},${item.count})"
                        class="flex items-center gap-2 px-4 py-2 rounded-xl font-bold font-kufi text-sm transition-all active:scale-90"
                        style="${isDone
                            ? `background:${accentColor};color:#000;box-shadow:0 4px 14px ${accentColor}55;`
                            : 'background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.1);'}">
                        ${isDone
                            ? '<i class="fas fa-check text-sm"></i>'
                            : progress > 0
                                ? `<span>${progress}/${item.count}</span>`
                                : '<span>ابدأ</span>'}
                    </button>
                </div>
                ${item.count > 1 && progress > 0 && !isDone ? `
                <div class="mt-2 h-1 bg-white/10 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-300" style="width:${pct}%;background:${accentColor}"></div>
                </div>` : ''}
            </div>`;
        }).join('');
    }

    window.tapAzkar = (tab, idx, total) => {
        const key = `${tab}-${idx}`;
        const current = azkarProgress[key] || 0;
        if (current < total) {
            azkarProgress[key] = current + 1;
            if (azkarProgress[key] >= total) {
                confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, colors: ['#fbbf24','#4ade80','#fff'] });
            }
        } else {
            azkarProgress[key] = 0; // reset
        }
        renderAzkarList(tab);
    };

    window.markAllAzkarDone = () => {
        const data = currentAzkarTab === 'sabah' ? AZKAR_SABAH : AZKAR_MASAA;
        data.forEach((item, idx) => {
            azkarProgress[`${currentAzkarTab}-${idx}`] = item.count;
        });
        const habitId = currentAzkarTab === 'sabah'
            ? (currentTheme==='male'?'m_morning':'f_morning')
            : (currentTheme==='male'?'m_evening':'f_evening');
        if (!appData[currentDate]) appData[currentDate] = {};
        appData[currentDate][habitId] = true;
        markUnsaved();
        autoSave();
        updateUI();
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.5 }, colors: ['#fbbf24','#4ade80','#f0abfc'] });
        showToast('أحسنت! بارك الله في ذكرك ✨');
        renderAzkarList(currentAzkarTab);
    };

    /* ── Lessons list ── */
    window.addLesson = () => {
        const inp = document.getElementById('lessonInput');
        const text = inp?.value?.trim();
        if (!text) return;
        if (!appData[currentDate]) appData[currentDate] = {};
        if (!appData[currentDate].lessons) appData[currentDate].lessons = [];
        appData[currentDate].lessons.push({ text, time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) });
        inp.value = '';
        markUnsaved();
        renderLessonsList();
        autoSave();
    };

    window.removeLesson = (idx) => {
        if (!appData[currentDate]?.lessons) return;
        appData[currentDate].lessons.splice(idx, 1);
        markUnsaved();
        renderLessonsList();
        autoSave();
    };

    function renderLessonsList() {
        const listEl = document.getElementById('lessonsList');
        const countEl = document.getElementById('lessonsCount');
        if (!listEl) return;
        const lessons = appData[currentDate]?.lessons || [];
        if (countEl) countEl.textContent = lessons.length + ' درس';
        const m = currentTheme === 'male';
        if (lessons.length === 0) {
            listEl.innerHTML = `<p class="text-xs text-white/25 text-center font-amiri py-2">لم تسجّل دروساً بعد</p>`;
            return;
        }
        listEl.innerHTML = lessons.map((l, i) => `
            <div class="flex items-center gap-2 bg-black/25 rounded-xl px-3 py-2.5 border border-white/6 group">
                <i class="fas fa-podcast ${m?'text-amber-400':'text-fuchsia-400'} text-xs flex-shrink-0"></i>
                <span class="flex-1 text-sm font-amiri text-white/90 text-right leading-relaxed">${l.text}</span>
                <span class="text-[10px] text-white/25 font-kufi flex-shrink-0">${l.time||''}</span>
                <button onclick="window.removeLesson(${i})" class="opacity-40 hover:opacity-100 transition-all active:scale-90 flex-shrink-0">
                    <i class="fas fa-times text-red-400 text-xs"></i>
                </button>
            </div>`).join('');
    }

    /* ── Save ── */
    window.saveData = async () => {
        const qi = document.getElementById('quranInput') || document.getElementById('quranLogPages');
        const wi = document.getElementById('workInput');
        const li = document.getElementById('lessonInput');
        const quran = parseInt(qi?.value) || (appData[currentDate]?.quran || 0);
        const work = parseFloat(wi?.value) || 0;
        const lesson = li?.value || '';

        if (!appData[currentDate]) appData[currentDate] = {};
        appData[currentDate].quran = quran;
        appData[currentDate].work = work;
        appData[currentDate].lesson = lesson;

        const btn = document.getElementById('saveBtn');
        if (btn) { btn.textContent = '⏳ يُسجَّل سعيُك..'; btn.disabled = true; }

        try {
            await updateDoc(doc(db,"users",currentUser),{ appData });
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
            showToast('تقبل الله منك صالح الأعمال ✨');
            if (quran > 0) confetti({ particleCount: 120, spread: 70, origin: { y: 0.7 }, colors: ['#fbbf24','#f59e0b','#fff'] });
            markSaved();
        } catch {
            localStorage.setItem('ramadanTrackerData_v5', JSON.stringify(appData));
            showToast('تم الحفظ على الجهاز بنجاح ✓');
            markSaved();
        } finally {
            if (btn) {
                btn.textContent = currentTheme === 'male' ? '💾 حفظ يومياتي' : '✨ حفظ يومياتي';
                btn.disabled = false;
            }
            updateUI();
        }
    };

    /* ── Reset / Home ── */
    window.goHome = () => {
        if (confirm('هل تود العودة لتغيير الاسم أو النمط؟')) {
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('welcomeScreen').style.display = 'flex';
        }
    };
    window.resetData = () => {
        if (confirm('تحذير: سيتم حذف كافة سجلاتك نهائياً. هل أنت متأكد؟')) {
            localStorage.clear(); location.reload();
        }
    };

    /* ── Load app ── */
    function loadApp() {
        const container = document.getElementById('app-container');
        document.body.className = `min-h-screen text-zinc-100 theme-${currentTheme}`;
        container.innerHTML = currentTheme === 'male' ? getMaleTemplate() : getFemaleTemplate();
        initPrayersUI();
        updateUI();
        document.getElementById('loadingScreen')?.classList.add('hidden');
        container.classList.remove('hidden');
        setTimeout(() => container.classList.add('opacity-100'), 50);
    }

    /* ── Init ── */
    function init() {
        if (currentUser) fetchData();
        else {
            document.getElementById('loadingScreen')?.classList.add('hidden');
            document.getElementById('welcomeScreen').style.display = 'flex';
        }
    }

    /* ══════════════════════════════════
       PRAYER TIMES CALCULATOR
    ══════════════════════════════════ */
    const CITIES = {
        cairo:    { lat: 30.0444, lng: 31.2357, name: 'القاهرة'     },
        alex:     { lat: 31.2001, lng: 29.9187, name: 'الإسكندرية'  },
        mansoura: { lat: 31.0409, lng: 31.3785, name: 'المنصورة'    },
    };
    let selectedCity = 'cairo';
    let iftarTimerInterval = null;

    function calcPrayerTimes(lat, lng, dateObj) {
        const rad = d => d * Math.PI / 180;
        const deg = r => r * 180 / Math.PI;
        const Y = dateObj.getFullYear(), M = dateObj.getMonth()+1, D = dateObj.getDate();
        const JD = (367*Y) - Math.floor(7*(Y+Math.floor((M+9)/12))/4) + Math.floor(275*M/9) + D + 1721013.5 + 0.5 - lng/360;
        const d2 = JD - 2451545.0;
        const g  = rad(357.529 + 0.98560028 * d2);
        const q  = 280.459 + 0.98564736 * d2;
        const L  = rad(q + 1.915*Math.sin(g) + 0.020*Math.sin(2*g));
        const e  = rad(23.439 - 0.00000036 * d2);
        const RA = deg(Math.atan2(Math.cos(e)*Math.sin(L), Math.cos(L))) / 15;
        const decl = deg(Math.asin(Math.sin(e)*Math.sin(L)));
        const EqT  = q/15 - (RA - 24*Math.floor(RA/24));
        const tz   = 2;
        const transit = 12 + tz - lng/15 - EqT;

        function ha(angle) {
            const cosH = (Math.sin(rad(angle)) - Math.sin(rad(lat))*Math.sin(rad(decl))) / (Math.cos(rad(lat))*Math.cos(rad(decl)));
            if (Math.abs(cosH) > 1) return NaN;
            return deg(Math.acos(cosH)) / 15;
        }
        function asrHA() {
            const angle = -deg(Math.atan(1 / (1 + Math.tan(rad(Math.abs(lat - decl))))));
            return ha(angle);
        }
        function fmt(h) {
            if (isNaN(h)) return '--:--';
            h = ((h % 24) + 24) % 24;
            const hh = Math.floor(h), mm = Math.round((h - hh)*60);
            const hFix = mm === 60 ? (hh+1)%24 : hh;
            const mFix = mm === 60 ? 0 : mm;
            const ap = hFix >= 12 ? 'م' : 'ص';
            const h12 = hFix % 12 || 12;
            return `${h12}:${String(mFix).padStart(2,'0')} ${ap}`;
        }
        return {
            fajr:    { fmt: fmt(transit - ha(-19.5)),       raw: transit - ha(-19.5) },
            sunrise: { fmt: fmt(transit - ha(-0.8333)),     raw: transit - ha(-0.8333) },
            dhuhr:   { fmt: fmt(transit),                   raw: transit },
            asr:     { fmt: fmt(transit + asrHA()),         raw: transit + asrHA() },
            maghrib: { fmt: fmt(transit + ha(-0.8333)),     raw: transit + ha(-0.8333) },
            isha:    { fmt: fmt(transit + ha(-17.5)),       raw: transit + ha(-17.5) },
        };
    }

    function renderPrayerTimes(city) {
        const c = CITIES[city];
        const now = new Date();
        const times = calcPrayerTimes(c.lat, c.lng, now);
        document.getElementById('az-fajr').textContent    = times.fajr.fmt;
        document.getElementById('az-sunrise').textContent = times.sunrise.fmt;
        document.getElementById('az-dhuhr').textContent   = times.dhuhr.fmt;
        document.getElementById('az-asr').textContent     = times.asr.fmt;
        document.getElementById('az-maghrib').textContent = times.maghrib.fmt;
        document.getElementById('az-isha').textContent    = times.isha.fmt;
        const dateLabel = document.getElementById('azanDateLabel');
        if (dateLabel) dateLabel.textContent = now.toLocaleDateString('ar-EG', { weekday:'long', day:'numeric', month:'long' });
        startIftarCountdown(times.maghrib.raw);
    }

    function startIftarCountdown(maghribRaw) {
        if (iftarTimerInterval) clearInterval(iftarTimerInterval);
        const cdEl = document.getElementById('iftarCountdown');
        const cdText = document.getElementById('iftarCountdownText');
        if (!cdEl || !cdText) return;
        function tick() {
            const now = new Date();
            const nowH = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
            const diff = maghribRaw - nowH;
            if (diff > 0 && diff < 12) {
                const totalSec = Math.round(diff * 3600);
                const h = Math.floor(totalSec / 3600), m = Math.floor((totalSec % 3600) / 60), s = totalSec % 60;
                cdEl.classList.remove('hidden');
                cdText.textContent = h > 0 ? `متبقي للإفطار: ${h} س ${m} د` : `متبقي للإفطار: ${m} د ${s} ث`;
            } else if (diff <= 0 && diff > -0.5) {
                cdEl.classList.remove('hidden');
                cdText.textContent = '🌅 حان وقت الإفطار! أَفْطِرْ هَنِيئاً مريئاً';
            } else {
                cdEl.classList.add('hidden');
            }
        }
        tick();
        iftarTimerInterval = setInterval(tick, 1000);
    }

    window.selectCity = (city) => {
        selectedCity = city;
        const m = currentTheme === 'male';
        const active = m ? ['bg-amber-500','text-black','shadow-md'] : ['bg-fuchsia-500','text-white','shadow-md'];
        ['cairo','alex','mansoura'].forEach(c => {
            const tab = document.getElementById(`tab-${c}`);
            if (!tab) return;
            tab.classList.remove(...active, 'text-white/50');
            if (c === city) tab.classList.add(...active);
            else tab.classList.add('text-white/50');
        });
        renderPrayerTimes(city);
    };

    /* ══════════════════════════════════
       QURAN READER
    ══════════════════════════════════ */
    let surahList = [];
    let currentSurahNum = 1;
    let quranFontSize = 26;
    let quranInitialized = false;

    async function initQuran() {
        if (quranInitialized) return;
        const sel = document.getElementById('surahSelect');
        if (!sel || surahList.length > 0) { quranInitialized = true; return; }
        try {
            const res = await fetch('https://api.alquran.cloud/v1/surah');
            const json = await res.json();
            surahList = json.data;
            surahList.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.number;
                opt.textContent = `${s.number}. ${s.name} — ${s.englishName}`;
                sel.appendChild(opt);
            });
            quranInitialized = true;
            sel.value = '1';
            window.loadSurah();
        } catch { showToast('تعذّر تحميل قائمة السور، تحقق من الإنترنت'); }
    }

    window.loadSurah = async () => {
        const sel = document.getElementById('surahSelect');
        if (!sel || !sel.value) return;
        currentSurahNum = parseInt(sel.value);
        const loading = document.getElementById('quranLoading');
        const container = document.getElementById('quranContainer');
        const navBar = document.getElementById('quranNavBar');
        if (loading) loading.classList.remove('hidden');
        if (container) container.classList.add('hidden');
        if (navBar) navBar.classList.add('hidden');
        try {
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${currentSurahNum}/ar.alafasy`);
            const json = await res.json();
            const surah = json.data;
            if (loading) loading.classList.add('hidden');
            if (container) container.classList.remove('hidden');
            if (navBar) navBar.classList.remove('hidden');
            const infoEl = document.getElementById('surahInfo');
            const nameEl = document.getElementById('surahNameAr');
            const countEl = document.getElementById('surahVerseCount');
            if (infoEl) infoEl.classList.remove('hidden');
            if (nameEl) nameEl.textContent = surah.name;
            if (countEl) countEl.textContent = `${surah.numberOfAyahs} آية · ${surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية'}`;
            const bism = document.getElementById('bismillah');
            if (bism) bism.style.display = (currentSurahNum === 1 || currentSurahNum === 9) ? 'none' : 'block';
            const versesEl = document.getElementById('quranVerses');
            if (versesEl) {
                versesEl.style.fontSize = quranFontSize + 'px';
                const m = currentTheme === 'male';
                versesEl.innerHTML = surah.ayahs.map(a => `
                    <div class="verse-block pb-4 border-b border-white/5 last:border-0">
                        <p class="font-amiri text-white leading-[2.4] text-right mb-1">${a.text}</p>
                        <div class="flex justify-end">
                            <span class="text-xs px-3 py-1 rounded-full ${m?'bg-amber-500/10 text-amber-400/60':'bg-fuchsia-500/10 text-fuchsia-400/60'} font-amiri">﴿${toArabicNum(a.numberInSurah)}﴾</span>
                        </div>
                    </div>`).join('');
            }
            const navLabel = document.getElementById('quranNavLabel');
            if (navLabel) navLabel.textContent = `${surah.name} (${currentSurahNum}/114)`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch { if (loading) loading.classList.add('hidden'); showToast('تعذّر تحميل السورة، تحقق من الإنترنت'); }
    };

    function toArabicNum(n) { return String(n).replace(/\d/g, d => '٠١٢٣٤٥٦٧٨٩'[d]); }

    window.changeFontSize = (delta) => {
        quranFontSize = Math.max(18, Math.min(40, quranFontSize + delta * 2));
        const el = document.getElementById('quranVerses');
        if (el) el.style.fontSize = quranFontSize + 'px';
    };
    window.nextSurah = () => { if (currentSurahNum < 114) { currentSurahNum++; const sel=document.getElementById('surahSelect'); if(sel){sel.value=currentSurahNum;window.loadSurah();} } };
    window.prevSurah = () => { if (currentSurahNum > 1) { currentSurahNum--; const sel=document.getElementById('surahSelect'); if(sel){sel.value=currentSurahNum;window.loadSurah();} } };

    window.copyDua = (el) => {
        const text = el.querySelector('p')?.textContent?.trim();
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => showToast('تم نسخ الدعاء ✨')).catch(() => showToast('الدعاء في قلبك 🤍'));
    };

    init();
</script>

<!-- NIGHT SKY SCRIPT -->
<script>
(function() {
    const canvas = document.getElementById('starCanvas');
    const ctx = canvas.getContext('2d');
    let stars = [];
    let W, H;

    function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        buildStars();
    }

    function buildStars() {
        stars = [];
        const count = Math.floor((W * H) / 4000);
        for (let i = 0; i < count; i++) {
            stars.push({
                x: Math.random() * W, y: Math.random() * H * 0.65,
                r: Math.random() * 1.4 + 0.3, a: Math.random(),
                da: (Math.random() * 0.008 + 0.002) * (Math.random() > 0.5 ? 1 : -1),
            });
        }
    }

    function draw() {
        ctx.clearRect(0, 0, W, H);
        const isFemale = document.body.classList.contains('theme-female');
        stars.forEach(s => {
            s.a += s.da;
            if (s.a > 1) { s.a = 1; s.da *= -1; }
            if (s.a < 0.05) { s.a = 0.05; s.da *= -1; }
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fillStyle = isFemale ? `rgba(240, 171, 252, ${s.a * 0.7})` : `rgba(255, 240, 200, ${s.a * 0.75})`;
            ctx.fill();
            if (s.r > 1.1) {
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.r * 3, 0, Math.PI * 2);
                const grd = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.r * 3);
                grd.addColorStop(0, isFemale ? `rgba(240,171,252,${s.a*0.15})` : `rgba(251,191,36,${s.a*0.15})`);
                grd.addColorStop(1, 'transparent');
                ctx.fillStyle = grd;
                ctx.fill();
            }
        });
        requestAnimationFrame(draw);
    }

    window.addEventListener('resize', resize);
    resize();
    draw();

    function spawnShootingStar() {
        const el = document.createElement('div');
        el.className = 'shooting-star';
        const startX = Math.random() * window.innerWidth * 0.7 + window.innerWidth * 0.2;
        const startY = Math.random() * window.innerHeight * 0.3 + 60;
        const duration = Math.random() * 1500 + 1000;
        el.style.cssText = `top:${startY}px;left:${startX}px;animation-duration:${duration}ms;`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), duration + 100);
    }
    function scheduleShoot() {
        setTimeout(() => { spawnShootingStar(); scheduleShoot(); }, Math.random() * 9000 + 6000);
    }
    scheduleShoot();
})();
</script>
</body>
</html>
